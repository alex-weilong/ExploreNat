<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Buscador de Especies</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #2c5e2e;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    button, select, input {
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #2c5e2e;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1e4320;
    }

    select, input {
      background-color: white;
      border: 1px solid #ccc;
    }

    input {
      cursor: text;
      min-width: 250px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 500px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .cita-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      transition: transform 0.2s;
    }

    .cita-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #2c5e2e;
    }

    .cita-info {
      flex: 1;
    }

    .cita-titulo {
      font-weight: bold;
      color: #2c5e2e;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .cita-detalle {
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .cita-enlace {
      color: #0066cc;
      font-size: 13px;
      text-decoration: none;
      display: inline-block;
      margin-top: 8px;
    }

    .cita-enlace:hover {
      text-decoration: underline;
    }

    .badge {
      background: #e9ecef;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      color: #495057;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2c5e2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-button.active {
      background: #2c5e2e;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>

<h1>ğŸŒ¿ ExploreNat - Buscador de Especies</h1>

<div class="controls">
  <button onclick="obtenerArea()">ğŸ“ Obtener coordenadas</button>
  <button onclick="limpiarMapa()">ğŸ—‘ï¸ Limpiar Ã¡rea</button>
  
  <label for="grupo">Filtrar por grupo:</label>
  <select id="grupo">
    <option value="">ğŸŒ Todos</option>
    <option value="212">ğŸ¦… Aves</option>
    <option value="359">ğŸ» MamÃ­feros</option>
    <option value="11418114">ğŸ¦ Tortugas</option>
     <option value="11592253">ğŸ¦ Lagartos y serpientes</option>
    <option value="131">ğŸ¸ Anfibios</option>
    <option value="203">ğŸŸ Peces Ã³seos</option>
    <option value="216">ğŸ¦‹ Insectos</option>
  </select>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>ğŸ“ Coordenadas del Ã¡rea:</h3>
<pre id="coords">Dibuja un rectÃ¡ngulo en el mapa y haz clic en "Obtener coordenadas"</pre>

<!-- PestaÃ±as -->
<div class="tab-buttons">
  <button id="tab1Btn" class="tab-button active" onclick="cambiarTab(1)">ğŸŒ Todas las especies</button>
  <button id="tab2Btn" class="tab-button" onclick="cambiarTab(2)">ğŸ” Buscar especie</button>
</div>

<!-- PestaÃ±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3>ğŸ“Š Especies encontradas en el Ã¡rea:</h3>
    <button onclick="consultarGBIF()" style="background-color: #2c5e2e;">ğŸ” Consultar especies</button>
  </div>
  <div id="resultados">
    <p style="color: #666; text-align: center; padding: 40px;">
      ğŸŒ Selecciona un Ã¡rea en el mapa y haz clic en "Consultar especies"
    </p>
  </div>
</div>

<!-- PestaÃ±a 2: Buscador de especie -->
<div id="tab2" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="buscadorEspecie" placeholder="Escribe el nombre de una especie (ej: Lynx pardinus)" style="flex: 1;">
      <button onclick="buscarEspecie()" style="background-color: #0066cc;">ğŸ” Buscar citas</button>
    </div>
    <div id="resultadosBusqueda">
      <p style="color: #666; text-align: center; padding: 20px;">
        ğŸ” Busca una especie para ver todas sus citas en el Ã¡rea seleccionada
      </p>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACIÃ“N DEL MAPA
  // ============================================
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Capa para el Ã¡rea dibujada
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Capa para los marcadores de citas
  var markersLayer = new L.FeatureGroup();
  map.addLayer(markersLayer);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
      polygon: false, 
      polyline: false, 
      circle: false, 
      marker: false, 
      circlemarker: false, 
      rectangle: true 
    }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rectÃ¡ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    document.getElementById("mensajeAyuda").style.display = "none";
    obtenerArea();
  });

  // ============================================
  // FUNCIÃ“N: Limpiar mapa
  // ============================================
  function limpiarMapa() {
    drawnItems.clearLayers();
    markersLayer.clearLayers();
    areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rectÃ¡ngulo en el mapa y haz clic en 'Obtener coordenadas'";
    document.getElementById("mensajeAyuda").style.display = "none";
  }

  // ============================================
  // FUNCIÃ“N: Cambiar pestaÃ±as
  // ============================================
  function cambiarTab(tabId) {
    // Actualizar botones
    document.getElementById('tab1Btn').classList.remove('active');
    document.getElementById('tab2Btn').classList.remove('active');
    document.getElementById(`tab${tabId}Btn`).classList.add('active');
    
    // Actualizar contenido
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCIÃ“N: Mostrar coordenadas
  // ============================================
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    document.getElementById("coords").innerHTML = 
      `ğŸ“ Norte: ${bounds.getNorth().toFixed(4)}Â°<br>` +
      `ğŸ“ Sur: ${bounds.getSouth().toFixed(4)}Â°<br>` +
      `ğŸ“ Este: ${bounds.getEast().toFixed(4)}Â°<br>` +
      `ğŸ“ Oeste: ${bounds.getWest().toFixed(4)}Â°<br>` +
      `ğŸ“ Ãrea aproximada: ${calcularAreaKm2(bounds).toFixed(0)} kmÂ²`;
  }

  // ============================================
  // FUNCIÃ“N: Calcular Ã¡rea aproximada
  // ============================================
  function calcularAreaKm2(bounds) {
    var R = 6371;
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    
    return ancho * alto;
  }

  // ============================================
  // FUNCIÃ“N: Consultar todas las especies (PestaÃ±a 1)
  // ============================================
  async function consultarGBIF() {
    document.getElementById("resultados").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando GBIF...</p>
      </div>
    `;

    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "âš ï¸ Por favor, dibuja un rectÃ¡ngulo en el mapa antes de consultar.";
      document.getElementById("mensajeAyuda").style.display = "block";
      document.getElementById("resultados").innerHTML = 
        '<p style="color: #856404; text-align: center;">ğŸ“ Dibuja un Ã¡rea en el mapa para comenzar</p>';
      return;
    }

    var bounds = areaSeleccionada;
    var claseSeleccionada = document.getElementById("grupo").value;

    try {
      var url = "https://api.gbif.org/v1/occurrence/search?" +
                "hasCoordinate=true" +
                "&hasGeospatialIssue=false" +
                "&limit=300" +
                "&kingdomKey=1";

      if (claseSeleccionada) {
        url += "&classKey=" + claseSeleccionada;
      }

      url += "&decimalLatitude=" + bounds.getSouth() + "," + bounds.getNorth() +
             "&decimalLongitude=" + bounds.getWest() + "," + bounds.getEast();

      var response = await fetch(url);
      var data = await response.json();

      var especiesMap = new Map();

      if (data.results && data.results.length > 0) {
        data.results.forEach(function(r) {
          if (r.species && r.species.trim() !== '') {
            if (!especiesMap.has(r.species)) {
              especiesMap.set(r.species, {
                nombre: r.species,
                nombreComun: r.vernacularName || "Nombre comÃºn no disponible",
                familia: r.family || "No disponible",
                orden: r.order || "No disponible",
                speciesKey: r.speciesKey || null,
                totalRegistros: 1
              });
            } else {
              let especie = especiesMap.get(r.species);
              especie.totalRegistros++;
            }
          }
        });
      }

      if (especiesMap.size === 0) {
        document.getElementById("resultados").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">ğŸ”</p>
            <h3 style="color: #856404;">No se encontraron especies</h3>
            <p>Prueba con un Ã¡rea mÃ¡s grande o cambia el filtro</p>
          </div>
        `;
        return;
      }

      // Mostrar resultados
      var especiesArray = Array.from(especiesMap.values());
      especiesArray.sort((a, b) => b.totalRegistros - a.totalRegistros);

      var html = `
        <div class="stats">
          ğŸ“Š Total especies: ${especiesMap.size}<br>
          ğŸ“ Total registros: ${data.count || data.results.length}<br>
          ğŸ”¬ Grupo: ${document.getElementById("grupo").selectedOptions[0].text || 'Todos'}
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      especiesArray.forEach(function(especie) {
        html += `<div class="cita-card">`;
        html += `<div class="cita-info">`;
        html += `<div class="cita-titulo">${especie.nombre}</div>`;
        html += `<div class="cita-comun">${especie.nombreComun}</div>`;
        html += `<div class="cita-detalle">`;
        html += `<span class="badge">ğŸ“Œ ${especie.familia}</span>`;
        html += `<span class="badge">ğŸ“Š ${especie.totalRegistros} registros</span>`;
        html += `</div>`;
        
        if (especie.speciesKey) {
          html += `<a class="cita-enlace" href="https://www.gbif.org/species/${especie.speciesKey}" target="_blank">ğŸ”— Ver en GBIF</a>`;
        }
        
        html += `</div>`; // Cierra cita-info
        html += `</div>`; // Cierra cita-card
      });

      html += `</div>`;
      document.getElementById("resultados").innerHTML = html;

    } catch (error) {
      console.error(error);
      document.getElementById("resultados").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          âŒ Error al consultar GBIF: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCIÃ“N: Buscar especie especÃ­fica (PestaÃ±a 2)
  // ============================================
  async function buscarEspecie() {
    var nombreEspecie = document.getElementById("buscadorEspecie").value.trim();
    
    if (!nombreEspecie) {
      alert("Por favor, escribe el nombre de una especie");
      return;
    }

    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "âš ï¸ Por favor, dibuja un rectÃ¡ngulo en el mapa antes de buscar.";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    // Limpiar marcadores anteriores
    markersLayer.clearLayers();

    document.getElementById("resultadosBusqueda").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando citas de "${nombreEspecie}"...</p>
      </div>
    `;

    var bounds = areaSeleccionada;

    try {
      // 1. Primero buscar el taxon para obtener el speciesKey
      var busquedaUrl = `https://api.gbif.org/v1/species/match?name=${encodeURIComponent(nombreEspecie)}`;
      var busquedaRes = await fetch(busquedaUrl);
      var busquedaData = await busquedaRes.json();
      
      var speciesKey = busquedaData.speciesKey || busquedaData.usageKey;
      var nombreCientifico = busquedaData.species || busquedaData.canonicalName || nombreEspecie;

      if (!speciesKey) {
        throw new Error("No se encontrÃ³ la especie en GBIF");
      }

      // 2. Buscar ocurrencias de esa especie en el Ã¡rea
      var url = `https://api.gbif.org/v1/occurrence/search?` +
                `taxonKey=${speciesKey}` +
                `&hasCoordinate=true` +
                `&hasGeospatialIssue=false` +
                `&limit=100` +
                `&decimalLatitude=${bounds.getSouth()},${bounds.getNorth()}` +
                `&decimalLongitude=${bounds.getWest()},${bounds.getEast()}`;

      var response = await fetch(url);
      var data = await response.json();

      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosBusqueda").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">ğŸ”</p>
            <h3 style="color: #856404;">No se encontraron citas</h3>
            <p style="color: #666;">
              No hay registros de <strong>${nombreCientifico}</strong> en el Ã¡rea seleccionada.<br>
              Prueba con otra especie o amplÃ­a el Ã¡rea de bÃºsqueda.
            </p>
          </div>
        `;
        return;
      }

      // 3. Mostrar resultados y aÃ±adir marcadores
      var html = `
        <div class="stats">
          ğŸ¯ Especie: <strong>${nombreCientifico}</strong><br>
          ğŸ“ Total citas en el Ã¡rea: ${data.count || data.results.length}<br>
          ğŸ“ Ãrea de bÃºsqueda: ${calcularAreaKm2(bounds).toFixed(0)} kmÂ²
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      // AÃ±adir marcadores al mapa
      data.results.forEach(function(cita, index) {
        if (cita.decimalLatitude && cita.decimalLongitude) {
          var marker = L.circleMarker([cita.decimalLatitude, cita.decimalLongitude], {
            radius: 6,
            color: '#2c5e2e',
            weight: 2,
            opacity: 1,
            fillColor: '#4caf50',
            fillOpacity: 0.7
          }).addTo(markersLayer);
          
          var popupContent = `
            <b>${cita.species || nombreCientifico}</b><br>
            ${cita.vernacularName ? `<i>${cita.vernacularName}</i><br>` : ''}
            ğŸ“… ${cita.eventDate ? new Date(cita.eventDate).toLocaleDateString() : 'Fecha desconocida'}<br>
            ğŸ“ ${cita.decimalLatitude.toFixed(4)}, ${cita.decimalLongitude.toFixed(4)}<br>
            <a href="https://www.gbif.org/occurrence/${cita.key}" target="_blank">ğŸ”— Ver en GBIF</a>
          `;
          
          marker.bindPopup(popupContent);
        }

        // AÃ±adir a la lista de resultados
        html += `<div class="cita-card">`;
        html += `<div class="cita-info">`;
        html += `<div class="cita-titulo">Cita #${index + 1}</div>`;
        html += `<div class="cita-detalle">`;
        
        if (cita.vernacularName) {
          html += `<span style="font-style: italic;">${cita.vernacularName}</span><br>`;
        }
        
        html += `ğŸ“ Coordenadas: ${cita.decimalLatitude?.toFixed(4)}, ${cita.decimalLongitude?.toFixed(4)}<br>`;
        html += `ğŸ“… Fecha: ${cita.eventDate ? new Date(cita.eventDate).toLocaleDateString() : 'No disponible'}<br>`;
        
        if (cita.locality) {
          html += `ğŸï¸ Localidad: ${cita.locality}<br>`;
        }
        
        if (cita.recordedBy) {
          html += `ğŸ‘¤ Observador: ${cita.recordedBy}<br>`;
        }
        
        html += `</div>`;
        html += `<a class="cita-enlace" href="https://www.gbif.org/occurrence/${cita.key}" target="_blank">ğŸ”— Ver detalle en GBIF</a>`;
        html += `</div>`; // Cierra cita-info
        html += `</div>`; // Cierra cita-card
      });

      html += `</div>`;
      document.getElementById("resultadosBusqueda").innerHTML = html;

      // Ajustar el mapa para mostrar todos los marcadores
      if (markersLayer.getLayers().length > 0) {
        map.fitBounds(markersLayer.getBounds().pad(0.1));
      }

    } catch (error) {
      console.error(error);
      document.getElementById("resultadosBusqueda").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24; background: #f8d7da; border-radius: 8px;">
          <p style="font-size: 48px; margin-bottom: 20px;">âŒ</p>
          <h3>Error al buscar la especie</h3>
          <p style="margin-top: 20px;">
            ${error.message}<br><br>
            Verifica que el nombre de la especie sea correcto.
          </p>
        </div>
      `;
    }
  }

  // Permitir buscar con Enter
  document.getElementById("buscadorEspecie")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      buscarEspecie();
    }
  });

  // ============================================
  // INICIALIZACIÃ“N
  // ============================================
  window.onload = function() {
    console.log("ExploreNat - Buscador de especies iniciado");
  };

</script>

</body>
</html>
