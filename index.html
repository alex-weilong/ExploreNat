<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - iNaturalist Explorer con L√≠mites Pol√≠ticos</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #4CAF50;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    button, select, input {
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #388E3C;
    }

    .button-blue {
      background-color: #2196F3;
    }
    .button-blue:hover {
      background-color: #1976D2;
    }

    select, input {
      background-color: white;
      border: 1px solid #ccc;
    }

    input {
      cursor: text;
      min-width: 250px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusqueda, #resultadosPais {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      transition: transform 0.2s;
    }

    .inat-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #4CAF50;
    }

    .inat-imagen {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 15px;
    }

    .inat-placeholder {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      margin-right: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 24px;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .inat-comun {
      color: #666;
      font-size: 14px;
      font-style: italic;
      margin-bottom: 8px;
    }

    .inat-detalle {
      color: #666;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .badge {
      background: #e8f5e9;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #2e7d32;
      display: inline-block;
    }

    .badge-quality-research {
      background: #c8e6c9;
      color: #1b5e20;
      font-weight: bold;
    }

    .badge-quality-casual {
      background: #ffccbc;
      color: #bf360c;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #1b5e20;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-button.active {
      background: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .pais-sugerencia {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      width: 300px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .pais-sugerencia-item {
      padding: 10px;
      cursor: pointer;
    }

    .pais-sugerencia-item:hover {
      background-color: #e8f5e9;
    }

    .place-option {
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #dee2e6;
      transition: all 0.2s;
    }

    .place-option:hover {
      background: #e8f5e9;
      border-color: #4CAF50;
      transform: translateX(5px);
    }
  </style>
</head>
<body>

<h1>üåø iNaturalist Explorer - L√≠mites Pol√≠ticos Reales</h1>

<div class="controls">
  <button onclick="obtenerArea()">üìç Obtener coordenadas</button>
  <button onclick="limpiarMapa()">üóëÔ∏è Limpiar √°rea</button>
  
  <label for="grupo">Filtrar por grupo:</label>
  <select id="grupo">
    <option value="">üåç Todos</option>
    <option value="Aves">ü¶Ö Aves</option>
    <option value="Mammalia">üêª Mam√≠feros</option>
    <option value="Reptilia">ü¶é Reptiles</option>
    <option value="Amphibia">üê∏ Anfibios</option>
    <option value="Actinopterygii">üêü Peces</option>
    <option value="Insecta">ü¶ã Insectos</option>
    <option value="Arachnida">üï∑Ô∏è Ar√°cnidos</option>
    <option value="Mollusca">üêå Moluscos</option>
    <option value="Plantae">üå± Plantas</option>
    <option value="Fungi">üçÑ Hongos</option>
  </select>

  <label style="margin-left: 10px;">
    <input type="checkbox" id="soloResearch" checked> Solo grado investigaci√≥n
  </label>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>üìê Coordenadas del √°rea:</h3>
<pre id="coords">Dibuja un rect√°ngulo en el mapa o busca un pa√≠s/ciudad</pre>

<!-- Pesta√±as -->
<div class="tab-buttons">
  <button id="tab1Btn" class="tab-button active" onclick="cambiarTab(1)">üåç Todas las especies</button>
  <button id="tab2Btn" class="tab-button" onclick="cambiarTab(2)">üîç Buscar especie</button>
  <button id="tab3Btn" class="tab-button" onclick="cambiarTab(3)">üó∫Ô∏è Buscar zona (pol√≠gonos reales)</button>
</div>

<!-- Pesta√±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3>üìä Especies en iNaturalist (√°rea dibujada):</h3>
    <button onclick="consultarINaturalist()">üîç Consultar especies</button>
  </div>
  <div id="resultados">
    <p style="color: #666; text-align: center; padding: 40px;">
      üåç Dibuja un √°rea en el mapa o busca un pa√≠s en la Pesta√±a 3
    </p>
  </div>
</div>

<!-- Pesta√±a 2: Buscador de especie -->
<div id="tab2" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="buscadorEspecie" placeholder="Ej: Lynx pardinus, Aquila adalberti, Vipera latastei" style="flex: 1;">
      <button onclick="buscarEspecieINat()" class="button-blue">üîç Buscar citas en el √°rea</button>
    </div>
    <div id="resultadosBusqueda">
      <p style="color: #666; text-align: center; padding: 20px;">
        üîç Busca una especie para ver todas sus observaciones en el √°rea seleccionada
      </p>
    </div>
  </div>
</div>

<!-- Pesta√±a 3: Buscador de pa√≠s/zona con pol√≠gonos reales -->
<div id="tab3" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center; position: relative;">
      <input type="text" id="buscadorPais" 
             placeholder="Ej: Espa√±a, Do√±ana, Amazonas, Madrid, Costa Rica" 
             style="flex: 1;"
             autocomplete="off">
      <button onclick="buscarZonaINat()" style="background-color: #8B4513;">üó∫Ô∏è Buscar con l√≠mites reales</button>
    </div>
    <div id="sugerenciasPais" style="position: relative;"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <select id="paisPreseleccionado" style="flex: 1;">
        <option value="">üåç Selecciona un pa√≠s r√°pido...</option>
        <option value="Espa√±a">Espa√±a</option>
        <option value="Portugal">Portugal</option>
        <option value="Francia">Francia</option>
        <option value="Italia">Italia</option>
        <option value="Costa Rica">Costa Rica üá®üá∑</option>
        <option value="Ecuador">Ecuador</option>
        <option value="Colombia">Colombia</option>
        <option value="Per√∫">Per√∫</option>
        <option value="Brasil">Brasil</option>
        <option value="M√©xico">M√©xico</option>
        <option value="Australia">Australia</option>
        <option value="Jap√≥n">Jap√≥n</option>
        <option value="Parque Nacional Do√±ana">Do√±ana</option>
        <option value="Parque Nacional Yasun√≠">Yasun√≠</option>
      </select>
      <button onclick="cargarPaisPreseleccionado()" style="background-color: #6B8E23;">üìå Cargar</button>
    </div>
    
    <div id="resultadosPais" style="margin-top: 20px;">
      <p style="color: #666; text-align: center; padding: 20px;">
        üó∫Ô∏è Busca un pa√≠s o zona para ver su biodiversidad con l√≠mites pol√≠ticos reales
      </p>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACI√ìN DEL MAPA
  // ============================================
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Capa para el √°rea dibujada
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Capa para los marcadores de observaciones
  var markersLayer = new L.FeatureGroup();
  map.addLayer(markersLayer);

  // Capa para la zona buscada (con pol√≠gonos)
  var zoneLayer = new L.FeatureGroup();
  map.addLayer(zoneLayer);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
      polygon: false, 
      polyline: false, 
      circle: false, 
      marker: false, 
      circlemarker: false, 
      rectangle: true 
    }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rect√°ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    document.getElementById("mensajeAyuda").style.display = "none";
    obtenerArea();
  });

  // ============================================
  // FUNCI√ìN: Limpiar mapa
  // ============================================
  function limpiarMapa() {
    drawnItems.clearLayers();
    markersLayer.clearLayers();
    zoneLayer.clearLayers();
    areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rect√°ngulo en el mapa o busca un pa√≠s/ciudad";
    document.getElementById("mensajeAyuda").style.display = "none";
  }

  // ============================================
  // FUNCI√ìN: Cambiar pesta√±as
  // ============================================
  function cambiarTab(tabId) {
    document.getElementById('tab1Btn').classList.remove('active');
    document.getElementById('tab2Btn').classList.remove('active');
    document.getElementById('tab3Btn').classList.remove('active');
    document.getElementById(`tab${tabId}Btn`).classList.add('active');
    
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById('tab3').classList.remove('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCI√ìN: Mostrar coordenadas
  // ============================================
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    document.getElementById("coords").innerHTML = 
      `üìç Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `üìç Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `üìç Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `üìç Oeste: ${bounds.getWest().toFixed(4)}¬∞<br>` +
      `üìè √Årea: ${calcularAreaKm2(bounds).toFixed(0)} km¬≤`;
  }

  // ============================================
  // FUNCI√ìN: Calcular √°rea
  // ============================================
  function calcularAreaKm2(bounds) {
    var R = 6371;
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    return ancho * alto;
  }

  // ============================================
  // FUNCI√ìN NUEVA: Buscar place_id en iNaturalist
  // ============================================
  async function buscarPlaceIdINaturalist(query) {
    try {
      // Buscar lugares en iNaturalist por nombre
      const url = `https://api.inaturalist.org/v1/places?q=${encodeURIComponent(query)}&per_page=10`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        return data.results.map(place => ({
          id: place.id,
          name: place.display_name,
          type: place.place_type_name,
          bbox: place.bounding_box_geojson ? 
                [place.bounding_box_geojson.coordinates[0][1], 
                 place.bounding_box_geojson.coordinates[0][0],
                 place.bounding_box_geojson.coordinates[2][1],
                 place.bounding_box_geojson.coordinates[2][0]] :
                [place.swlat, place.swlng, place.nelat, place.nelng],
          location: [place.latitude, place.longitude],
          admin_level: place.admin_level
        }));
      }
      return [];
    } catch (error) {
      console.error("Error buscando places:", error);
      return [];
    }
  }

  // ============================================
  // FUNCI√ìN: Geocodificar con Nominatim (fallback)
  // ============================================
  async function geocodificarLugar(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&polygon_geojson=1`;
    try {
      const response = await fetch(url, { headers: { 'User-Agent': 'iNatExplorer/1.0' } });
      const data = await response.json();
      if (data && data.length > 0) {
        const lugar = data[0];
        let bounds = null;
        if (lugar.boundingbox) {
          bounds = L.latLngBounds(
            [parseFloat(lugar.boundingbox[0]), parseFloat(lugar.boundingbox[2])],
            [parseFloat(lugar.boundingbox[1]), parseFloat(lugar.boundingbox[3])]
          );
        }
        return {
          nombre: lugar.display_name,
          bounds: bounds,
          lat: parseFloat(lugar.lat),
          lon: parseFloat(lugar.lon),
          tipo: lugar.type
        };
      }
      return null;
    } catch (error) {
      console.error('Error geocodificando:', error);
      return null;
    }
  }

  // ============================================
  // FUNCI√ìN PRINCIPAL: Buscar zona con place_id
  // ============================================
  async function buscarZonaINat() {
    var query = document.getElementById("buscadorPais").value.trim();
    
    if (!query) {
      alert("Escribe el nombre de un pa√≠s o zona");
      return;
    }

    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando "${query}" en iNaturalist...</p>
      </div>
    `;

    zoneLayer.clearLayers();
    drawnItems.clearLayers();
    markersLayer.clearLayers();

    try {
      // 1. BUSCAR PRIMERO EN iNaturalist places
      const places = await buscarPlaceIdINaturalist(query);
      
      let lugar;
      let bounds;
      
      if (places.length > 0) {
        // Si hay m√∫ltiples places, mostrar selector
        if (places.length > 1) {
          mostrarSelectorPlaces(places);
          return;
        }
        
        // Usar el primer resultado
        const place = places[0];
        lugar = {
          nombre: place.name,
          place_id: place.id,
          lat: place.location[0],
          lon: place.location[1],
          tipo: place.type,
          admin_level: place.admin_level
        };
        
        // Crear bounds desde el bbox
        bounds = L.latLngBounds(
          [place.bbox[0], place.bbox[1]],
          [place.bbox[2], place.bbox[3]]
        );
        
        document.getElementById("mensajeAyuda").innerHTML = `
          ‚úÖ Usando l√≠mites pol√≠ticos de iNaturalist: ${place.name}<br>
          <small>Place ID: ${place.id} | Tipo: ${place.type} | Nivel admin: ${place.admin_level || 'N/A'}</small>
        `;
        document.getElementById("mensajeAyuda").className = "success";
      } else {
        // Fallback a OpenStreetMap
        document.getElementById("mensajeAyuda").innerHTML = `
          ‚ö†Ô∏è No se encontr√≥ en iNaturalist, usando OpenStreetMap<br>
          <small>(l√≠mites aproximados, no pol√≠ticos)</small>
        `;
        document.getElementById("mensajeAyuda").className = "warning";
        
        const osmLugar = await geocodificarLugar(query);
        if (!osmLugar) throw new Error("No se encontr√≥ el lugar");
        lugar = osmLugar;
        bounds = lugar.bounds;
      }
      
      document.getElementById("mensajeAyuda").style.display = "block";
      
      // Dibujar en el mapa
      areaSeleccionada = bounds;
      
      // Rect√°ngulo con estilo seg√∫n fuente
      L.rectangle(bounds, {
        color: lugar.place_id ? "#4CAF50" : "#8B4513",
        weight: 3,
        fillColor: lugar.place_id ? "#4CAF50" : "#8B4513",
        fillOpacity: 0.05,
        dashArray: lugar.place_id ? null : "5, 5"
      }).addTo(zoneLayer);
      
      // Marcador en el centro
      L.marker([lugar.lat, lugar.lon], {
        icon: L.divIcon({ 
          html: lugar.place_id ? 'üìç' : '‚ö†Ô∏è', 
          iconSize: [30, 30],
          className: 'custom-div-icon'
        })
      }).bindPopup(`
        <b>${lugar.nombre}</b><br>
        ${lugar.place_id ? `Place ID: ${lugar.place_id}<br>` : ''}
        Tipo: ${lugar.tipo || 'Desconocido'}<br>
        ${lugar.admin_level ? `Nivel admin: ${lugar.admin_level}` : ''}
      `).addTo(zoneLayer);
      
      map.fitBounds(bounds.pad(0.1));
      
      document.getElementById("coords").innerHTML = 
        `üìç Zona: ${lugar.nombre}<br>` +
        