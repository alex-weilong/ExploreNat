<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Explorador de Biodiversidad</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f0f7f0;
    }

    h1 {
      color: #2c5e2e;
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.5em;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 3px solid #4CAF50;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }

    button, select, input {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
    }

    button:hover {
      background-color: #388E3C;
    }

    .button-blue {
      background-color: #2196F3;
    }

    select, input {
      background-color: white;
      border: 2px solid #e0e0e0;
    }

    input {
      cursor: text;
      min-width: 300px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusqueda, #resultadosPais {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border: 1px solid #eaeaea;
    }

    .inat-imagen {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      margin-right: 15px;
      border: 2px solid #4CAF50;
    }

    .inat-placeholder {
      width: 80px;
      height: 80px;
      background: #e8f5e9;
      margin-right: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 30px;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
    }

    .badge {
      background: #e8f5e9;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #2e7d32;
      display: inline-block;
    }

    .loading {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #1b5e20;
    }

    .tab-button {
      background: #e9ecef;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      display: inline-block;
    }

    .tab-button.active {
      background: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>

<h1>üåø ExploreNat</h1>

<div class="controls">
  <button onclick="obtenerArea()">üìç Obtener coordenadas</button>
  <button onclick="limpiarMapa()">üóëÔ∏è Limpiar √°rea</button>
  
  <select id="grupo">
    <option value="">üåç Todos</option>
    <option value="Aves">ü¶Ö Aves</option>
    <option value="Mammalia">üêª Mam√≠feros</option>
    <option value="Reptilia">ü¶é Reptiles</option>
    <option value="Amphibia">üê∏ Anfibios</option>
    <option value="Insecta">ü¶ã Insectos</option>
    <option value="Plantae">üå± Plantas</option>
  </select>

  <label>
    <input type="checkbox" id="soloResearch" checked> Solo grado investigaci√≥n
  </label>
</div>

<div id="map"></div>

<div id="mensajeAyuda" style="display: none;" class="warning"></div>

<h3>üìê Coordenadas del √°rea:</h3>
<pre id="coords">Dibuja un rect√°ngulo en el mapa</pre>

<!-- Pesta√±as visibles -->
<div style="margin: 20px 0;">
  <span class="tab-button active" onclick="cambiarTab(1)">üåç Especies</span>
  <span class="tab-button" onclick="cambiarTab(2)">üîç Buscar especie</span>
  <span class="tab-button" onclick="cambiarTab(3)">üó∫Ô∏è Buscar zona</span>
</div>

<!-- Pesta√±a 1 -->
<div id="tab1" class="tab-content active">
  <button onclick="consultarINaturalist()">üîç Consultar especies</button>
  <div id="resultados" style="margin-top: 15px;"></div>
</div>

<!-- Pesta√±a 2 -->
<div id="tab2" class="tab-content">
  <input type="text" id="buscadorEspecie" placeholder="Ej: Lynx pardinus" style="width: 300px;">
  <button onclick="buscarEspecieINat()" class="button-blue">Buscar</button>
  <div id="resultadosBusqueda" style="margin-top: 15px;"></div>
</div>

<!-- Pesta√±a 3 -->
<div id="tab3" class="tab-content">
  <input type="text" id="buscadorPais" placeholder="Ej: Espa√±a" style="width: 300px;">
  <button onclick="buscarZonaINat()">Buscar zona</button>
  <div id="resultadosPais" style="margin-top: 15px;"></div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // VARIABLES GLOBALES
  // ============================================
  let map;
  let drawnItems;
  let markersLayer;
  let zoneLayer;
  let areaSeleccionada = null;

  // ============================================
  // INICIALIZACI√ìN DEL MAPA (SEGURA)
  // ============================================
  window.onload = function() {
    console.log("Iniciando ExploreNat...");
    
    // Crear mapa
    map = L.map('map').setView([40.4168, -3.7038], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Capas
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    markersLayer = new L.FeatureGroup();
    map.addLayer(markersLayer);

    zoneLayer = new L.FeatureGroup();
    map.addLayer(zoneLayer);

    // Control de dibujo
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: false, polyline: false, circle: false, marker: false, rectangle: true }
    });
    map.addControl(drawControl);

    // Evento al dibujar
    map.on(L.Draw.Event.CREATED, function(e) {
      var layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      areaSeleccionada = layer.getBounds();
      document.getElementById("mensajeAyuda").style.display = "none";
      obtenerArea();
    });

    console.log("‚úÖ Mapa cargado correctamente");
  };

  // ============================================
  // FUNCIONES B√ÅSICAS
  // ============================================
  
  function obtenerArea() {
    if (!areaSeleccionada) {
      document.getElementById("coords").innerHTML = "Dibuja un √°rea primero";
      return;
    }
    var bounds = areaSeleccionada;
    document.getElementById("coords").innerHTML = 
      `Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `Oeste: ${bounds.getWest().toFixed(4)}¬∞`;
  }

  function limpiarMapa() {
    if (drawnItems) drawnItems.clearLayers();
    if (markersLayer) markersLayer.clearLayers();
    if (zoneLayer) zoneLayer.clearLayers();
    areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rect√°ngulo en el mapa";
  }

  function cambiarTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCIONES DE iNaturalist
  // ============================================
  
  async function consultarINaturalist() {
    if (!areaSeleccionada) {
      alert("Primero dibuja un √°rea en el mapa");
      return;
    }

    document.getElementById("resultados").innerHTML = '<div class="loading"></div> Cargando...';

    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;

    try {
      const url = `https://api.inaturalist.org/v1/observations/species_counts?` +
                  `verifiable=${soloResearch}` +
                  `&per_page=30` +
                  `&swlat=${bounds.getSouth()}` +
                  `&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}` +
                  `&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) {
        document.getElementById("resultados").innerHTML = "No se encontraron especies";
        return;
      }

      let html = `<div class="stats">Especies: ${data.total_results}</div>`;

      data.results.forEach(item => {
        const taxon = item.taxon;
        html += `<div class="inat-card">`;
        html += `<div class="inat-placeholder">üì∑</div>`;
        html += `<div class="inat-info">`;
        html += `<div class="inat-titulo">${taxon.name}</div>`;
        html += `<div>${taxon.preferred_common_name || ''}</div>`;
        html += `<span class="badge">üìä ${item.count} obs</span>`;
        html += `</div></div>`;
      });

      document.getElementById("resultados").innerHTML = html;

    } catch (error) {
      document.getElementById("resultados").innerHTML = `Error: ${error.message}`;
    }
  }

  async function buscarEspecieINat() {
    const nombre = document.getElementById("buscadorEspecie").value.trim();
    if (!nombre) return alert("Escribe un nombre");
    if (!areaSeleccionada) return alert("Dibuja un √°rea primero");

    markersLayer.clearLayers();
    document.getElementById("resultadosBusqueda").innerHTML = '<div class="loading"></div> Buscando...';

    const bounds = areaSeleccionada;

    try {
      // Buscar tax√≥n
      const taxonRes = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(nombre)}&per_page=1`);
      const taxonData = await taxonRes.json();
      
      if (!taxonData.results?.length) {
        document.getElementById("resultadosBusqueda").innerHTML = "Especie no encontrada";
        return;
      }

      const taxon = taxonData.results[0];

      // Buscar observaciones
      const url = `https://api.inaturalist.org/v1/observations?` +
                  `taxon_id=${taxon.id}` +
                  `&verifiable=true` +
                  `&per_page=30` +
                  `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;

      const obsRes = await fetch(url);
      const obsData = await obsRes.json();

      if (!obsData.results?.length) {
        document.getElementById("resultadosBusqueda").innerHTML = "No hay observaciones";
        return;
      }

      let html = `<div class="stats">${obsData.total_results} observaciones</div>`;

      obsData.results.forEach(obs => {
        if (obs.geojson?.coordinates) {
          const [lng, lat] = obs.geojson.coordinates;
          L.circleMarker([lat, lng], { radius: 6, color: '#4CAF50' }).addTo(markersLayer);
        }

        html += `<div class="inat-card">`;
        html += `<div class="inat-placeholder">üì∑</div>`;
        html += `<div class="inat-info">`;
        html += `<div>üìÖ ${obs.observed_on || 'Fecha desconocida'}</div>`;
        html += `<div>üë§ ${obs.user?.login || 'An√≥nimo'}</div>`;
        html += `</div></div>`;
      });

      document.getElementById("resultadosBusqueda").innerHTML = html;
      
      if (markersLayer.getLayers().length > 0) {
        map.fitBounds(markersLayer.getBounds().pad(0.1));
      }

    } catch (error) {
      document.getElementById("resultadosBusqueda").innerHTML = `Error: ${error.message}`;
    }
  }

  async function buscarZonaINat() {
    const query = document.getElementById("buscadorPais").value.trim();
    if (!query) return alert("Escribe un lugar");

    document.getElementById("resultadosPais").innerHTML = '<div class="loading"></div> Buscando...';

    try {
      // Geocodificar con Nominatim
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
      const geoData = await geoRes.json();
      
      if (!geoData.length) {
        document.getElementById("resultadosPais").innerHTML = "Lugar no encontrado";
        return;
      }

      const lugar = geoData[0];
      const bounds = L.latLngBounds(
        [parseFloat(lugar.boundingbox[0]), parseFloat(lugar.boundingbox[2])],
        [parseFloat(lugar.boundingbox[1]), parseFloat(lugar.boundingbox[3])]
      );

      zoneLayer.clearLayers();
      L.rectangle(bounds, { color: "#4CAF50", weight: 3 }).addTo(zoneLayer);
      L.marker([parseFloat(lugar.lat), parseFloat(lugar.lon)]).addTo(zoneLayer);
      
      map.fitBounds(bounds.pad(0.1));
      areaSeleccionada = bounds;
      
      document.getElementById("coords").innerHTML = 
        `üìç ${lugar.display_name}<br>` +
        `Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
        `Sur: ${bounds.getSouth().toFixed(4)}¬∞`;

      // Consultar especies autom√°ticamente
      await consultarINaturalist();

    } catch (error) {
      document.getElementById("resultadosPais").innerHTML = `Error: ${error.message}`;
    }
  }

  // Enter para b√∫squedas
  document.getElementById("buscadorEspecie")?.addEventListener("keypress", e => {
    if (e.key === "Enter") buscarEspecieINat();
  });

  document.getElementById("buscadorPais")?.addEventListener("keypress", e => {
    if (e.key === "Enter") buscarZonaINat();
  });

</script>

</body>
</html>