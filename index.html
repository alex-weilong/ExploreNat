<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Buscador de Pa√≠ses y Especies</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #2c5e2e;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    button, select, input {
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #2c5e2e;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1e4320;
    }

    .button-blue {
      background-color: #0066cc;
    }
    .button-blue:hover {
      background-color: #004c99;
    }

    select, input {
      background-color: white;
      border: 1px solid #ccc;
    }

    input {
      cursor: text;
      min-width: 250px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusqueda, #resultadosPais {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 500px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .cita-card, .especie-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      transition: transform 0.2s;
    }

    .cita-card:hover, .especie-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #2c5e2e;
    }

    .cita-info, .especie-info {
      flex: 1;
    }

    .cita-titulo, .especie-nombre {
      font-weight: bold;
      color: #2c5e2e;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .cita-detalle {
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .badge {
      background: #e9ecef;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      color: #495057;
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 4px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2c5e2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
    }

    .tab-button.active {
      background: #2c5e2e;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .pais-sugerencia {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      width: 300px;
      z-index: 1000;
    }

    .pais-sugerencia-item {
      padding: 10px;
      cursor: pointer;
    }

    .pais-sugerencia-item:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<h1>üåç ExploreNat - Buscador de Biodiversidad por Pa√≠s</h1>

<div class="controls">
  <button onclick="obtenerArea()">üìç Obtener coordenadas</button>
  <button onclick="limpiarMapa()">üóëÔ∏è Limpiar √°rea</button>
  
  <label for="grupo">Filtrar por grupo:</label>
  <select id="grupo">
    <option value="">üåç Todos</option>
    <option value="212">ü¶Ö Aves</option>
    <option value="359">üêª Mam√≠feros</option>
    <option value="358">ü¶é Reptiles</option>
    <option value="131">üê∏ Anfibios</option>
    <option value="203">üêü Peces √≥seos</option>
    <option value="216">ü¶ã Insectos</option>
  </select>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>üìê Coordenadas del √°rea:</h3>
<pre id="coords">Dibuja un rect√°ngulo en el mapa o busca un pa√≠s/ciudad</pre>

<!-- Pesta√±as -->
<div class="tab-buttons">
  <button id="tab1Btn" class="tab-button active" onclick="cambiarTab(1)">üåç Todas las especies</button>
  <button id="tab2Btn" class="tab-button" onclick="cambiarTab(2)">üîç Buscar especie</button>
  <button id="tab3Btn" class="tab-button" onclick="cambiarTab(3)">üó∫Ô∏è Buscar pa√≠s/zona</button>
</div>

<!-- Pesta√±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3>üìä Especies en el √°rea dibujada:</h3>
    <button onclick="consultarGBIF()">üîç Consultar especies</button>
  </div>
  <div id="resultados">
    <p style="color: #666; text-align: center; padding: 40px;">
      üåç Dibuja un √°rea en el mapa o busca un pa√≠s en la Pesta√±a 3
    </p>
  </div>
</div>

<!-- Pesta√±a 2: Buscador de especie -->
<div id="tab2" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="buscadorEspecie" placeholder="Ej: Lynx pardinus, Aquila adalberti, Vipera latastei" style="flex: 1;">
      <button onclick="buscarEspecie()" class="button-blue">üîç Buscar citas en el √°rea</button>
    </div>
    <div id="resultadosBusqueda">
      <p style="color: #666; text-align: center; padding: 20px;">
        üîç Busca una especie para ver todas sus citas en el √°rea seleccionada
      </p>
    </div>
  </div>
</div>

<!-- Pesta√±a 3: Buscador de pa√≠s/zona -->
<div id="tab3" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center; position: relative;">
      <input type="text" id="buscadorPais" 
             placeholder="Ej: Espa√±a, Portugal, Amazonas, Parque Nacional Do√±ana, Madrid" 
             style="flex: 1;"
             autocomplete="off">
      <button onclick="buscarPais()" style="background-color: #8B4513;">üó∫Ô∏è Buscar zona</button>
    </div>
    <div id="sugerenciasPais" style="position: relative;"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <select id="paisPreseleccionado" style="flex: 1;">
        <option value="">üåç Selecciona un pa√≠s r√°pido...</option>
        <option value="ES">Espa√±a</option>
        <option value="PT">Portugal</option>
        <option value="FR">Francia</option>
        <option value="IT">Italia</option>
        <option value="DE">Alemania</option>
        <option value="GB">Reino Unido</option>
        <option value="US">Estados Unidos</option>
        <option value="MX">M√©xico</option>
        <option value="AR">Argentina</option>
        <option value="BR">Brasil</option>
        <option value="CR">Costa Rica</option>
        <option value="CO">Colombia</option>
        <option value="EC">Ecuador</option>
        <option value="PE">Per√∫</option>
        <option value="AU">Australia</option>
        <option value="JP">Jap√≥n</option>
        <option value="CN">China</option>
        <option value="ZA">Sud√°frica</option>
        <option value="MA">Marruecos</option>
      </select>
      <button onclick="cargarPaisPreseleccionado()" style="background-color: #6B8E23;">üìå Cargar pa√≠s</button>
    </div>
    
    <div id="resultadosPais" style="margin-top: 20px;">
      <p style="color: #666; text-align: center; padding: 20px;">
        üó∫Ô∏è Busca un pa√≠s o zona para ver su biodiversidad
      </p>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACI√ìN DEL MAPA
  // ============================================
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Capa para el √°rea dibujada
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Capa para los marcadores de citas
  var markersLayer = new L.FeatureGroup();
  map.addLayer(markersLayer);

  // Capa para el pa√≠s/zona buscado
  var countryLayer = new L.FeatureGroup();
  map.addLayer(countryLayer);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
      polygon: false, 
      polyline: false, 
      circle: false, 
      marker: false, 
      circlemarker: false, 
      rectangle: true 
    }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rect√°ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    document.getElementById("mensajeAyuda").style.display = "none";
    obtenerArea();
  });

  // ============================================
  // FUNCI√ìN: Limpiar mapa
  // ============================================
  function limpiarMapa() {
    drawnItems.clearLayers();
    markersLayer.clearLayers();
    countryLayer.clearLayers();
    areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rect√°ngulo en el mapa o busca un pa√≠s/ciudad";
    document.getElementById("mensajeAyuda").style.display = "none";
  }

  // ============================================
  // FUNCI√ìN: Cambiar pesta√±as
  // ============================================
  function cambiarTab(tabId) {
    document.getElementById('tab1Btn').classList.remove('active');
    document.getElementById('tab2Btn').classList.remove('active');
    document.getElementById('tab3Btn').classList.remove('active');
    document.getElementById(`tab${tabId}Btn`).classList.add('active');
    
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById('tab3').classList.remove('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCI√ìN: Mostrar coordenadas
  // ============================================
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    document.getElementById("coords").innerHTML = 
      `üìç Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `üìç Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `üìç Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `üìç Oeste: ${bounds.getWest().toFixed(4)}¬∞<br>` +
      `üìè √Årea aproximada: ${calcularAreaKm2(bounds).toFixed(0)} km¬≤`;
  }

  // ============================================
  // FUNCI√ìN: Calcular √°rea aproximada
  // ============================================
  function calcularAreaKm2(bounds) {
    var R = 6371;
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    
    return ancho * alto;
  }

  // ============================================
  // FUNCI√ìN: Geocodificar con Nominatim
  // ============================================
  async function geocodificarLugar(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&polygon_geojson=1&addressdetails=1`;
    
    try {
      const response = await fetch(url, {
        headers: {
          'User-Agent': 'ExploreNat-BiodiversityApp/1.0'
        }
      });
      const data = await response.json();
      
      if (data && data.length > 0) {
        const lugar = data[0];
        
        let bounds = null;
        if (lugar.boundingbox) {
          bounds = L.latLngBounds(
            [parseFloat(lugar.boundingbox[0]), parseFloat(lugar.boundingbox[2])],
            [parseFloat(lugar.boundingbox[1]), parseFloat(lugar.boundingbox[3])]
          );
        } else {
          const lat = parseFloat(lugar.lat);
          const lon = parseFloat(lugar.lon);
          bounds = L.latLngBounds([lat-0.5, lon-0.5], [lat+0.5, lon+0.5]);
        }
        
        return {
          nombre: lugar.display_name,
          bounds: bounds,
          lat: parseFloat(lugar.lat),
          lon: parseFloat(lugar.lon),
          tipo: lugar.type,
          importancia: lugar.importance,
          pais: lugar.address?.country,
          codigoPais: lugar.address?.country_code?.toUpperCase()
        };
      }
      return null;
    } catch (error) {
      console.error('Error en geocodificaci√≥n:', error);
      return null;
    }
  }

  // ============================================
  // FUNCI√ìN: Buscar pa√≠s/zona (Pesta√±a 3)
  // ============================================
  async function buscarPais() {
    var query = document.getElementById("buscadorPais").value.trim();
    
    if (!query) {
      alert("Por favor, escribe el nombre de un pa√≠s, ciudad o zona");
      return;
    }

    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando "${query}" en OpenStreetMap...</p>
      </div>
    `;

    // Limpiar capas anteriores
    countryLayer.clearLayers();
    drawnItems.clearLayers();
    markersLayer.clearLayers();

    try {
      // 1. Geocodificar el lugar
      const lugar = await geocodificarLugar(query);
      
      if (!lugar) {
        document.getElementById("resultadosPais").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">üîç</p>
            <h3 style="color: #856404;">No se encontr√≥ el lugar</h3>
            <p style="color: #666;">
              No pudimos encontrar "${query}".<br>
              Prueba con otro nombre o s√© m√°s espec√≠fico.
            </p>
          </div>
        `;
        return;
      }

      // 2. Dibujar el √°rea en el mapa
      areaSeleccionada = lugar.bounds;
      
      // Dibujar rect√°ngulo del pa√≠s
      L.rectangle(lugar.bounds, {
        color: "#8B4513",
        weight: 3,
        opacity: 0.8,
        fillColor: "#8B4513",
        fillOpacity: 0.1,
        dashArray: "5, 5"
      }).addTo(countryLayer);
      
      // A√±adir marcador en el centro
      L.marker([lugar.lat, lugar.lon], {
        icon: L.divIcon({
          html: 'üìç',
          className: 'custom-div-icon',
          iconSize: [30, 30],
          popupAnchor: [0, -15]
        })
      }).bindPopup(`
        <b>${lugar.nombre}</b><br>
        Tipo: ${lugar.tipo}<br>
        Pa√≠s: ${lugar.pais || 'No especificado'}<br>
        C√≥digo ISO: ${lugar.codigoPais || 'No disponible'}
      `).addTo(countryLayer);
      
      // Centrar mapa
      map.fitBounds(lugar.bounds.pad(0.1));
      
      // 3. Mostrar informaci√≥n y consultar GBIF
      document.getElementById("coords").innerHTML = 
        `üìç Zona: ${lugar.nombre}<br>` +
        `üìç Tipo: ${lugar.tipo}<br>` +
        `üìç Pa√≠s: ${lugar.pais || 'No especificado'}<br>` +
        `üìç C√≥digo ISO: ${lugar.codigoPais || 'No disponible'}<br>` +
        `üìè √Årea: ${calcularAreaKm2(lugar.bounds).toFixed(0)} km¬≤`;
      
      document.getElementById("mensajeAyuda").innerHTML = `
        ‚úÖ Zona cargada correctamente: ${lugar.nombre}
      `;
      document.getElementById("mensajeAyuda").className = "success";
      document.getElementById("mensajeAyuda").style.display = "block";
      
      // 4. Consultar especies del pa√≠s
      await consultarEspeciesPorPais(lugar);
      
    } catch (error) {
      console.error(error);
      document.getElementById("resultadosPais").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          ‚ùå Error al buscar el lugar: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCI√ìN: Consultar especies por pa√≠s
  // ============================================
  async function consultarEspeciesPorPais(lugar) {
    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando biodiversidad de ${lugar.nombre}...</p>
      </div>
    `;

    var claseSeleccionada = document.getElementById("grupo").value;
    var bounds = lugar.bounds;

    try {
      // Construir URL con l√≠mite alto
      var url = "https://api.gbif.org/v1/occurrence/search?" +
                "hasCoordinate=true" +
                "&hasGeospatialIssue=false" +
                "&limit=300" +
                "&kingdomKey=1";

      if (claseSeleccionada) {
        url += "&classKey=" + claseSeleccionada;
      }

      // Si tenemos c√≥digo ISO, usarlo (m√°s eficiente)
      if (lugar.codigoPais) {
        url += "&country=" + lugar.codigoPais;
      } else {
        url += "&decimalLatitude=" + bounds.getSouth() + "," + bounds.getNorth() +
               "&decimalLongitude=" + bounds.getWest() + "," + bounds.getEast();
      }

      console.log("Consultando GBIF para pa√≠s:", url);
      
      var response = await fetch(url);
      var data = await response.json();

      // Procesar especies
      var especiesMap = new Map();
      var totalRegistros = data.count || data.results.length;

      if (data.results && data.results.length > 0) {
        data.results.forEach(function(r) {
          if (r.species && r.species.trim() !== '') {
            if (!especiesMap.has(r.species)) {
              especiesMap.set(r.species, {
                nombre: r.species,
                nombreComun: r.vernacularName || "Nombre com√∫n no disponible",
                familia: r.family || "No disponible",
                orden: r.order || "No disponible",
                clase: r.class || "No disponible",
                speciesKey: r.speciesKey || null,
                totalRegistros: 1
              });
            } else {
              let especie = especiesMap.get(r.species);
              especie.totalRegistros++;
            }
          }
        });
      }

      // Mostrar resultados
      if (especiesMap.size === 0) {
        document.getElementById("resultadosPais").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">üîç</p>
            <h3 style="color: #856404;">No se encontraron especies</h3>
            <p style="color: #666;">
              No hay registros de ${claseSeleccionada ? 'este grupo' : 'animales'} en ${lugar.nombre}.<br>
              Prueba con otro grupo taxon√≥mico o zona.
            </p>
          </div>
        `;
        return;
      }

      var especiesArray = Array.from(especiesMap.values());
      especiesArray.sort((a, b) => b.totalRegistros - a.totalRegistros);
      
      var topEspecies = especiesArray.slice(0, 50);

      var html = `
        <div class="stats">
          üó∫Ô∏è <strong>${lugar.nombre}</strong><br>
          üìä Total especies: ${especiesMap.size}<br>
          üìù Total registros: ${totalRegistros}<br>
          üî¨ Grupo: ${document.getElementById("grupo").selectedOptions[0].text || 'Todos'}<br>
          ‚≠ê Mostrando las ${topEspecies.length} especies m√°s comunes
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      topEspecies.forEach(function(especie) {
        html += `<div class="cita-card">`;
        html += `<div class="cita-info">`;
        html += `<div class="cita-titulo">${especie.nombre}</div>`;
        html += `<div style="color: #666; margin-bottom: 8px;"><i>${especie.nombreComun}</i></div>`;
        html += `<div class="cita-detalle">`;
        html += `<span class="badge">üìå ${especie.familia}</span>`;
        html += `<span class="badge">üî¨ ${especie.clase}</span>`;
        html += `<span class="badge">üìä ${especie.totalRegistros} registros</span>`;
        html += `</div>`;
        
        if (especie.speciesKey) {
          html += `<a class="cita-enlace" href="https://www.gbif.org/species/${especie.speciesKey}" target="_blank" style="color: #0066cc; font-size: 13px; text-decoration: none; margin-top: 8px; display: inline-block;">üîó Ver en GBIF</a>`;
        }
        
        html += `</div>`; // Cierra cita-info
        html += `</div>`; // Cierra cita-card
      });

      html += `</div>`;
      
      // A√±adir advertencia si hay muchas especies
      if (especiesMap.size > 50) {
        html += `<div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px; margin-top: 15px;">
          <p style="color: #856404; margin: 0;">
            ‚ö†Ô∏è Mostrando 50 de ${especiesMap.size} especies<br>
            <small>${especiesMap.size - 50} especies no se muestran por rendimiento</small>
          </p>
        </div>`;
      }
      
      document.getElementById("resultadosPais").innerHTML = html;
      
      // Tambi√©n actualizar la pesta√±a 1 con estos resultados
      document.getElementById("resultados").innerHTML = html;
      
    } catch (error) {
      console.error(error);
      document.getElementById("resultadosPais").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          ‚ùå Error al consultar GBIF: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCI√ìN: Cargar pa√≠s preseleccionado
  // ============================================
  async function cargarPaisPreseleccionado() {
    var codigoPais = document.getElementById("paisPreseleccionado").value;
    if (!codigoPais) {
      alert("Selecciona un pa√≠s");
      return;
    }
    
    // Mapa de c√≥digos a nombres
    var nombresPais = {
      'ES': 'Espa√±a', 'PT': 'Portugal', 'FR': 'Francia', 'IT': 'Italia',
      'DE': 'Alemania', 'GB': 'Reino Unido', 'US': 'Estados Unidos',
      'MX': 'M√©xico', 'AR': 'Argentina', 'BR': 'Brasil', 'CR': 'Costa Rica',
      'CO': 'Colombia', 'EC': 'Ecuador', 'PE': 'Per√∫', 'AU': 'Australia',
      'JP': 'Jap√≥n', 'CN': 'China', 'ZA': 'Sud√°frica', 'MA': 'Marruecos'
    };
    
    document.getElementById("buscadorPais").value = nombresPais[codigoPais];
    await buscarPais();
  }

  // ============================================
  // FUNCI√ìN: Buscar especie (Pesta√±a 2)
  // ============================================
  async function buscarEspecie() {
    var nombreEspecie = document.getElementById("buscadorEspecie").value.trim();
    
    if (!nombreEspecie) {
      alert("Por favor, escribe el nombre de una especie");
      return;
    }

    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "‚ö†Ô∏è Primero dibuja un √°rea en el mapa O busca un pa√≠s en la Pesta√±a 3";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    markersLayer.clearLayers();

    document.getElementById("resultadosBusqueda").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando citas de "${nombreEspecie}"...</p>
      </div>
    `;

    var bounds = areaSeleccionada;

    try {
      // Buscar taxon
      var busquedaUrl = `https://api.gbif.org/v1/species/match?name=${encodeURIComponent(nombreEspecie)}`;
      var busquedaRes = await fetch(busquedaUrl);
      var busquedaData = await busquedaRes.json();
      
      var speciesKey = busquedaData.speciesKey || busquedaData.usageKey;
      var nombreCientifico = busquedaData.species || busquedaData.canonicalName || nombreEspecie;

      if (!speciesKey) {
        throw new Error("No se encontr√≥ la especie en GBIF");
      }

      // Buscar ocurrencias
      var url = `https://api.gbif.org/v1/occurrence/search?` +
                `taxonKey=${speciesKey}` +
                `&hasCoordinate=true` +
                `&hasGeospatialIssue=false` +
                `&limit=100` +
                `&decimalLatitude=${bounds.getSouth()},${bounds.getNorth()}` +
                `&decimalLongitude=${bounds.getWest()},${bounds.getEast()}`;

      var response = await fetch(url);
      var data = await response.json();

      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosBusqueda").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">üîç</p>
            <h3 style="color: #856404;">No se encontraron citas</h3>
            <p style="color: #666;">
              No hay registros de <strong>${nombreCientifico}</strong> en el √°rea seleccionada.
            </p>
          </div>
        `;
        return;
      }

      // Mostrar resultados
      var html = `
        <div class="stats">
          üéØ Especie: <strong>${nombreCientifico}</strong><br>
          üìç Total citas: ${data.count || data.results.length}<br>
          üìè √Årea: ${calcularAreaKm2(bounds).toFixed(0)} km¬≤
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      data.results.forEach(function(cita, index) {
        if (cita.decimalLatitude && cita.decimalLongitude) {
          var marker = L.circleMarker([cita.decimalLatitude, cita.decimalLongitude], {
            radius: 6,
            color: '#2c5e2e',
            weight: 2,
            fillColor: '#4caf50',
            fillOpacity: 0.7
          }).addTo(markersLayer);
          
          marker.bindPopup(`
            <b>${cita.species || nombreCientifico}</b><br>
            ${cita.vernacularName ? `<i>${cita.vernacularName}</i><br>` : ''}
            üìÖ ${cita.eventDate ? new Date(cita.eventDate).toLocaleDateString() : 'Fecha desconocida'}<br>
            üìç ${cita.decimalLatitude.toFixed(4)}, ${cita.decimalLongitude.toFixed(4)}<br>
            <a href="https://www.gbif.org/occurrence/${cita.key}" target="_blank">üîó Ver en GBIF</a>
          `);
        }

        html += `<div class="cita-card">`;
        html += `<div class="cita-info">`;
        html += `<div class="cita-titulo">Cita #${index + 1}</div>`;
        html += `<div class="cita-detalle">`;
        html += `üìç ${cita.decimalLatitude?.toFixed(4)}, ${cita.decimalLongitude?.toFixed(4)}<br>`;
        html += `üìÖ ${cita.eventDate ? new Date(cita.eventDate).toLocaleDateString() : 'No disponible'}<br>`;
        if (cita.locality) html += `üèûÔ∏è ${cita.locality}<br>`;
        if (cita.recordedBy) html += `üë§ ${cita.recordedBy}<br>`;
        html += `</div>`;
        html += `<a href="https://www.gbif.org/occurrence/${cita.key}" target="_blank" style="color: #0066cc; font-size: 13px;">üîó Ver detalle</a>`;
        html += `</div>`;
        html += `</div>`;
      });

      html += `</div>`;
      document.getElementById("resultadosBusqueda").innerHTML = html;

      if (markersLayer.getLayers().length > 0) {
        map.fitBounds(markersLayer.getBounds().pad(0.1));
      }

    } catch (error) {
      console.error(error);
      document.getElementById("resultadosBusqueda").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          ‚ùå Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCI√ìN: Consultar todas las especies (Pesta√±a 1)
  // ============================================
  async function consultarGBIF() {
    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "‚ö†Ô∏è Primero dibuja un √°rea en el mapa O busca un pa√≠s en la Pesta√±a 3";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    document.getElementById("resultados").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando GBIF...</p>
      </div>
    `;

    var bounds = areaSeleccionada;
    var claseSeleccionada = document.getElementById("grupo").value;

    try {
      var url = "https://api.gbif.org/v1/occurrence/search?" +
                "hasCoordinate=true" +
                "&hasGeospatialIssue=false" +
                "&limit=300" +
                "&kingdomKey=1";

      if (claseSeleccionada) url += "&classKey=" + claseSeleccionada;

      url += "&decimalLatitude=" + bounds.getSouth() + "," + bounds.getNorth() +
             "&decimalLongitude=" + bounds.getWest() + "," + bounds.getEast();

      var response = await fetch(url);
      var data = await response.json();

      var especiesMap = new Map();

      if (data.results && data.results.length > 0) {
        data.results.forEach(function(r) {
          if (r.species && r.species.trim() !== '') {
            if (!especiesMap.has(r.species)) {
              especiesMap.set(r.species, {
                nombre: r.species,
                nombreComun: r.vernacularName || "Nombre com√∫n no disponible",
                familia: r.family || "No disponible",
                orden: r.order || "No disponible",
                speciesKey: r.speciesKey || null,
                totalRegistros: 1
              });
            } else {
              especiesMap.get(r.species).totalRegistros++;
            }
          }
        });
      }

      if (especiesMap.size === 0) {
        document.getElementById("resultados").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3 style="color: #856404;">No se encontraron especies</h3>
          </div>
        `;
        return;
      }

      var especiesArray = Array.from(especiesMap.values());
      especiesArray.sort((a, b) => b.totalRegistros - a.totalRegistros);

      var html = `
        <div class="stats">
          üìä Total especies: ${especiesMap.size}<br>
          üìù Total registros: ${data.count || data.results.length}
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      especiesArray.slice(0, 50).forEach(function(especie) {
        html += `<div class="cita-card">`;
        html += `<div class="cita-info">`;
        html += `<div class="cita-titulo">${especie.nombre}</div>`;
        html += `<div style="color: #666;"><i>${especie.nombreComun}</i></div>`;
        html += `<div class="cita-detalle">`;
        html += `<span class="badge">üìå ${especie.familia}</span>`;
        html += `<span class="badge">üìä ${especie.totalRegistros} registros</span>`;
        html += `</div>`;
        if (especie.speciesKey) {
          html += `<a href="https://www.gbif.org/species/${especie.speciesKey}" target="_blank" style="color: #0066cc; font-size: 13px;">üîó Ver en GBIF</a>`;
        }
        html += `</div>`;
        html += `</div>`;
      });

      html += `</div>`;
      
      if (especiesMap.size > 50) {
        html += `<div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px; margin-top: 15px;">
          <p style="color: #856404;">‚ö†Ô∏è Mostrando 50 de ${especiesMap.size} especies</p>
        </div>`;
      }
      
      document.getElementById("resultados").innerHTML = html;

    } catch (error) {
      console.error(error);
      document.getElementById("resultados").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          ‚ùå Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // Autocompletado b√°sico para pa√≠ses
  // ============================================
  document.getElementById("buscadorPais")?.addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) return;
    
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
        { headers: { 'User-Agent': 'ExploreNat-BiodiversityApp/1.0' } }
      );
      const sugerencias = await response.json();
      
      let html = '<div class="pais-sugerencia">';
      sugerencias.forEach(s => {
        html += `<div class="pais-sugerencia-item" onclick="document.getElementById('buscadorPais').value = '${s.display_name.replace(/'/g, "\\'")}'; document.getElementById('sugerenciasPais').innerHTML = ''; buscarPais();">`;
        html += `${s.display_name} (${s.type})`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasPais").innerHTML = html;
    } catch (error) {
      console.error("Error en autocompletado:", error);
    }
  });

  // Cerrar sugerencias al hacer clic fuera
  document.addEventListener("click", function(e) {
    if (!e.target.closest('#buscadorPais') && !e.target.closest('.pais-sugerencia')) {
      document.getElementById("sugerenciasPais").innerHTML = '';
    }
  });

  // Permitir buscar con Enter
  document.getElementById("buscadorPais")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscarPais();
  });
  
  document.getElementById("buscadorEspecie")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscarEspecie();
  });

  // ============================================
  // INICIALIZACI√ìN
  // ============================================
  window.onload = function() {
    console.log("ExploreNat - Buscador de Pa√≠ses y Especies iniciado");
  };
</script>

</body>
</html>
