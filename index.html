<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
    }

    button, select {
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>Explorador de Biodiversidad</h1>

<div id="map"></div>

<button onclick="obtenerArea()">Obtener coordenadas</button>
<button onclick="consultarGBIF()">Consultar animales en esta área</button>

<label for="grupo">Selecciona grupo:</label>
<select id="grupo">
  <option value="">Todos</option>
  <option value="212">Aves</option>
  <option value="359">Mamíferos</option>
  <option value="358">Reptiles</option>
  <option value="187">Anfibios</option>
  <option value="204">Peces óseos</option>
  <option value="216">Insectos</option>
</select>

<h3>Coordenadas:</h3>
<pre id="coords"></pre>

<h3>Especies encontradas:</h3>
<pre id="resultados"></pre>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet Draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // Crear mapa
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Grupo para dibujar áreas
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: false, polyline: false, circle: false, marker: false, circlemarker: false, rectangle: true }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rectángulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers(); // solo un área a la vez
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
  });

  // Mostrar coordenadas del área
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    var north = bounds.getNorth();
    var south = bounds.getSouth();
    var east = bounds.getEast();
    var west = bounds.getWest();

    document.getElementById("coords").textContent =
      "North: " + north + "\n" +
      "South: " + south + "\n" +
      "East: " + east + "\n" +
      "West: " + west;
  }

  // Consultar GBIF con límite aumentado
  async function consultarGBIF() {

    document.getElementById("resultados").textContent = "Consultando GBIF...";

    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    var north = bounds.getNorth();
    var south = bounds.getSouth();
    var east = bounds.getEast();
    var west = bounds.getWest();

    var claseSeleccionada = document.getElementById("grupo").value;

    // Construir URL
    var url = "https://api.gbif.org/v1/occurrence/search?" +
              "hasCoordinate=true" +
              "&limit=1000" +   // límite más alto para grupos poco muestreados
              "&kingdomKey=1";   // Animalia

    if (claseSeleccionada) {
      url += "&classKey=" + claseSeleccionada;
    }

    url += "&decimalLatitude=" + south + "," + north +
           "&decimalLongitude=" + west + "," + east;

    try {
      var response = await fetch(url);
      var data = await response.json();

      var especies = new Set();

      data.results.forEach(function(r) {
        if (r.species) {
          especies.add(r.species);
        }
      });

      if (especies.size === 0) {
        document.getElementById("resultados").textContent =
          "No se encontraron especies para este grupo en el área seleccionada.\nPrueba ampliando la zona o cambiando el grupo.";
        return;
      }

      var texto = "";
      especies.forEach(function(e) {
        texto += e + "\n";
      });

      document.getElementById("resultados").textContent =
        "Total especies únicas: " + especies.size + "\n\n" + texto;

    } catch (error) {
      document.getElementById("resultados").textContent = "Error al consultar GBIF.";
      console.error(error);
    }
  }

</script>

</body>
</html>
