<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Explorador de Biodiversidad</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f0f7f0;
    }

    h1 {
      color: #2c5e2e;
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.5em;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 3px solid #4CAF50;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }

    button, select, input {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
    }

    button:hover {
      background-color: #388E3C;
    }

    .button-blue {
      background-color: #2196F3;
    }

    .button-orange {
      background-color: #ff9800;
    }

    .button-country {
      background-color: #8B4513;
    }

    select, input {
      background-color: white;
      border: 2px solid #e0e0e0;
    }

    input {
      cursor: text;
      min-width: 300px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusquedaTaxon, #resultadosPais {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .country-info {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #8B4513;
    }

    .country-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #8B4513;
    }

    .country-detail {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border: 1px solid #eaeaea;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .inat-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #4CAF50;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      background-color: #f5f5f5;
    }

    .inat-card.selected {
      background-color: #e8f5e9;
      border-left: 4px solid #4CAF50;
    }

    .inat-imagen {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      margin-right: 15px;
      border: 2px solid #4CAF50;
    }

    .inat-placeholder {
      width: 80px;
      height: 80px;
      background: #e8f5e9;
      margin-right: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 30px;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
    }

    .badge {
      background: #e8f5e9;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #2e7d32;
      display: inline-block;
      margin-right: 8px;
    }

    .badge-country {
      background: #d2b48c;
      color: #8B4513;
    }

    .loading {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      padding: 10px;
    }

    .pagination button {
      padding: 8px 16px;
      background: #e9ecef;
      color: #495057;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button.active {
      background: #4CAF50;
      color: white;
    }

    .pagination button:hover:not(.active) {
      background: #d4d4d4;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .tab-button {
      background: #e9ecef;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      display: inline-block;
      border: none;
    }

    .tab-button.active {
      background: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .sugerencias-container, .sugerencias-taxon-container, .sugerencias-country-container {
      position: absolute;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      width: 500px;
      z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .sugerencia-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sugerencia-item:hover {
      background-color: #e8f5e9;
    }

    .sugerencia-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }

    .sugerencia-item .taxon-info {
      flex: 1;
    }

    .sugerencia-item .taxon-name {
      font-weight: bold;
      color: #2e7d32;
    }

    .sugerencia-item .taxon-rank {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
    }

    .enlace-inat {
      color: #4CAF50;
      text-decoration: none;
      font-size: 13px;
      margin-left: 8px;
    }

    .enlace-inat:hover {
      text-decoration: underline;
    }

    .progreso-carga {
      text-align: center;
      padding: 20px;
      color: #2e7d32;
      font-weight: bold;
    }

    .buscador-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #4CAF50;
    }

    .buscador-titulo {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    .buscador-input-container {
      display: flex;
      gap: 10px;
      position: relative;
    }

    .buscador-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      font-size: 14px;
    }

    .buscador-input:focus {
      outline: none;
      border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }

    .quick-countries {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .quick-country-btn {
      background: #e8f5e9;
      border: 1px solid #8B4513;
      color: #8B4513;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
    }

    .quick-country-btn:hover {
      background: #8B4513;
      color: white;
    }
  </style>
</head>
<body>

<h1>üåø ExploreNat</h1>

<div class="controls">
  <button onclick="limpiarMapa()">üóëÔ∏è Limpiar √°rea</button>
  <button onclick="limpiarMarcadores()" class="button-orange">üóëÔ∏è Limpiar marcadores</button>
  
  <label>
    <input type="checkbox" id="soloResearch" checked> Solo grado investigaci√≥n
  </label>
</div>

<div id="map"></div>

<div id="mensajeAyuda" style="display: none;" class="warning"></div>

<h3>üìê √Årea seleccionada:</h3>
<pre id="coords">Dibuja un rect√°ngulo en el mapa o selecciona un pa√≠s</pre>

<!-- Pesta√±as -->
<div style="margin: 20px 0;">
  <button class="tab-button active" onclick="cambiarTab(1)">üåç Todas las especies</button>
  <button class="tab-button" onclick="cambiarTab(2)">üîç Buscar tax√≥n</button>
  <button class="tab-button" onclick="cambiarTab(3)">üó∫Ô∏è Buscar zona</button>
  <button class="tab-button" onclick="cambiarTab(4)">üá∫üá≥ Pa√≠ses (l√≠mites reales)</button>
</div>

<!-- Pesta√±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <button onclick="consultarINaturalistCompleto()">üîç Ver TODAS las especies en el √°rea</button>
  <div id="progreso" style="display: none;" class="progreso-carga"></div>
  <div id="resultados" style="margin-top: 15px;"></div>
  <div id="paginacion" class="pagination"></div>
</div>

<!-- Pesta√±a 2: Buscador de tax√≥n -->
<div id="tab2" class="tab-content">
  <div class="buscador-container">
    <div class="buscador-titulo">üîç Buscar cualquier tax√≥n (especie, g√©nero, familia, orden...)</div>
    <div style="position: relative;">
      <div class="buscador-input-container">
        <input type="text" id="buscadorTaxon" class="buscador-input" 
               placeholder="Ej: Lynx pardinus, Reptilia, Aves, Canis, Fabaceae..." autocomplete="off">
        <button onclick="buscarTaxon()" class="button-blue">Buscar</button>
      </div>
      <div id="sugerenciasTaxon" style="position: relative;"></div>
    </div>
  </div>
  <div id="resultadosBusquedaTaxon" style="margin-top: 15px;"></div>
</div>

<!-- Pesta√±a 3: Buscador de zona (rect√°ngulo) -->
<div id="tab3" class="tab-content">
  <div style="position: relative;">
    <div style="display: flex; gap: 10px;">
      <input type="text" id="buscadorPais" placeholder="Ej: Do√±ana, Madrid, Amazonas" style="flex: 1;" autocomplete="off">
      <button onclick="buscarZona()">Buscar zona</button>
    </div>
    <div id="sugerenciasZona" style="position: relative;"></div>
  </div>
  <div id="resultadosPais" style="margin-top: 15px;"></div>
</div>

<!-- Pesta√±a 4: Pa√≠ses con l√≠mites reales -->
<div id="tab4" class="tab-content">
  <div class="buscador-container">
    <div class="buscador-titulo">üá∫üá≥ Buscar pa√≠s (l√≠mites pol√≠ticos reales)</div>
    <div style="position: relative;">
      <div class="buscador-input-container">
        <input type="text" id="buscadorPaisReal" class="buscador-input" 
               placeholder="Ej: Espa√±a, Costa Rica, Ecuador, Australia..." autocomplete="off">
        <button onclick="buscarPaisReal()" class="button-country">Buscar pa√≠s</button>
      </div>
      <div id="sugerenciasPaisReal" style="position: relative;"></div>
    </div>
    
    <div class="quick-countries">
      <span class="quick-country-btn" onclick="cargarPaisReal('Espa√±a')">üá™üá∏ Espa√±a</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Portugal')">üáµüáπ Portugal</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Francia')">üá´üá∑ Francia</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Italia')">üáÆüáπ Italia</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Costa Rica')">üá®üá∑ Costa Rica</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Ecuador')">üá™üá® Ecuador</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Colombia')">üá®üá¥ Colombia</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Per√∫')">üáµüá™ Per√∫</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Brasil')">üáßüá∑ Brasil</span>
      <span class="quick-country-btn" onclick="cargarPaisReal('Australia')">üá¶üá∫ Australia</span>
    </div>
  </div>
  
  <!-- Informaci√≥n del pa√≠s seleccionado -->
  <div id="infoPaisReal" style="display: none;" class="country-info"></div>
  
  <!-- Resultados de especies del pa√≠s -->
  <div id="resultadosPaisReal" style="margin-top: 15px;"></div>
  <div id="paginacionPaisReal" class="pagination"></div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // VARIABLES GLOBALES
  // ============================================
  let map;
  let drawnItems;
  let markersLayer;
  let zoneLayer;
  let areaSeleccionada = null;
  
  // Variables para paginaci√≥n
  let todasLasEspecies = [];
  let paginaActual = 1;
  const especiesPorPagina = 20;
  
  // Variables para pa√≠s real
  let paisActual = null;
  let especiesPais = [];
  let paginaActualPais = 1;

  // ============================================
  // INICIALIZACI√ìN
  // ============================================
  window.onload = function() {
    console.log("Iniciando ExploreNat...");
    
    // Crear mapa
    map = L.map('map').setView([40.4168, -3.7038], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Capas
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    markersLayer = new L.FeatureGroup();
    map.addLayer(markersLayer);

    zoneLayer = new L.FeatureGroup();
    map.addLayer(zoneLayer);

    // Control de dibujo
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: false, polyline: false, circle: false, marker: false, circlemarker: false, rectangle: true }
    });
    map.addControl(drawControl);

    // Evento al dibujar
    map.on(L.Draw.Event.CREATED, function(e) {
      var layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      areaSeleccionada = layer.getBounds();
      document.getElementById("mensajeAyuda").style.display = "none";
      
      document.getElementById("coords").innerHTML = 
        `Norte: ${areaSeleccionada.getNorth().toFixed(4)}¬∞<br>` +
        `Sur: ${areaSeleccionada.getSouth().toFixed(4)}¬∞<br>` +
        `Este: ${areaSeleccionada.getEast().toFixed(4)}¬∞<br>` +
        `Oeste: ${areaSeleccionada.getWest().toFixed(4)}¬∞`;
    });

    console.log("‚úÖ Mapa cargado correctamente");
  };

  // ============================================
  // FUNCIONES B√ÅSICAS
  // ============================================
  
  function limpiarMapa() {
    if (drawnItems) drawnItems.clearLayers();
    if (markersLayer) markersLayer.clearLayers();
    if (zoneLayer) zoneLayer.clearLayers();
    areaSeleccionada = null;
    paisActual = null;
    document.getElementById("coords").innerHTML = "Dibuja un rect√°ngulo en el mapa o selecciona un pa√≠s";
    document.getElementById("resultados").innerHTML = "";
    document.getElementById("resultadosBusquedaTaxon").innerHTML = "";
    document.getElementById("resultadosPais").innerHTML = "";
    document.getElementById("resultadosPaisReal").innerHTML = "";
    document.getElementById("infoPaisReal").style.display = "none";
    document.getElementById("mensajeAyuda").style.display = "none";
    document.getElementById("paginacion").innerHTML = "";
    document.getElementById("paginacionPaisReal").innerHTML = "";
    document.getElementById("progreso").style.display = "none";
    todasLasEspecies = [];
    especiesPais = [];
    paginaActual = 1;
    paginaActualPais = 1;
  }

  function limpiarMarcadores() {
    if (markersLayer) markersLayer.clearLayers();
    document.querySelectorAll('.inat-card').forEach(card => {
      card.classList.remove('selected');
    });
  }

  function cambiarTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCI√ìN PARA MOSTRAR CITAS
  // ============================================
  
  async function mostrarCitasEspecie(taxonId, taxonNombre, elemento) {
    if (!areaSeleccionada && !paisActual) {
      alert("Primero selecciona un √°rea o pa√≠s en el mapa");
      return;
    }

    markersLayer.clearLayers();
    document.querySelectorAll('.inat-card').forEach(card => {
      card.classList.remove('selected');
    });

    if (elemento) {
      elemento.classList.add('selected');
    }

    const soloResearch = document.getElementById("soloResearch").checked;
    let url;

    if (paisActual) {
      // Usar place_id del pa√≠s
      url = `https://api.inaturalist.org/v1/observations?` +
            `taxon_id=${taxonId}` +
            `&verifiable=${soloResearch}` +
            `&per_page=50` +
            `&place_id=${paisActual.place_id}`;
    } else {
      // Usar bounding box
      const bounds = areaSeleccionada;
      url = `https://api.inaturalist.org/v1/observations?` +
            `taxon_id=${taxonId}` +
            `&verifiable=${soloResearch}` +
            `&per_page=50` +
            `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
            `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;
    }

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!data.results || data.results.length === 0) {
        document.getElementById("mensajeAyuda").innerHTML = `No hay citas de ${taxonNombre} en esta √°rea`;
        document.getElementById("mensajeAyuda").className = "warning";
        document.getElementById("mensajeAyuda").style.display = "block";
        return;
      }

      data.results.forEach(obs => {
        if (obs.geojson && obs.geojson.coordinates) {
          const [lng, lat] = obs.geojson.coordinates;
          
          L.circleMarker([lat, lng], {
            radius: 8,
            color: '#4CAF50',
            weight: 2,
            fillColor: '#81C784',
            fillOpacity: 0.8
          }).addTo(markersLayer).bindPopup(`
            <b>${taxonNombre}</b><br>
            üìÖ ${obs.observed_on || 'Fecha desconocida'}<br>
            üë§ ${obs.user?.login || 'An√≥nimo'}<br>
            üèÖ ${obs.quality_grade}<br>
            <a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank">üîó Ver en iNaturalist</a>
          `);
        }
      });

      if (markersLayer.getLayers().length > 0) {
        map.fitBounds(markersLayer.getBounds().pad(0.1));
      }

      document.getElementById("mensajeAyuda").innerHTML = 
        `üìç Mostrando ${data.results.length} citas de ${taxonNombre}`;
      document.getElementById("mensajeAyuda").className = "success";
      document.getElementById("mensajeAyuda").style.display = "block";

    } catch (error) {
      console.error("Error:", error);
      alert("Error al cargar las citas");
    }
  }

  // ============================================
  // FUNCIONES DE PAGINACI√ìN GEN√âRICAS
  // ============================================
  
  function mostrarPagina(pagina, especies, contenedorId, paginacionId, callbackPagina) {
    const inicio = (pagina - 1) * especiesPorPagina;
    const fin = inicio + especiesPorPagina;
    const especiesPagina = especies.slice(inicio, fin);
    
    let html = `<div class="stats">üìä Total especies: ${especies.length} (mostrando ${inicio+1}-${Math.min(fin, especies.length)})</div>`;

    especiesPagina.forEach(item => {
      const taxon = item.taxon;
      html += `<div class="inat-card" onclick="mostrarCitasEspecie(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', this)">`;
      
      if (taxon.default_photo && taxon.default_photo.medium_url) {
        html += `<img class="inat-imagen" src="${taxon.default_photo.medium_url}" alt="${taxon.name}">`;
      } else {
        html += `<div class="inat-placeholder">üì∑</div>`;
      }
      
      html += `<div class="inat-info">`;
      html += `<div class="inat-titulo">${taxon.name} 
               <a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" class="enlace-inat" onclick="event.stopPropagation()">üîó iNat</a>
               </div>`;
      html += `<div>${taxon.preferred_common_name || ''}</div>`;
      html += `<span class="badge">üìä ${item.count} obs</span>`;
      if (taxon.iconic_taxon_name) {
        html += `<span class="badge">${taxon.iconic_taxon_name}</span>`;
      }
      html += `</div></div>`;
    });

    document.getElementById(contenedorId).innerHTML = html;
    
    // Actualizar paginaci√≥n
    const totalPaginas = Math.ceil(especies.length / especiesPorPagina);
    let paginacionHtml = '<div class="pagination">';
    
    paginacionHtml += `<button onclick="${callbackPagina}(${pagina-1})" ${pagina === 1 ? 'disabled' : ''}>‚óÄ Anterior</button>`;
    
    for (let i = 1; i <= totalPaginas; i++) {
      if (i === 1 || i === totalPaginas || (i >= pagina - 2 && i <= pagina + 2)) {
        paginacionHtml += `<button onclick="${callbackPagina}(${i})" class="${i === pagina ? 'active' : ''}">${i}</button>`;
      } else if (i === pagina - 3 || i === pagina + 3) {
        paginacionHtml += `<button disabled>...</button>`;
      }
    }
    
    paginacionHtml += `<button onclick="${callbackPagina}(${pagina+1})" ${pagina === totalPaginas ? 'disabled' : ''}>Siguiente ‚ñ∂</button>`;
    paginacionHtml += '</div>';
    
    document.getElementById(paginacionId).innerHTML = paginacionHtml;
  }

  // ============================================
  // FUNCI√ìN PARA OBTENER TODAS LAS ESPECIES (BOUNDING BOX)
  // ============================================
  
  async function obtenerTodasLasEspecies(urlBase, totalEsperado) {
    let todas = [];
    let pagina = 1;
    let especiesObtenidas = 0;
    const progresoDiv = document.getElementById("progreso");
    
    while (especiesObtenidas < totalEsperado) {
      progresoDiv.style.display = "block";
      progresoDiv.innerHTML = `Cargando especies... ${especiesObtenidas} de ${totalEsperado} (P√°gina ${pagina})`;
      
      const url = `${urlBase}&page=${pagina}`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) break;
      
      todas = [...todas, ...data.results];
      especiesObtenidas = todas.length;
      pagina++;
      
      await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    progresoDiv.style.display = "none";
    return todas;
  }

  // ============================================
  // PESTA√ëA 1 - TODAS LAS ESPECIES (BOUNDING BOX)
  // ============================================
  
  async function consultarINaturalistCompleto() {
    if (!areaSeleccionada) {
      alert("Primero dibuja un √°rea en el mapa");
      return;
    }

    document.getElementById("resultados").innerHTML = '';
    document.getElementById("paginacion").innerHTML = '';
    document.getElementById("progreso").style.display = "block";
    document.getElementById("progreso").innerHTML = "Obteniendo n√∫mero total de especies...";

    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;

    try {
      let urlBase = `https://api.inaturalist.org/v1/observations/species_counts?` +
                    `verifiable=${soloResearch}` +
                    `&per_page=1` +
                    `&swlat=${bounds.getSouth()}` +
                    `&swlng=${bounds.getWest()}` +
                    `&nelat=${bounds.getNorth()}` +
                    `&nelng=${bounds.getEast()}`;

      const response = await fetch(urlBase);
      const data = await response.json();
      
      if (!data.total_results || data.total_results === 0) {
        document.getElementById("resultados").innerHTML = "No se encontraron especies en esta √°rea";
        document.getElementById("progreso").style.display = "none";
        return;
      }

      const totalEspecies = data.total_results;
      
      urlBase = `https://api.inaturalist.org/v1/observations/species_counts?` +
                `verifiable=${soloResearch}` +
                `&per_page=200` +
                `&swlat=${bounds.getSouth()}` +
                `&swlng=${bounds.getWest()}` +
                `&nelat=${bounds.getNorth()}` +
                `&nelng=${bounds.getEast()}`;

      todasLasEspecies = await obtenerTodasLasEspecies(urlBase, totalEspecies);
      
      if (todasLasEspecies.length === 0) {
        document.getElementById("resultados").innerHTML = "No se pudieron cargar las especies";
        return;
      }

      paginaActual = 1;
      window.mostrarPaginaPrincipal = function(pagina) {
        mostrarPagina(pagina, todasLasEspecies, "resultados", "paginacion", "mostrarPaginaPrincipal");
        paginaActual = pagina;
      };
      mostrarPaginaPrincipal(1);

    } catch (error) {
      document.getElementById("resultados").innerHTML = `Error: ${error.message}`;
      document.getElementById("progreso").style.display = "none";
    }
  }

  // ============================================
  // PESTA√ëA 2 - BUSCADOR DE TAX√ìN
  // ============================================
  
  document.getElementById("buscadorTaxon").addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) {
      document.getElementById("sugerenciasTaxon").innerHTML = '';
      return;
    }
    
    try {
      const response = await fetch(
        `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(query)}&per_page=8&all_names=true`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) return;
      
      let html = '<div class="sugerencias-taxon-container">';
      data.results.forEach(taxon => {
        const nombreComun = taxon.preferred_common_name || '';
        const nombreCientifico = taxon.name;
        const rango = taxon.rank?.toLowerCase() || 'tax√≥n';
        
        let icono = 'üî¨';
        if (rango === 'species') icono = 'ü¶ã';
        else if (rango === 'genus') icono = 'üåø';
        else if (rango === 'family') icono = 'üå≥';
        else if (rango === 'order') icono = 'üìã';
        else if (rango === 'class') icono = 'üìä';
        else if (rango === 'phylum') icono = 'üî¨';
        
        html += `<div class="sugerencia-item" onclick="seleccionarTaxon(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', '${rango}')">`;
        html += `<div style="font-size: 20px; min-width: 30px;">${icono}</div>`;
        html += `<div class="taxon-info">`;
        html += `<div class="taxon-name">${nombreCientifico}</div>`;
        html += `<div class="taxon-rank">${rango} ${nombreComun ? '‚Ä¢ ' + nombreComun : ''}</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasTaxon").innerHTML = html;
    } catch (error) {
      console.error("Error:", error);
    }
  });

  window.seleccionarTaxon = function(taxonId, taxonNombre, rango) {
    document.getElementById("buscadorTaxon").value = taxonNombre;
    document.getElementById("sugerenciasTaxon").innerHTML = '';
    obtenerEspeciesPorTaxon(taxonId, taxonNombre, rango);
  };

  async function buscarTaxon() {
    const nombre = document.getElementById("buscadorTaxon").value.trim();
    if (!nombre) return alert("Escribe el nombre de un tax√≥n");
    if (!areaSeleccionada && !paisActual) {
      alert("Primero selecciona un √°rea en el mapa o un pa√≠s");
      return;
    }

    try {
      const taxonRes = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(nombre)}&per_page=1`);
      const taxonData = await taxonRes.json();
      
      if (!taxonData.results || taxonData.results.length === 0) {
        document.getElementById("resultadosBusquedaTaxon").innerHTML = "Tax√≥n no encontrado";
        return;
      }

      const taxon = taxonData.results[0];
      await obtenerEspeciesPorTaxon(taxon.id, taxon.name, taxon.rank);

    } catch (error) {
      document.getElementById("resultadosBusquedaTaxon").innerHTML = `Error: ${error.message}`;
    }
  }

  async function obtenerEspeciesPorTaxon(taxonId, taxonNombre, rango) {
    if (!areaSeleccionada && !paisActual) {
      alert("Primero selecciona un √°rea en el mapa o un pa√≠s");
      return;
    }

    document.getElementById("resultadosBusquedaTaxon").innerHTML = '<div style="text-align: center;"><div class="loading"></div><p>Buscando especies...</p></div>';

    const soloResearch = document.getElementById("soloResearch").checked;
    let url;

    if (paisActual) {
      url = `https://api.inaturalist.org/v1/observations/species_counts?` +
            `verifiable=${soloResearch}` +
            `&taxon_id=${taxonId}` +
            `&per_page=200` +
            `&place_id=${paisActual.place_id}`;
    } else {
      const bounds = areaSeleccionada;
      url = `https://api.inaturalist.org/v1/observations/species_counts?` +
            `verifiable=${soloResearch}` +
            `&taxon_id=${taxonId}` +
            `&per_page=200` +
            `&swlat=${bounds.getSouth()}` +
            `&swlng=${bounds.getWest()}` +
            `&nelat=${bounds.getNorth()}` +
            `&nelng=${bounds.getEast()}`;
    }

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosBusquedaTaxon").innerHTML = 
          `<div class="warning">No se encontraron especies de ${taxonNombre} en esta √°rea</div>`;
        return;
      }

      const especies = data.results;
      let html = `<div class="stats">üéØ Tax√≥n: ${taxonNombre} (${rango}) ‚Ä¢ ${especies.length} especies encontradas</div>`;
      document.getElementById("resultadosBusquedaTaxon").innerHTML = html;
      
      let paginaActualTaxon = 1;
      
      window.mostrarPaginaTaxon = function(pagina) {
        const inicio = (pagina - 1) * especiesPorPagina;
        const fin = inicio + especiesPorPagina;
        const especiesPagina = especies.slice(inicio, fin);
        
        let htmlDetalle = `<div class="stats">üìä Total especies: ${especies.length} (mostrando ${inicio+1}-${Math.min(fin, especies.length)})</div>`;

        especiesPagina.forEach(item => {
          const taxon = item.taxon;
          htmlDetalle += `<div class="inat-card" onclick="mostrarCitasEspecie(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', this)">`;
          
          if (taxon.default_photo && taxon.default_photo.medium_url) {
            htmlDetalle += `<img class="inat-imagen" src="${taxon.default_photo.medium_url}" alt="${taxon.name}">`;
          } else {
            htmlDetalle += `<div class="inat-placeholder">üì∑</div>`;
          }
          
          htmlDetalle += `<div class="inat-info">`;
          htmlDetalle += `<div class="inat-titulo">${taxon.name} 
                   <a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" class="enlace-inat" onclick="event.stopPropagation()">üîó iNat</a>
                   </div>`;
          htmlDetalle += `<div>${taxon.preferred_common_name || ''}</div>`;
          htmlDetalle += `<span class="badge">üìä ${item.count} obs</span>`;
          if (taxon.iconic_taxon_name) {
            htmlDetalle += `<span class="badge">${taxon.iconic_taxon_name}</span>`;
          }
          htmlDetalle += `</div></div>`;
        });

        const totalPaginas = Math.ceil(especies.length / especiesPorPagina);
        let paginacionHtml = '<div class="pagination">';
        
        paginacionHtml += `<button onclick="mostrarPaginaTaxon(${pagina-1})" ${pagina === 1 ? 'disabled' : ''}>‚óÄ Anterior</button>`;
        
        for (let i = 1; i <= totalPaginas; i++) {
          if (i === 1 || i === totalPaginas || (i >= pagina - 2 && i <= pagina + 2)) {
            paginacionHtml += `<button onclick="mostrarPaginaTaxon(${i})" class="${i === pagina ? 'active' : ''}">${i}</button>`;
          } else if (i === pagina - 3 || i === pagina + 3) {
            paginacionHtml += `<button disabled>...</button>`;
          }
        }
        
        paginacionHtml += `<button onclick="mostrarPaginaTaxon(${pagina+1})" ${pagina === totalPaginas ? 'disabled' : ''}>Siguiente ‚ñ∂</button>`;
        paginacionHtml += '</div>';
        
        document.getElementById("resultadosBusquedaTaxon").innerHTML = htmlDetalle + paginacionHtml;
      };

      mostrarPaginaTaxon(1);

    } catch (error) {
      document.getElementById("resultadosBusquedaTaxon").innerHTML = `Error: ${error.message}`;
    }
  }

  // ============================================
  // PESTA√ëA 3 - BUSCADOR DE ZONA (RECT√ÅNGULO)
  // ============================================
  
  document.getElementById("buscadorPais").addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) {
      document.getElementById("sugerenciasZona").innerHTML = '';
      return;
    }
    
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const sugerencias = await response.json();
      
      if (sugerencias.length === 0) return;
      
      let html = '<div class="sugerencias-container">';
      sugerencias.forEach(s => {
        html += `<div class="sugerencia-item" onclick="seleccionarZona('${s.display_name.replace(/'/g, "\\'")}', ${s.boundingbox[0]}, ${s.boundingbox[1]}, ${s.boundingbox[2]}, ${s.boundingbox[3]}, ${s.lat}, ${s.lon})">`;
        html += `<strong>${s.display_name}</strong>`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasZona").innerHTML = html;
    } catch (error) {
      console.error("Error:", error);
    }
  });

  window.seleccionarZona = function(nombre, south, north, west, east, lat, lon) {
    document.getElementById("buscadorPais").value = nombre;
    document.getElementById("sugerenciasZona").innerHTML = '';
    paisActual = null;
    
    const bounds = L.latLngBounds([parseFloat(south), parseFloat(west)], [parseFloat(north), parseFloat(east)]);
    
    zoneLayer.clearLayers();
    L.rectangle(bounds, { color: "#4CAF50", weight: 3, fillOpacity: 0.1 }).addTo(zoneLayer);
    L.marker([parseFloat(lat), parseFloat(lon)]).addTo(zoneLayer).bindPopup(nombre).openPopup();
    
    map.fitBounds(bounds.pad(0.1));
    areaSeleccionada = bounds;
    
    document.getElementById("coords").innerHTML = 
      `üìç ${nombre}<br>` +
      `Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `Oeste: ${bounds.getWest().toFixed(4)}¬∞`;

    document.getElementById("resultadosPais").innerHTML = '';
    cambiarTab(1);
    consultarINaturalistCompleto();
  };

  async function buscarZona() {
    const query = document.getElementById("buscadorPais").value.trim();
    if (!query) return alert("Escribe un lugar");

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const data = await response.json();
      
      if (!data.length) {
        document.getElementById("resultadosPais").innerHTML = "Lugar no encontrado";
        return;
      }

      const lugar = data[0];
      seleccionarZona(lugar.display_name, lugar.boundingbox[0], lugar.boundingbox[1], 
                     lugar.boundingbox[2], lugar.boundingbox[3], lugar.lat, lugar.lon);

    } catch (error) {
      document.getElementById("resultadosPais").innerHTML = `Error: ${error.message}`;
    }
  }

  // ============================================
  // PESTA√ëA 4 - PA√çSES CON L√çMITES REALES
  // ============================================
  
  async function buscarPlaceIdINaturalist(query) {
    try {
      const url = `https://api.inaturalist.org/v1/places?q=${encodeURIComponent(query)}&per_page=10`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        // Filtrar solo pa√≠ses (place_type_name = 'Country')
        const paises = data.results.filter(p => p.place_type_name === 'Country');
        return paises.map(place => ({
          id: place.id,
          name: place.display_name,
          type: place.place_type_name,
          bbox: place.bounding_box_geojson ? 
                [place.bounding_box_geojson.coordinates[0][1], 
                 place.bounding_box_geojson.coordinates[0][0],
                 place.bounding_box_geojson.coordinates[2][1],
                 place.bounding_box_geojson.coordinates[2][0]] :
                [place.swlat, place.swlng, place.nelat, place.nelng],
          location: [place.latitude, place.longitude]
        }));
      }
      return [];
    } catch (error) {
      console.error("Error buscando pa√≠ses:", error);
      return [];
    }
  }

  document.getElementById("buscadorPaisReal").addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) {
      document.getElementById("sugerenciasPaisReal").innerHTML = '';
      return;
    }
    
    try {
      const paises = await buscarPlaceIdINaturalist(query);
      
      if (paises.length === 0) return;
      
      let html = '<div class="sugerencias-country-container">';
      paises.forEach(p => {
        html += `<div class="sugerencia-item" onclick="seleccionarPaisReal(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.bbox[0]}, ${p.bbox[1]}, ${p.bbox[2]}, ${p.bbox[3]}, ${p.location[0]}, ${p.location[1]})">`;
        html += `<div style="font-size: 20px; min-width: 30px;">üá∫üá≥</div>`;
        html += `<div class="taxon-info">`;
        html += `<div class="taxon-name">${p.name}</div>`;
        html += `<div class="taxon-rank">Pa√≠s</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasPaisReal").innerHTML = html;
    } catch (error) {
      console.error("Error:", error);
    }
  });

  window.seleccionarPaisReal = function(placeId, nombre, south, north, west, east, lat, lon) {
    document.getElementById("buscadorPaisReal").value = nombre;
    document.getElementById("sugerenciasPaisReal").innerHTML = '';
    
    const bounds = L.latLngBounds([parseFloat(south), parseFloat(west)], [parseFloat(north), parseFloat(east)]);
    
    zoneLayer.clearLayers();
    L.rectangle(bounds, { 
      color: "#8B4513", 
      weight: 4, 
      fillColor: "#8B4513",
      fillOpacity: 0.1,
      dashArray: null
    }).addTo(zoneLayer);
    
    L.marker([parseFloat(lat), parseFloat(lon)], {
      icon: L.divIcon({ 
        html: 'üìç', 
        iconSize: [30, 30],
        className: 'country-marker'
      })
    }).addTo(zoneLayer).bindPopup(`
      <b>${nombre}</b><br>
      Place ID: ${placeId}<br>
      L√≠mites pol√≠ticos reales
    `).openPopup();
    
    map.fitBounds(bounds.pad(0.1));
    
    // Guardar informaci√≥n del pa√≠s
    paisActual = {
      place_id: placeId,
      nombre: nombre,
      bounds: bounds,
      lat: lat,
      lon: lon
    };
    
    areaSeleccionada = null; // Limpiar √°rea de rect√°ngulo
    
    document.getElementById("coords").innerHTML = 
      `üìç Pa√≠s: ${nombre} (l√≠mites reales)<br>` +
      `Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `Oeste: ${bounds.getWest().toFixed(4)}¬∞`;
    
    // Mostrar informaci√≥n del pa√≠s
    document.getElementById("infoPaisReal").style.display = "block";
    document.getElementById("infoPaisReal").innerHTML = `
      <span class="country-name">üá∫üá≥ ${nombre}</span><br>
      <span class="country-detail">Place ID: ${placeId} ‚Ä¢ L√≠mites pol√≠ticos reales de iNaturalist</span>
    `;
    
    consultarPaisReal(placeId, nombre);
  };

  async function consultarPaisReal(placeId, nombre) {
    document.getElementById("resultadosPaisReal").innerHTML = '<div style="text-align: center;"><div class="loading"></div><p>Cargando biodiversidad del pa√≠s...</p></div>';
    document.getElementById("paginacionPaisReal").innerHTML = '';

    const soloResearch = document.getElementById("soloResearch").checked;

    try {
      // Primera consulta para obtener el total
      let url = `https://api.inaturalist.org/v1/observations/species_counts?` +
                `verifiable=${soloResearch}` +
                `&place_id=${placeId}` +
                `&per_page=1`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.total_results || data.total_results === 0) {
        document.getElementById("resultadosPaisReal").innerHTML = "No se encontraron especies en este pa√≠s";
        return;
      }

      const totalEspecies = data.total_results;
      
      // Obtener todas las especies
      url = `https://api.inaturalist.org/v1/observations/species_counts?` +
            `verifiable=${soloResearch}` +
            `&place_id=${placeId}` +
            `&per_page=200`;

      especiesPais = await obtenerTodasLasEspecies(url, totalEspecies);
      
      if (especiesPais.length === 0) {
        document.getElementById("resultadosPaisReal").innerHTML = "No se pudieron cargar las especies";
        return;
      }

      paginaActualPais = 1;
      
      window.mostrarPaginaPais = function(pagina) {
        mostrarPagina(pagina, especiesPais, "resultadosPaisReal", "paginacionPaisReal", "mostrarPaginaPais");
        paginaActualPais = pagina;
      };
      
      mostrarPaginaPais(1);

    } catch (error) {
      document.getElementById("resultadosPaisReal").innerHTML = `Error: ${error.message}`;
    }
  }

  function cargarPaisReal(nombre) {
    document.getElementById("buscadorPaisReal").value = nombre;
    buscarPaisReal();
  }

  async function buscarPaisReal() {
    const query = document.getElementById("buscadorPaisReal").value.trim();
    if (!query) return alert("Escribe el nombre de un pa√≠s");

    try {
      const paises = await buscarPlaceIdINaturalist(query);
      
      if (paises.length === 0) {
        document.getElementById("resultadosPaisReal").innerHTML = "Pa√≠s no encontrado en iNaturalist";
        return;
      }

      // Seleccionar el primer pa√≠s
      const p = paises[0];
      seleccionarPaisReal(p.id, p.name, p.bbox[0], p.bbox[1], p.bbox[2], p.bbox[3], p.location[0], p.location[1]);

    } catch (error) {
      document.getElementById("resultadosPaisReal").innerHTML = `Error: ${error.message}`;
    }
  }

  // ============================================
  // EVENTOS COMUNES
  // ============================================
  
  document.getElementById("buscadorTaxon").addEventListener("keypress", e => {
    if (e.key === "Enter") buscarTaxon();
  });

  document.getElementById("buscadorPais").addEventListener("keypress", e => {
    if (e.key === "Enter") buscarZona();
  });

  document.getElementById("buscadorPaisReal").addEventListener("keypress", e => {
    if (e.key === "Enter") buscarPaisReal();
  });

  // Cerrar sugerencias
  document.addEventListener("click", function(e) {
    if (!e.target.closest('#buscadorTaxon') && !e.target.closest('.sugerencias-taxon-container')) {
      document.getElementById("sugerenciasTaxon").innerHTML = '';
    }
    if (!e.target.closest('#buscadorPais') && !e.target.closest('.sugerencias-container')) {
      document.getElementById("sugerenciasZona").innerHTML = '';
    }
    if (!e.target.closest('#buscadorPaisReal') && !e.target.closest('.sugerencias-country-container')) {
      document.getElementById("sugerenciasPaisReal").innerHTML = '';
    }
  });

</script>

</body>
</html>