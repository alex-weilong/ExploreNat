<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #4CAF50;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    button, select, input {
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #388E3C;
    }

    .button-blue {
      background-color: #2196F3;
    }
    .button-blue:hover {
      background-color: #1976D2;
    }

    select, input {
      background-color: white;
      border: 1px solid #ccc;
    }

    input {
      cursor: text;
      min-width: 250px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusqueda, #resultadosPais {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      transition: transform 0.2s;
    }

    .inat-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #4CAF50;
    }

    .inat-imagen {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 15px;
    }

    .inat-placeholder {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      margin-right: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 24px;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .inat-comun {
      color: #666;
      font-size: 14px;
      font-style: italic;
      margin-bottom: 8px;
    }

    .inat-detalle {
      color: #666;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .badge {
      background: #e8f5e9;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #2e7d32;
      display: inline-block;
    }

    .badge-quality-research {
      background: #c8e6c9;
      color: #1b5e20;
      font-weight: bold;
    }

    .badge-quality-casual {
      background: #ffccbc;
      color: #bf360c;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #1b5e20;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-button.active {
      background: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .pais-sugerencia {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      width: 300px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .pais-sugerencia-item {
      padding: 10px;
      cursor: pointer;
    }

    .pais-sugerencia-item:hover {
      background-color: #e8f5e9;
    }

    .inat-icon {
      width: 30px;
      height: 30px;
      margin-right: 10px;
    }
  </style>
</head>
<body>

<h1>ğŸŒ¿ ExploreNat</h1>

<div class="controls">
  <button onclick="obtenerArea()">ğŸ“ Obtener coordenadas</button>
  <button onclick="limpiarMapa()">ğŸ—‘ï¸ Limpiar Ã¡rea</button>
  
  <label for="grupo">Filtrar por grupo:</label>
  <select id="grupo">
    <option value="">ğŸŒ Todos</option>
    <option value="Aves">ğŸ¦… Aves</option>
    <option value="Mammalia">ğŸ» MamÃ­feros</option>
    <option value="Reptilia">ğŸ¦ Reptiles</option>
    <option value="Amphibia">ğŸ¸ Anfibios</option>
    <option value="Actinopterygii">ğŸŸ Peces</option>
    <option value="Insecta">ğŸ¦‹ Insectos</option>
    <option value="Arachnida">ğŸ•·ï¸ ArÃ¡cnidos</option>
    <option value="Mollusca">ğŸŒ Moluscos</option>
    <option value="Plantae">ğŸŒ± Plantas</option>
    <option value="Fungi">ğŸ„ Hongos</option>
  </select>

  <label style="margin-left: 10px;">
    <input type="checkbox" id="soloResearch" checked> Solo grado investigaciÃ³n
  </label>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>ğŸ“ Coordenadas del Ã¡rea:</h3>
<pre id="coords">Dibuja un rectÃ¡ngulo en el mapa o busca un paÃ­s/ciudad</pre>

<!-- PestaÃ±as -->
<div class="tab-buttons">
  <button id="tab1Btn" class="tab-button active" onclick="cambiarTab(1)">ğŸŒ Todas las especies</button>
  <button id="tab2Btn" class="tab-button" onclick="cambiarTab(2)">ğŸ” Buscar especie</button>
  <button id="tab3Btn" class="tab-button" onclick="cambiarTab(3)">ğŸ—ºï¸ Buscar zona</button>
</div>

<!-- PestaÃ±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3>ğŸ“Š Especies en iNaturalist (Ã¡rea dibujada):</h3>
    <button onclick="consultarINaturalist()">ğŸ” Consultar especies</button>
  </div>
  <div id="resultados">
    <p style="color: #666; text-align: center; padding: 40px;">
      ğŸŒ Dibuja un Ã¡rea en el mapa o busca un paÃ­s en la PestaÃ±a 3
    </p>
  </div>
</div>

<!-- PestaÃ±a 2: Buscador de especie -->
<div id="tab2" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="buscadorEspecie" placeholder="Ej: Lynx pardinus, Aquila adalberti, Vipera latastei" style="flex: 1;">
      <button onclick="buscarEspecieINat()" class="button-blue">ğŸ” Buscar citas en el Ã¡rea</button>
    </div>
    <div id="resultadosBusqueda">
      <p style="color: #666; text-align: center; padding: 20px;">
        ğŸ” Busca una especie para ver todas sus observaciones en el Ã¡rea seleccionada
      </p>
    </div>
  </div>
</div>

<!-- PestaÃ±a 3: Buscador de paÃ­s/zona -->
<div id="tab3" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center; position: relative;">
      <input type="text" id="buscadorPais" 
             placeholder="Ej: EspaÃ±a, DoÃ±ana, Amazonas, Madrid, Costa Rica" 
             style="flex: 1;"
             autocomplete="off">
      <button onclick="buscarZonaINat()" style="background-color: #8B4513;">ğŸ—ºï¸ Buscar zona</button>
    </div>
    <div id="sugerenciasPais" style="position: relative;"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <select id="paisPreseleccionado" style="flex: 1;">
        <option value="">ğŸŒ Selecciona un paÃ­s rÃ¡pido...</option>
        <option value="EspaÃ±a">EspaÃ±a</option>
        <option value="Portugal">Portugal</option>
        <option value="Francia">Francia</option>
        <option value="Italia">Italia</option>
        <option value="Costa Rica">Costa Rica ğŸ‡¨ğŸ‡·</option>
        <option value="Ecuador">Ecuador</option>
        <option value="Colombia">Colombia</option>
        <option value="PerÃº">PerÃº</option>
        <option value="Brasil">Brasil</option>
        <option value="MÃ©xico">MÃ©xico</option>
        <option value="Australia">Australia</option>
        <option value="JapÃ³n">JapÃ³n</option>
      </select>
      <button onclick="cargarPaisPreseleccionado()" style="background-color: #6B8E23;">ğŸ“Œ Cargar</button>
    </div>
    
    <div id="resultadosPais" style="margin-top: 20px;">
      <p style="color: #666; text-align: center; padding: 20px;">
        ğŸ—ºï¸ Busca un paÃ­s o zona para ver su biodiversidad en iNaturalist
      </p>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACIÃ“N DEL MAPA
  // ============================================
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Capa para el Ã¡rea dibujada
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Capa para los marcadores de observaciones
  var markersLayer = new L.FeatureGroup();
  map.addLayer(markersLayer);

  // Capa para la zona buscada
  var zoneLayer = new L.FeatureGroup();
  map.addLayer(zoneLayer);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
      polygon: false, 
      polyline: false, 
      circle: false, 
      marker: false, 
      circlemarker: false, 
      rectangle: true 
    }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rectÃ¡ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    document.getElementById("mensajeAyuda").style.display = "none";
    obtenerArea();
  });

  // ============================================
  // FUNCIÃ“N: Limpiar mapa
  // ============================================
  function limpiarMapa() {
    drawnItems.clearLayers();
    markersLayer.clearLayers();
    zoneLayer.clearLayers();
    areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rectÃ¡ngulo en el mapa o busca un paÃ­s/ciudad";
  }

  // ============================================
  // FUNCIÃ“N: Cambiar pestaÃ±as
  // ============================================
  function cambiarTab(tabId) {
    document.getElementById('tab1Btn').classList.remove('active');
    document.getElementById('tab2Btn').classList.remove('active');
    document.getElementById('tab3Btn').classList.remove('active');
    document.getElementById(`tab${tabId}Btn`).classList.add('active');
    
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById('tab3').classList.remove('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // FUNCIÃ“N: Mostrar coordenadas
  // ============================================
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    document.getElementById("coords").innerHTML = 
      `ğŸ“ Norte: ${bounds.getNorth().toFixed(4)}Â°<br>` +
      `ğŸ“ Sur: ${bounds.getSouth().toFixed(4)}Â°<br>` +
      `ğŸ“ Este: ${bounds.getEast().toFixed(4)}Â°<br>` +
      `ğŸ“ Oeste: ${bounds.getWest().toFixed(4)}Â°<br>` +
      `ğŸ“ Ãrea: ${calcularAreaKm2(bounds).toFixed(0)} kmÂ²`;
  }

  // ============================================
  // FUNCIÃ“N: Calcular Ã¡rea
  // ============================================
  function calcularAreaKm2(bounds) {
    var R = 6371;
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    return ancho * alto;
  }

  // ============================================
  // FUNCIÃ“N: Geocodificar con Nominatim
  // ============================================
  async function geocodificarLugar(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&polygon_geojson=1`;
    try {
      const response = await fetch(url, { headers: { 'User-Agent': 'iNatExplorer/1.0' } });
      const data = await response.json();
      if (data && data.length > 0) {
        const lugar = data[0];
        let bounds = null;
        if (lugar.boundingbox) {
          bounds = L.latLngBounds(
            [parseFloat(lugar.boundingbox[0]), parseFloat(lugar.boundingbox[2])],
            [parseFloat(lugar.boundingbox[1]), parseFloat(lugar.boundingbox[3])]
          );
        }
        return {
          nombre: lugar.display_name,
          bounds: bounds,
          lat: parseFloat(lugar.lat),
          lon: parseFloat(lugar.lon),
          tipo: lugar.type
        };
      }
      return null;
    } catch (error) {
      console.error('Error geocodificando:', error);
      return null;
    }
  }

  // ============================================
  // FUNCIÃ“N PRINCIPAL: Consultar iNaturalist por Ã¡rea
  // Devuelve el conteo de especies en un Ã¡rea
  // ============================================
  async function consultarINaturalistPorBounds(bounds, taxonNombre = null, soloResearch = true) {
    // Construir URL para species_counts [citation:3][citation:4]
    let url = "https://api.inaturalist.org/v1/observations/species_counts?" +
              "verifiable=" + (soloResearch ? "true" : "any") +
              "&per_page=100" + // MÃ¡ximo por pÃ¡gina
              "&swlat=" + bounds.getSouth() +
              "&swlng=" + bounds.getWest() +
              "&nelat=" + bounds.getNorth() +
              "&nelng=" + bounds.getEast();

    if (taxonNombre) {
      // Buscar taxon_id primero
      try {
        const taxonSearch = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(taxonNombre)}&per_page=1`);
        const taxonData = await taxonSearch.json();
        if (taxonData.results && taxonData.results.length > 0) {
          url += "&taxon_id=" + taxonData.results[0].id;
        }
      } catch (e) {
        console.warn("No se pudo obtener taxon_id", e);
      }
    }

    try {
      const response = await fetch(url);
      const data = await response.json();
      return data;
    } catch (error) {
      console.error("Error consultando iNaturalist:", error);
      throw error;
    }
  }

  // ============================================
  // FUNCIÃ“N: Consultar todas las especies (PestaÃ±a 1)
  // ============================================
  async function consultarINaturalist() {
    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "âš ï¸ Primero dibuja un Ã¡rea en el mapa O busca un paÃ­s en la PestaÃ±a 3";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    document.getElementById("resultados").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando iNaturalist...</p>
      </div>
    `;

    const soloResearch = document.getElementById("soloResearch").checked;
    const grupoSeleccionado = document.getElementById("grupo").value;

    try {
      const data = await consultarINaturalistPorBounds(areaSeleccionada, grupoSeleccionado || null, soloResearch);
      
      if (!data.results || data.results.length === 0) {
        document.getElementById("resultados").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">ğŸ”</p>
            <h3 style="color: #856404;">No se encontraron especies</h3>
            <p>Prueba con un Ã¡rea mÃ¡s grande o cambia los filtros</p>
          </div>
        `;
        return;
      }

      // Mostrar resultados
      var html = `
        <div class="stats">
          ğŸ¦‹ Total especies: ${data.total_results}<br>
          ğŸ“¸ Observaciones verificadas: ${soloResearch ? 'SÃ­' : 'No'}<br>
          ğŸ”¬ Grupo: ${grupoSeleccionado || 'Todos'}<br>
          ğŸ“ Ãrea: ${calcularAreaKm2(areaSeleccionada).toFixed(0)} kmÂ²
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      data.results.slice(0, 50).forEach(function(item) {
        const taxon = item.taxon;
        html += `<div class="inat-card">`;
        
        // Foto
        if (taxon.default_photo && taxon.default_photo.medium_url) {
          html += `<img class="inat-imagen" src="${taxon.default_photo.medium_url}" alt="${taxon.name}">`;
        } else {
          html += `<div class="inat-placeholder">ğŸ“·</div>`;
        }
        
        html += `<div class="inat-info">`;
        html += `<div class="inat-titulo">${taxon.name}</div>`;
        html += `<div class="inat-comun">${taxon.preferred_common_name || 'Sin nombre comÃºn'}</div>`;
        html += `<div class="inat-detalle">`;
        html += `<span class="badge">ğŸ“Š ${item.count} observaciones</span>`;
        html += `<span class="badge">ğŸ”¬ ${taxon.rank}</span>`;
        if (taxon.iconic_taxon_name) {
          html += `<span class="badge">${taxon.iconic_taxon_name}</span>`;
        }
        html += `</div>`;
        html += `<a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" style="color: #4CAF50; font-size: 13px; text-decoration: none; margin-top: 8px; display: inline-block;">ğŸ”— Ver en iNaturalist</a>`;
        html += `</div>`;
        html += `</div>`;
      });

      html += `</div>`;
      
      if (data.total_results > 50) {
        html += `<div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px; margin-top: 15px;">
          <p style="color: #856404;">âš ï¸ Mostrando 50 de ${data.total_results} especies</p>
        </div>`;
      }
      
      document.getElementById("resultados").innerHTML = html;

    } catch (error) {
      document.getElementById("resultados").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          âŒ Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCIÃ“N: Buscar especie especÃ­fica (PestaÃ±a 2)
  // ============================================
  async function buscarEspecieINat() {
    var nombreEspecie = document.getElementById("buscadorEspecie").value.trim();
    
    if (!nombreEspecie) {
      alert("Escribe el nombre de una especie");
      return;
    }

    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "âš ï¸ Primero dibuja un Ã¡rea en el mapa O busca un paÃ­s en la PestaÃ±a 3";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    markersLayer.clearLayers();

    document.getElementById("resultadosBusqueda").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando "${nombreEspecie}" en iNaturalist...</p>
      </div>
    `;

    const soloResearch = document.getElementById("soloResearch").checked;

    try {
      // 1. Buscar el taxÃ³n
      const taxonSearch = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(nombreEspecie)}&per_page=1`);
      const taxonData = await taxonSearch.json();
      
      if (!taxonData.results || taxonData.results.length === 0) {
        throw new Error("No se encontrÃ³ la especie en iNaturalist");
      }

      const taxon = taxonData.results[0];

      // 2. Buscar observaciones en el Ã¡rea [citation:4]
      const bounds = areaSeleccionada;
      let url = `https://api.inaturalist.org/v1/observations?` +
                `taxon_id=${taxon.id}` +
                `&verifiable=${soloResearch ? 'true' : 'any'}` +
                `&per_page=100` +
                `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}` +
                `&order=desc&order_by=observed_on`;

      const response = await fetch(url);
      const data = await response.json();

      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosBusqueda").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3 style="color: #856404;">No hay observaciones</h3>
            <p>${taxon.preferred_common_name || taxon.name} no tiene citas en esta Ã¡rea</p>
          </div>
        `;
        return;
      }

      // 3. Mostrar resultados y pintar marcadores
      var html = `
        <div class="stats">
          ğŸ¯ Especie: <strong>${taxon.preferred_common_name || taxon.name}</strong><br>
          ğŸ”¬ Nombre cientÃ­fico: <em>${taxon.name}</em><br>
          ğŸ“ Total observaciones: ${data.total_results}<br>
          ğŸ“ Ãrea: ${calcularAreaKm2(bounds).toFixed(0)} kmÂ²
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      data.results.forEach(function(obs, index) {
        if (obs.geojson && obs.geojson.coordinates) {
          const [lng, lat] = obs.geojson.coordinates;
          
          // Marcador en el mapa
          var marker = L.circleMarker([lat, lng], {
            radius: 6,
            color: '#4CAF50',
            weight: 2,
            fillColor: '#81C784',
            fillOpacity: 0.8
          }).addTo(markersLayer);
          
          let popupContent = `
            <b>${obs.taxon?.preferred_common_name || obs.taxon?.name || nombreEspecie}</b><br>
            <i>${obs.taxon?.name || ''}</i><br>
            ğŸ“… ${obs.observed_on || 'Fecha desconocida'}<br>
            ğŸ‘¤ ${obs.user?.login || 'AnÃ³nimo'}<br>
            ğŸ… ${obs.quality_grade}<br>
            <a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank">ğŸ”— Ver en iNat</a>
          `;
          
          if (obs.photos && obs.photos.length > 0) {
            popupContent += `<br><img src="${obs.photos[0].url?.replace('square', 'small')}" style="max-width: 200px; border-radius: 4px; margin-top: 5px;">`;
          }
          
          marker.bindPopup(popupContent);
        }

        // Tarjeta en la lista
        html += `<div class="inat-card">`;
        
        if (obs.photos && obs.photos.length > 0) {
          html += `<img class="inat-imagen" src="${obs.photos[0].url?.replace('square', 'medium')}" alt="Foto">`;
        } else {
          html += `<div class="inat-placeholder">ğŸ“·</div>`;
        }
        
        html += `<div class="inat-info">`;
        html += `<div class="inat-titulo">ObservaciÃ³n #${index + 1}</div>`;
        html += `<div class="inat-detalle">`;
        html += `ğŸ“ ${obs.latitude?.toFixed(4)}, ${obs.longitude?.toFixed(4)}<br>`;
        html += `ğŸ“… ${obs.observed_on || 'N/A'}<br>`;
        html += `ğŸ‘¤ ${obs.user?.login || 'AnÃ³nimo'}<br>`;
        html += `<span class="badge-quality-${obs.quality_grade}">ğŸ… ${obs.quality_grade}</span>`;
        if (obs.captive) html += `<span class="badge">ğŸ¢ Cautiverio</span>`;
        html += `</div>`;
        html += `<a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank" style="color: #4CAF50;">ğŸ”— Ver detalle</a>`;
        html += `</div>`;
        html += `</div>`;
      });

      html += `</div>`;
      document.getElementById("resultadosBusqueda").innerHTML = html;

      if (markersLayer.getLayers().length > 0) {
        map.fitBounds(markersLayer.getBounds().pad(0.1));
      }

    } catch (error) {
      document.getElementById("resultadosBusqueda").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          âŒ Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCIÃ“N: Buscar zona en iNaturalist (PestaÃ±a 3)
  // ============================================
  async function buscarZonaINat() {
    var query = document.getElementById("buscadorPais").value.trim();
    
    if (!query) {
      alert("Escribe el nombre de un paÃ­s o zona");
      return;
    }

    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando "${query}" en OpenStreetMap...</p>
      </div>
    `;

    zoneLayer.clearLayers();
    drawnItems.clearLayers();
    markersLayer.clearLayers();

    try {
      const lugar = await geocodificarLugar(query);
      
      if (!lugar) {
        document.getElementById("resultadosPais").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3 style="color: #856404;">No se encontrÃ³ "${query}"</h3>
          </div>
        `;
        return;
      }

      // Dibujar zona
      areaSeleccionada = lugar.bounds;
      
      L.rectangle(lugar.bounds, {
        color: "#8B4513",
        weight: 3,
        fillColor: "#8B4513",
        fillOpacity: 0.05,
        dashArray: "5, 5"
      }).addTo(zoneLayer);
      
      L.marker([lugar.lat, lugar.lon], {
        icon: L.divIcon({ html: 'ğŸ“', className: 'custom-div-icon', iconSize: [30, 30] })
      }).bindPopup(lugar.nombre).addTo(zoneLayer);
      
      map.fitBounds(lugar.bounds.pad(0.1));
      
      document.getElementById("coords").innerHTML = 
        `ğŸ“ Zona: ${lugar.nombre}<br>` +
        `ğŸ“ Tipo: ${lugar.tipo}<br>` +
        `ğŸ“ Ãrea: ${calcularAreaKm2(lugar.bounds).toFixed(0)} kmÂ²`;

      // Consultar iNaturalist automÃ¡ticamente
      await consultarZonaINaturalist(lugar);

    } catch (error) {
      document.getElementById("resultadosPais").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          âŒ Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCIÃ“N: Consultar iNaturalist para la zona
  // ============================================
  async function consultarZonaINaturalist(lugar) {
    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando biodiversidad de ${lugar.nombre} en iNaturalist...</p>
      </div>
    `;

    const soloResearch = document.getElementById("soloResearch").checked;
    const grupoSeleccionado = document.getElementById("grupo").value;

    try {
      const data = await consultarINaturalistPorBounds(lugar.bounds, grupoSeleccionado || null, soloResearch);
      
      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosPais").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px;">ğŸ”</p>
            <h3 style="color: #856404;">No se encontraron especies</h3>
            <p>Prueba con otro grupo o zona</p>
          </div>
        `;
        return;
      }

      var html = `
        <div class="stats">
          ğŸ—ºï¸ <strong>${lugar.nombre}</strong><br>
          ğŸ¦‹ Especies: ${data.total_results}<br>
          ğŸ“¸ Grado investigaciÃ³n: ${soloResearch ? 'SÃ­' : 'No'}<br>
          ğŸ”¬ Grupo: ${grupoSeleccionado || 'Todos'}
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      data.results.slice(0, 50).forEach(function(item) {
        const taxon = item.taxon;
        html += `<div class="inat-card">`;
        
        if (taxon.default_photo) {
          html += `<img class="inat-imagen" src="${taxon.default_photo.medium_url || taxon.default_photo.url}" alt="${taxon.name}">`;
        } else {
          html += `<div class="inat-placeholder">ğŸ“·</div>`;
        }
        
        html += `<div class="inat-info">`;
        html += `<div class="inat-titulo">${taxon.name}</div>`;
        html += `<div class="inat-comun">${taxon.preferred_common_name || 'Nombre comÃºn no disponible'}</div>`;
        html += `<div class="inat-detalle">`;
        html += `<span class="badge">ğŸ“Š ${item.count} obs</span>`;
        html += `<span class="badge">${taxon.rank}</span>`;
        html += `</div>`;
        html += `<a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" style="color: #4CAF50;">ğŸ”— Ver en iNaturalist</a>`;
        html += `</div>`;
        html += `</div>`;
      });

      html += `</div>`;
      
      document.getElementById("resultadosPais").innerHTML = html;
      document.getElementById("resultados").innerHTML = html; // TambiÃ©n en pestaÃ±a 1

    } catch (error) {
      document.getElementById("resultadosPais").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24;">
          âŒ Error: ${error.message}
        </div>
      `;
    }
  }

  // ============================================
  // FUNCIÃ“N: Cargar paÃ­s preseleccionado
  // ============================================
  function cargarPaisPreseleccionado() {
    var pais = document.getElementById("paisPreseleccionado").value;
    if (pais) {
      document.getElementById("buscadorPais").value = pais;
      buscarZonaINat();
    }
  }

  // ============================================
  // Autocompletado y eventos
  // ============================================
  document.getElementById("buscadorPais")?.addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) return;
    
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
        { headers: { 'User-Agent': 'iNatExplorer/1.0' } }
      );
      const sugerencias = await response.json();
      
      let html = '<div class="pais-sugerencia">';
      sugerencias.forEach(s => {
        html += `<div class="pais-sugerencia-item" onclick="document.getElementById('buscadorPais').value = '${s.display_name.replace(/'/g, "\\'")}'; document.getElementById('sugerenciasPais').innerHTML = ''; buscarZonaINat();">`;
        html += `${s.display_name} (${s.type})`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasPais").innerHTML = html;
    } catch (error) {
      console.error("Error en autocompletado:", error);
    }
  });

  // Cerrar sugerencias
  document.addEventListener("click", function(e) {
    if (!e.target.closest('#buscadorPais') && !e.target.closest('.pais-sugerencia')) {
      document.getElementById("sugerenciasPais").innerHTML = '';
    }
  });

  // Enter para buscar
  document.getElementById("buscadorPais")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscarZonaINat();
  });
  
  document.getElementById("buscadorEspecie")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscarEspecieINat();
  });

  // ============================================
  // INICIALIZACIÃ“N
  // ============================================
  window.onload = function() {
    console.log("iNaturalist Explorer iniciado");
    // Ejemplo: cargar EspaÃ±a automÃ¡ticamente?
    setTimeout(() => {
      document.getElementById("buscadorPais").value = "EspaÃ±a";
      buscarZonaINat();
    }, 500);
  };

</script>

</body>
</html>
