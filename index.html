<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
    }

    button, select {
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      white-space: pre-wrap;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h1>Explorador de Biodiversidad</h1>

<div id="map"></div>

<button onclick="obtenerArea()">Obtener coordenadas</button>
<button onclick="consultarGBIF()">Consultar animales en esta √°rea</button>

<label for="grupo">Selecciona grupo:</label>
<select id="grupo">
  <option value="">Todos</option>
  <option value="212">Aves (classKey 212)</option>
  <option value="359">Mam√≠feros (classKey 359)</option>
  <option value="358">Reptiles (classKey 358)</option>
  <option value="131">Anfibios (classKey 131)</option> <!-- Corregido: c√≥digo correcto para anfibios -->
  <option value="203">Peces √≥seos (classKey 203)</option> <!-- Corregido: Actinopterygii -->
  <option value="216">Insectos (classKey 216)</option>
</select>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>Coordenadas:</h3>
<pre id="coords"></pre>

<h3>Especies encontradas:</h3>
<pre id="resultados"></pre>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet Draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // Crear mapa
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Grupo para dibujar √°reas
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: false, polyline: false, circle: false, marker: false, circlemarker: false, rectangle: true }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rect√°ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers(); // solo un √°rea a la vez
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    
    // Limpiar mensaje de ayuda
    document.getElementById("mensajeAyuda").style.display = "none";
  });

  // Mostrar coordenadas del √°rea
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    var north = bounds.getNorth();
    var south = bounds.getSouth();
    var east = bounds.getEast();
    var west = bounds.getWest();

    document.getElementById("coords").textContent =
      "North: " + north.toFixed(4) + "\n" +
      "South: " + south.toFixed(4) + "\n" +
      "East: " + east.toFixed(4) + "\n" +
      "West: " + west.toFixed(4);
  }

  // Funci√≥n para verificar si hay datos en el √°rea
  async function verificarDatosEnArea(bounds) {
    var url = "https://api.gbif.org/v1/occurrence/search?" +
              "hasCoordinate=true" +
              "&limit=1" +
              "&decimalLatitude=" + bounds.getSouth() + "," + bounds.getNorth() +
              "&decimalLongitude=" + bounds.getWest() + "," + bounds.getEast();
    
    try {
      var response = await fetch(url);
      var data = await response.json();
      return data.count > 0;
    } catch (error) {
      return false;
    }
  }

  // Consultar GBIF con l√≠mite aumentado
  async function consultarGBIF() {
    document.getElementById("resultados").textContent = "Consultando GBIF...";
    document.getElementById("mensajeAyuda").style.display = "none";

    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    var north = bounds.getNorth();
    var south = bounds.getSouth();
    var east = bounds.getEast();
    var west = bounds.getWest();

    // Verificar que el √°rea no sea demasiado grande
    var areaAproximada = (north - south) * (east - west) * 111 * 111; // √Årea aproximada en km¬≤
    if (areaAproximada > 100000) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "‚ö†Ô∏è El √°rea seleccionada es muy grande (" + Math.round(areaAproximada) + " km¬≤). " +
        "Prueba a seleccionar un √°rea m√°s peque√±a para obtener mejores resultados.";
      document.getElementById("mensajeAyuda").style.display = "block";
    }

    var claseSeleccionada = document.getElementById("grupo").value;

    // Construir URL con mejores par√°metros
    var url = "https://api.gbif.org/v1/occurrence/search?" +
              "hasCoordinate=true" +
              "&hasGeospatialIssue=false" + // Evitar registros con problemas
              "&limit=1000" +
              "&kingdomKey=1"; // Animalia

    if (claseSeleccionada) {
      url += "&classKey=" + claseSeleccionada;
    }

    url += "&decimalLatitude=" + south + "," + north +
           "&decimalLongitude=" + west + "," + east;

    console.log("Consultando URL:", url);

    try {
      var response = await fetch(url);
      
      if (!response.ok) {
        throw new Error("Error HTTP: " + response.status);
      }
      
      var data = await response.json();

      var especies = new Set();

      if (data.results && data.results.length > 0) {
        data.results.forEach(function(r) {
          if (r.species && r.species.trim() !== '') {
            especies.add(r.species + " (" + (r.vernacularName || "Nombre com√∫n no disponible") + ")");
          } else if (r.vernacularName) {
            especies.add(r.vernacularName + " (nombre com√∫n)");
          }
        });
      }

      if (especies.size === 0) {
        // Intentar consulta sin filtro de clase para ver si hay datos en general
        var hayDatos = await verificarDatosEnArea(bounds);
        
        var mensaje = "No se encontraron especies para ";
        mensaje += claseSeleccionada ? "este grupo" : "ning√∫n grupo";
        mensaje += " en el √°rea seleccionada.\n\n";
        
        if (!hayDatos) {
          mensaje += "‚ö†Ô∏è No se encontraron registros de GBIF en esta √°rea.\n";
          mensaje += "Prueba a:\n";
          mensaje += "‚Ä¢ Seleccionar un √°rea m√°s grande\n";
          mensaje += "‚Ä¢ Dibujar un rect√°ngulo sobre tierra firme\n";
          mensaje += "‚Ä¢ Probar con otra regi√≥n con m√°s biodiversidad\n";
        } else {
          mensaje += "Hay registros en el √°rea, pero no de este grupo taxon√≥mico.\n";
          mensaje += "Prueba con otro grupo o elimina el filtro.";
        }
        
        document.getElementById("resultados").textContent = mensaje;
        return;
      }

      var texto = "";
      var listaEspecies = Array.from(especies).sort();
      listaEspecies.forEach(function(e) {
        texto += "‚Ä¢ " + e + "\n";
      });

      document.getElementById("resultados").textContent =
        "‚úÖ Total especies √∫nicas: " + especies.size + "\n" +
        "üìä Total registros encontrados: " + (data.count || data.results.length) + "\n\n" +
        texto;

    } catch (error) {
      document.getElementById("resultados").textContent = 
        "‚ùå Error al consultar GBIF.\n" +
        "Aseg√∫rate de tener conexi√≥n a internet y que el √°rea seleccionada sea v√°lida.\n" +
        "Detalles: " + error.message;
      console.error("Error completo:", error);
    }
  }

  // Verificar que los c√≥digos de clase son correctos al cargar la p√°gina
  window.onload = function() {
    console.log("C√≥digos de clase GBIF:");
    console.log("Aves (212): https://www.gbif.org/species/212");
    console.log("Mam√≠feros (359): https://www.gbif.org/species/359");
    console.log("Reptiles (358): https://www.gbif.org/species/358");
    console.log("Anfibios (131): https://www.gbif.org/species/131");
    console.log("Peces √≥seos (203): https://www.gbif.org/species/203");
    console.log("Insectos (216): https://www.gbif.org/species/216");
  };

</script>

</body>
</html>
