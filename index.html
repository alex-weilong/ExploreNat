<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Explorador de Biodiversidad</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f0f7f0;
    }

    h1 {
      color: #2c5e2e;
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.5em;
    }

    /* Layout principal */
    .main-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    /* Columna izquierda: Mapa */
    .map-container {
      flex: 1;
      min-width: 0; /* Para evitar desbordamiento */
    }

    #map {
      height: 600px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 3px solid #4CAF50;
      position: relative;
    }

    /* Columna derecha: Resultados */
    .results-container {
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .results-container .resultados-seccion {
      margin-top: 0;
    }

    .results-container .resultados-container {
      max-height: 500px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    button, select, input {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
    }

    button:hover {
      background-color: #388E3C;
    }

    .button-blue {
      background-color: #2196F3;
    }

    .button-orange {
      background-color: #ff9800;
    }

    select, input {
      background-color: white;
      border: 2px solid #e0e0e0;
    }

    input {
      cursor: text;
      min-width: 300px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .inat-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #4CAF50;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      background-color: #f5f5f5;
    }

    .inat-card.selected {
      background-color: #e8f5e9;
      border-left: 4px solid #4CAF50;
    }

    .inat-imagen {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 12px;
      border: 2px solid #4CAF50;
    }

    .inat-placeholder {
      width: 60px;
      height: 60px;
      background: #e8f5e9;
      margin-right: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 24px;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .badge {
      background: #e8f5e9;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 11px;
      color: #2e7d32;
      display: inline-block;
      margin-right: 4px;
      margin-top: 4px;
    }

    .loading {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: #e8f5e9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: bold;
      font-size: 13px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      padding: 10px;
    }

    .pagination button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .sugerencias-taxon-container,
    .sugerencias-pais-container {
      position: absolute;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      width: 400px;
      z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .sugerencia-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sugerencia-item:hover {
      background-color: #e8f5e9;
    }

    .sugerencia-item .taxon-info {
      flex: 1;
    }

    .sugerencia-item .taxon-name {
      font-weight: bold;
      color: #2e7d32;
      font-size: 13px;
    }

    .sugerencia-item .taxon-rank {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    .enlace-inat {
      color: #4CAF50;
      text-decoration: none;
      font-size: 11px;
      margin-left: 8px;
    }

    .enlace-inat:hover {
      text-decoration: underline;
    }

    .progreso-carga {
      text-align: center;
      padding: 20px;
      color: #2e7d32;
      font-weight: bold;
    }

    .seleccion-area {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #4CAF50;
    }

    .seleccion-area-titulo {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .buscador-pais-container {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
    }

    .buscador-pais-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      font-size: 14px;
    }

    .buscador-pais-input:focus {
      outline: none;
      border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }

    .info-area {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #4CAF50;
    }

    .info-area p {
      margin: 5px 0;
      color: #666;
    }

    .info-area strong {
      color: #2e7d32;
    }

    .buscador-taxon-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #4CAF50;
    }

    .buscador-taxon-titulo {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    .buscador-taxon-input-container {
      display: flex;
      gap: 10px;
      position: relative;
    }

    .buscador-taxon-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      font-size: 14px;
    }

    .buscador-taxon-input:focus {
      outline: none;
      border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }

    .resultados-seccion {
      margin-top: 20px;
    }

    .resultados-seccion-titulo {
      font-size: 1.2em;
      color: #2e7d32;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .fenologia-container {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .fenologia-barra {
      display: flex;
      gap: 2px;
      height: 16px;
      flex: 1;
      max-width: 150px;
    }

    .fenologia-mes {
      flex: 1;
      height: 100%;
      border-radius: 2px;
      transition: all 0.2s;
      position: relative;
    }

    .fenologia-mes:hover {
      transform: scaleY(1.2);
      cursor: help;
    }

    .fenologia-leyenda {
      display: flex;
      gap: 20px;
      font-size: 11px;
      color: #666;
      margin-top: 5px;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }

    .fenologia-leyenda-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .fenologia-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .fenologia-estacion {
      display: flex;
      gap: 5px;
      align-items: center;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
    }

    .estacion-icono {
      font-size: 12px;
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 100px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 4px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -50px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 10px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .habitats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .habitat-badge {
      background: #e0f2e0;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 11px;
      color: #1b5e20;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      border: 1px solid #a5d6a5;
    }

    .habitat-icon {
      font-size: 12px;
    }

    .habitat-principal {
      background: #c8e6c9;
      font-weight: bold;
      border: 2px solid #4CAF50;
    }

    .clima-info {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .clima-item {
      display: flex;
      align-items: center;
      gap: 3px;
      background: #f5f5f5;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 11px;
    }

    .cargando-mensaje {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }

    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      border-left: 4px solid #4CAF50;
      max-width: 200px;
      font-size: 11px;
    }

    .legend-title {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-color.exacta { background: #4CAF50; }
    .legend-color.oculta { background: #FF9800; }
    .legend-color.privada { background: #9C27B0; }
    .legend-color.metodo { background: #2196F3; }
  </style>
</head>
<body>

<h1>üåø ExploreNat</h1>

<div class="controls">
  <button onclick="limpiarMapa()">üóëÔ∏è Limpiar √°rea</button>
  <button onclick="limpiarMarcadores()" class="button-orange">üóëÔ∏è Limpiar marcadores</button>
  
  <label>
    <input type="checkbox" id="soloResearch" checked> Solo grado investigaci√≥n
  </label>
</div>

<!-- PASO 1: SELECCI√ìN DE √ÅREA -->
<div class="seleccion-area">
  <div class="seleccion-area-titulo">üìç PASO 1: Selecciona un √°rea</div>
  
  <div style="position: relative;">
    <div class="buscador-pais-container">
      <input type="text" id="buscadorPais" class="buscador-pais-input" 
             placeholder="Buscar por pa√≠s, parque, ciudad... (ej: Espa√±a, Do√±ana, Madrid)" autocomplete="off">
      <button onclick="buscarZona()" class="button-blue">Buscar zona</button>
    </div>
    <div id="sugerenciasPais" style="position: relative;"></div>
  </div>
  
  <div class="info-area" id="infoArea">
    <p><strong>üìç √Årea seleccionada:</strong> Ninguna. Dibuja un rect√°ngulo o busca un pa√≠s.</p>
  </div>
</div>

<!-- BUSCADOR DE TAXONES -->
<div class="buscador-taxon-container">
  <div class="buscador-taxon-titulo">üîç Filtrar por tax√≥n (opcional)</div>
  <div style="position: relative;">
    <div class="buscador-taxon-input-container">
      <input type="text" id="buscadorTaxon" class="buscador-taxon-input" 
             placeholder="Ej: Lynx pardinus, Reptilia, Aves, Canis, Fabaceae..." autocomplete="off">
      <button onclick="buscarTaxon()" class="button-blue">Filtrar</button>
    </div>
    <div id="sugerenciasTaxon" style="position: relative;"></div>
  </div>
</div>

<!-- LAYOUT PRINCIPAL: MAPA + LISTA DE ESPECIES -->
<div class="main-container">
  <!-- Columna izquierda: Mapa -->
  <div class="map-container">
    <div id="map"></div>
  </div>
  
  <!-- Columna derecha: Resultados -->
  <div class="results-container">
    <!-- Leyenda de fenolog√≠a -->
    <div class="fenologia-leyenda">
      <div class="fenologia-leyenda-item">
        <div class="fenologia-color" style="background: #f0f0f0;"></div>
        <span>Sin datos</span>
      </div>
      <div class="fenologia-leyenda-item">
        <div class="fenologia-color" style="background: #c8e6c9;"></div>
        <span>Pocas obs</span>
      </div>
      <div class="fenologia-leyenda-item">
        <div class="fenologia-color" style="background: #4caf50;"></div>
        <span>Muchas obs</span>
      </div>
    </div>
    
    <!-- Resultados de todas las especies -->
    <div class="resultados-seccion" id="todasEspeciesSeccion">
      <div class="resultados-seccion-titulo">üåç Todas las especies del √°rea</div>
      <div id="infoCarga" style="display: none;" class="progreso-carga"></div>
      <div id="resultados" class="resultados-container">
        <div class="cargando-mensaje">Selecciona un √°rea para ver las especies</div>
      </div>
      <div id="paginacion" class="pagination"></div>
    </div>
    
    <!-- Resultados de b√∫squeda por tax√≥n -->
    <div class="resultados-seccion" id="resultadosTaxonSeccion" style="display: none;">
      <div class="resultados-seccion-titulo" id="resultadosTaxonTitulo">üîç Resultados filtrados</div>
      <div id="resultadosBusquedaTaxon" class="resultados-container"></div>
      <div id="paginacionTaxon" class="pagination"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // VARIABLES GLOBALES
  // ============================================
  let map;
  let drawnItems;
  let markersLayer;
  let zoneLayer;
  let areaSeleccionada = null;
  
  let totalEspeciesGlobal = 0;
  let paginaActual = 1;
  const especiesPorPagina = 20;
  let cargandoPagina = false;
  
  let taxonActual = null;
  let totalEspeciesTaxon = 0;
  let paginaActualTaxon = 1;

  const cacheFenologia = {};

  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const estaciones = [
    { nombre: 'Invierno', meses: [0,1,11], icono: '‚ùÑÔ∏è', color: '#2196f3' },
    { nombre: 'Primavera', meses: [2,3,4], icono: 'üå∏', color: '#4caf50' },
    { nombre: 'Verano', meses: [5,6,7], icono: '‚òÄÔ∏è', color: '#ff9800' },
    { nombre: 'Oto√±o', meses: [8,9,10], icono: 'üçÇ', color: '#8b4513' }
  ];

  // ============================================
  // FUNCIONES DE UBICACI√ìN
  // ============================================
  
  function getLocationType(obs) {
    if (!obs.geojson || !obs.geojson.coordinates) return null;
    
    if (obs.geoprivacy === 'private' || obs.geoprivacy === 'obscured') {
      return 'oculta';
    }
    
    if (obs.public_positional_accuracy === 0) {
      return 'exacta';
    }
    
    if (obs.positional_accuracy) {
      if (obs.positional_accuracy < 100) return 'exacta';
      if (obs.positional_accuracy < 1000) return 'metodo';
      return 'oculta';
    }
    
    if (obs.private_positional_accuracy) {
      return 'privada';
    }
    
    return 'metodo';
  }

  function getMarkerColor(locationType) {
    switch(locationType) {
      case 'exacta': return '#4CAF50';
      case 'oculta': return '#FF9800';
      case 'privada': return '#9C27B0';
      case 'metodo': return '#2196F3';
      default: return '#4CAF50';
    }
  }

  function crearLeyendaMapa() {
    const legend = L.control({ position: 'bottomright' });
    
    legend.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'map-legend');
      div.innerHTML = `
        <div class="legend-title">üìç Tipos de ubicaci√≥n</div>
        <div class="legend-item">
          <div class="legend-color exacta"></div>
          <span>Exacta (sin error)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color oculta"></div>
          <span>Oculta / Privada</span>
        </div>
        <div class="legend-item">
          <div class="legend-color metodo"></div>
          <span>Precisi√≥n &lt; 1km</span>
        </div>
        <div class="legend-item">
          <div class="legend-color privada"></div>
          <span>Precisi√≥n &gt; 1km</span>
        </div>
      `;
      return div;
    };
    
    legend.addTo(map);
  }

  // ============================================
  // INICIALIZACI√ìN
  // ============================================
  window.onload = function() {
    console.log("Iniciando ExploreNat...");
    
    map = L.map('map').setView([40.4168, -3.7038], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    drawnItems = L.featureGroup().addTo(map);
    markersLayer = L.featureGroup().addTo(map);
    zoneLayer = L.featureGroup().addTo(map);

    crearLeyendaMapa();

    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { 
        polygon: false, 
        polyline: false, 
        circle: false, 
        marker: false, 
        circlemarker: false, 
        rectangle: true 
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function(e) {
      var layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      areaSeleccionada = layer.getBounds();
      document.getElementById("mensajeAyuda").style.display = "none";
      
      actualizarInfoArea();
      cargarPrimeraPagina();
    });

    console.log("‚úÖ Mapa cargado correctamente");
  };

  // ============================================
  // FUNCI√ìN PARA ANALIZAR H√ÅBITATS
  // ============================================
  
  function identificarHabitats(lat, lon) {
    const habitats = [];
    
    if (lat > 35 && lat < 70 && lon > -10 && lon < 40) {
      habitats.push({ tipo: 'Bosque templado', icono: 'üå≥', principal: true });
      if (lat < 45) habitats.push({ tipo: 'Mediterr√°neo', icono: 'üåø', principal: false });
      if (lat > 55) habitats.push({ tipo: 'Taiga', icono: 'üå≤', principal: false });
    }
    
    if (lat > -30 && lat < 30 && lon > -120 && lon < -35) {
      habitats.push({ tipo: 'Selva tropical', icono: 'üå¥', principal: true });
      habitats.push({ tipo: 'Bosque nuboso', icono: '‚òÅÔ∏è', principal: false });
    }
    
    if ((lat > 15 && lat < 30 && lon > -20 && lon < 50) ||
        (lat > 30 && lat < 40 && lon > -120 && lon < -110)) {
      habitats.push({ tipo: 'Desierto', icono: 'üèúÔ∏è', principal: true });
      habitats.push({ tipo: 'Matorral xer√≥filo', icono: 'üåµ', principal: false });
    }
    
    if (habitats.length === 0) {
      habitats.push({ tipo: 'Zona de estudio', icono: 'üî¨', principal: true });
    }
    
    return habitats;
  }

  function obtenerClimaAproximado(lat) {
    if (Math.abs(lat) < 23.5) return { nombre: 'Tropical', icono: '‚òÄÔ∏è', temp: '25-30¬∞C' };
    if (Math.abs(lat) < 35) return { nombre: 'Subtropical', icono: 'üå§Ô∏è', temp: '15-25¬∞C' };
    if (Math.abs(lat) < 50) return { nombre: 'Templado', icono: '‚õÖ', temp: '10-20¬∞C' };
    if (Math.abs(lat) < 60) return { nombre: 'Continental', icono: 'üå°Ô∏è', temp: '5-15¬∞C' };
    return { nombre: 'Sub√°rtico', icono: '‚ùÑÔ∏è', temp: '-5-5¬∞C' };
  }

  async function analizarHabitats(bounds) {
    const centro = bounds.getCenter();
    const lat = centro.lat;
    const lon = centro.lng;
    
    const habitats = identificarHabitats(lat, lon);
    const clima = obtenerClimaAproximado(lat);
    
    try {
      const url = `https://api.inaturalist.org/v1/observations/species_counts?` +
                  `verifiable=true` +
                  `&per_page=5` +
                  `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      const especiesCaracteristicas = data.results ? data.results.map(r => r.taxon.name) : [];
      
      return {
        habitats: habitats,
        clima: clima,
        especiesCaracteristicas: especiesCaracteristicas
      };
    } catch (error) {
      console.error("Error analizando h√°bitats:", error);
      return {
        habitats: habitats,
        clima: clima,
        especiesCaracteristicas: []
      };
    }
  }

  async function actualizarInfoArea() {
    if (!areaSeleccionada) {
      document.getElementById("infoArea").innerHTML = `
        <p><strong>üìç √Årea seleccionada:</strong> Ninguna. Dibuja un rect√°ngulo o busca un pa√≠s.</p>
      `;
      return;
    }
    
    const infoArea = document.getElementById("infoArea");
    infoArea.innerHTML = '<p><strong>üìç Analizando h√°bitats...</strong></p>';
    
    const bounds = areaSeleccionada;
    const centro = bounds.getCenter();
    const area = (bounds.getNorth() - bounds.getSouth()) * 
                 (bounds.getEast() - bounds.getWest()) * 111 * 111;
    
    const infoHabitats = await analizarHabitats(bounds);
    
    let html = `
      <p><strong>üìç √Årea seleccionada</strong></p>
      <p style="font-size: 12px; color: #666;">
        Centro: ${centro.lat.toFixed(4)}¬∞, ${centro.lng.toFixed(4)}¬∞<br>
        Extensi√≥n: ${area.toFixed(0)} km¬≤
      </p>
      
      <p><strong>üåç Clima</strong></p>
      <div class="clima-info">
        <div class="clima-item">
          <span>${infoHabitats.clima.icono}</span>
          <span>${infoHabitats.clima.nombre}</span>
        </div>
        <div class="clima-item">
          <span>üå°Ô∏è</span>
          <span>${infoHabitats.clima.temp}</span>
        </div>
      </div>
      
      <p><strong>üèûÔ∏è H√°bitats</strong></p>
      <div class="habitats-container">
    `;
    
    infoHabitats.habitats.forEach(h => {
      html += `<span class="habitat-badge ${h.principal ? 'habitat-principal' : ''}">
                <span class="habitat-icon">${h.icono}</span>
                ${h.tipo}
               </span>`;
    });
    
    html += `</div>`;
    
    if (infoHabitats.especiesCaracteristicas.length > 0) {
      html += `<p><strong>üåø Especies caracter√≠sticas</strong></p>`;
      html += `<div style="font-size: 11px; color: #666;">`;
      infoHabitats.especiesCaracteristicas.slice(0, 3).forEach(esp => {
        html += `‚Ä¢ ${esp}<br>`;
      });
      html += `</div>`;
    }
    
    const biomas = [
      { nombre: 'Bosque mediterr√°neo', condicion: () => centro.lat > 35 && centro.lat < 45 && centro.lng > -10 && centro.lng < 40 },
      { nombre: 'Selva amaz√≥nica', condicion: () => centro.lat > -15 && centro.lat < 5 && centro.lng > -80 && centro.lng < -50 },
      { nombre: 'Bosque atl√°ntico', condicion: () => centro.lat > 40 && centro.lat < 60 && centro.lng > -10 && centro.lng < 10 },
      { nombre: 'Desierto del Sahara', condicion: () => centro.lat > 15 && centro.lat < 30 && centro.lng > -15 && centro.lng < 35 },
      { nombre: 'Gran Cuenca', condicion: () => centro.lat > 35 && centro.lat < 45 && centro.lng > -120 && centro.lng < -110 }
    ];
    
    const biomaEncontrado = biomas.find(b => b.condicion());
    if (biomaEncontrado) {
      html += `<p><strong>üó∫Ô∏è Bioma:</strong> ${biomaEncontrado.nombre}</p>`;
    }
    
    infoArea.innerHTML = html;
  }

  // ============================================
  // FUNCIONES B√ÅSICAS
  // ============================================
  
  function limpiarMapa() {
    if (drawnItems) drawnItems.clearLayers();
    if (markersLayer) markersLayer.clearLayers();
    if (zoneLayer) zoneLayer.clearLayers();
    areaSeleccionada = null;
    taxonActual = null;
    
    document.getElementById("infoArea").innerHTML = `
      <p><strong>üìç √Årea seleccionada:</strong> Ninguna. Dibuja un rect√°ngulo o busca un pa√≠s.</p>
    `;
    
    document.getElementById("resultados").innerHTML = '<div class="cargando-mensaje">Selecciona un √°rea para ver las especies</div>';
    document.getElementById("resultadosBusquedaTaxon").innerHTML = "";
    document.getElementById("resultadosTaxonSeccion").style.display = "none";
    document.getElementById("todasEspeciesSeccion").style.display = "block";
    document.getElementById("mensajeAyuda").style.display = "none";
    document.getElementById("paginacion").innerHTML = "";
    document.getElementById("paginacionTaxon").innerHTML = "";
    
    totalEspeciesGlobal = 0;
    paginaActual = 1;
    totalEspeciesTaxon = 0;
    paginaActualTaxon = 1;
    
    for (let key in cacheFenologia) {
      delete cacheFenologia[key];
    }
  }

  function limpiarMarcadores() {
    if (markersLayer) markersLayer.clearLayers();
    document.querySelectorAll('.inat-card').forEach(card => {
      card.classList.remove('selected');
    });
  }

  // ============================================
  // FUNCIONES DE CARGA POR P√ÅGINAS
  // ============================================
  
  async function cargarPrimeraPagina() {
    if (!areaSeleccionada) return;
    
    document.getElementById("resultados").innerHTML = '<div class="cargando-mensaje">Cargando especies...</div>';
    document.getElementById("paginacion").innerHTML = '';
    
    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;
    
    try {
      const urlTotal = `https://api.inaturalist.org/v1/observations/species_counts?` +
                       `verifiable=${soloResearch}` +
                       `&per_page=1` +
                       `&swlat=${bounds.getSouth()}` +
                       `&swlng=${bounds.getWest()}` +
                       `&nelat=${bounds.getNorth()}` +
                       `&nelng=${bounds.getEast()}`;

      const responseTotal = await fetch(urlTotal);
      const dataTotal = await responseTotal.json();
      
      if (!dataTotal.total_results || dataTotal.total_results === 0) {
        document.getElementById("resultados").innerHTML = "No se encontraron especies en esta √°rea";
        return;
      }

      totalEspeciesGlobal = dataTotal.total_results;
      await cargarPagina(1);
      
    } catch (error) {
      document.getElementById("resultados").innerHTML = `Error: ${error.message}`;
    }
  }

  async function cargarPagina(pagina) {
    if (!areaSeleccionada || cargandoPagina) return;
    
    cargandoPagina = true;
    paginaActual = pagina;
    
    document.getElementById("resultados").innerHTML = '<div class="cargando-mensaje">Cargando p√°gina...</div>';
    
    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;
    
    try {
      const url = `https://api.inaturalist.org/v1/observations/species_counts?` +
                  `verifiable=${soloResearch}` +
                  `&per_page=${especiesPorPagina}` +
                  `&page=${pagina}` +
                  `&swlat=${bounds.getSouth()}` +
                  `&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}` +
                  `&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) {
        document.getElementById("resultados").innerHTML = "No hay especies en esta p√°gina";
        cargandoPagina = false;
        return;
      }

      await mostrarPagina(data.results);
      actualizarBotonesPaginacion();
      
    } catch (error) {
      document.getElementById("resultados").innerHTML = `Error: ${error.message}`;
    } finally {
      cargandoPagina = false;
    }
  }

  async function mostrarPagina(especiesPagina) {
    let html = `<div class="stats">üìä Total especies: ${totalEspeciesGlobal} (p√°gina ${paginaActual})</div>`;

    for (let i = 0; i < especiesPagina.length; i++) {
      const item = especiesPagina[i];
      const taxon = item.taxon;
      
      if (!cacheFenologia[taxon.id]) {
        cacheFenologia[taxon.id] = await obtenerFenologia(taxon.id);
      }
      const fenologia = cacheFenologia[taxon.id];
      
      html += `<div class="inat-card" onclick="mostrarCitasEspecie(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', this)">`;
      
      if (taxon.default_photo && taxon.default_photo.medium_url) {
        html += `<img class="inat-imagen" src="${taxon.default_photo.medium_url}" alt="${taxon.name}">`;
      } else {
        html += `<div class="inat-placeholder">üì∑</div>`;
      }
      
      html += `<div class="inat-info">`;
      html += `<div class="inat-titulo">${taxon.name} 
               <a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" class="enlace-inat" onclick="event.stopPropagation()">üîó iNat</a>
               </div>`;
      html += `<div style="font-size: 11px;">${taxon.preferred_common_name || ''}</div>`;
      html += `<span class="badge">üìä ${item.count} obs</span>`;
      if (taxon.iconic_taxon_name) {
        html += `<span class="badge">${taxon.iconic_taxon_name}</span>`;
      }
      
      html += crearBarraFenologia(fenologia);
      
      html += `</div></div>`;
    }

    document.getElementById("resultados").innerHTML = html;
  }

  function actualizarBotonesPaginacion() {
    const totalPaginas = Math.ceil(totalEspeciesGlobal / especiesPorPagina);
    if (totalPaginas <= 1) {
      document.getElementById("paginacion").innerHTML = '';
      return;
    }

    let html = '<div class="pagination">';
    
    html += `<button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>‚óÄ Anterior</button>`;
    
    for (let i = 1; i <= totalPaginas; i++) {
      if (i === 1 || i === totalPaginas || (i >= paginaActual - 2 && i <= paginaActual + 2)) {
        html += `<button onclick="cambiarPagina(${i})" class="${i === paginaActual ? 'active' : ''}">${i}</button>`;
      } else if (i === paginaActual - 3 || i === paginaActual + 3) {
        html += `<button disabled>...</button>`;
      }
    }
    
    html += `<button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? 'disabled' : ''}>Siguiente ‚ñ∂</button>`;
    html += '</div>';
    
    document.getElementById("paginacion").innerHTML = html;
  }

  function cambiarPagina(nuevaPagina) {
    const totalPaginas = Math.ceil(totalEspeciesGlobal / especiesPorPagina);
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas && !cargandoPagina) {
      cargarPagina(nuevaPagina);
    }
  }

  // ============================================
  // FUNCI√ìN PARA OBTENER FENOLOG√çA
  // ============================================
  
  async function obtenerFenologia(taxonId) {
    if (!areaSeleccionada) return null;
    
    if (cacheFenologia[taxonId]) {
      return cacheFenologia[taxonId];
    }
    
    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;
    
    try {
      const url = `https://api.inaturalist.org/v1/observations?` +
                  `taxon_id=${taxonId}` +
                  `&verifiable=${soloResearch}` +
                  `&per_page=100` +
                  `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) return null;
      
      const conteoMeses = new Array(12).fill(0);
      
      data.results.forEach(obs => {
        if (obs.observed_on) {
          const fecha = new Date(obs.observed_on);
          const mes = fecha.getMonth();
          conteoMeses[mes]++;
        }
      });
      
      const max = Math.max(...conteoMeses);
      const normalizado = conteoMeses.map(val => max > 0 ? val / max : 0);
      
      const mejorEstacion = calcularMejorEstacion(conteoMeses);
      
      const fenologia = {
        conteo: conteoMeses,
        normalizado: normalizado,
        total: data.results.length,
        mejorEstacion: mejorEstacion
      };
      
      cacheFenologia[taxonId] = fenologia;
      return fenologia;
      
    } catch (error) {
      console.error("Error obteniendo fenolog√≠a:", error);
      return null;
    }
  }

  function calcularMejorEstacion(conteoMeses) {
    const sumaEstaciones = estaciones.map(est => 
      est.meses.reduce((sum, mes) => sum + conteoMeses[mes], 0)
    );
    
    const maxSum = Math.max(...sumaEstaciones);
    const mejorIndex = sumaEstaciones.indexOf(maxSum);
    
    return {
      ...estaciones[mejorIndex],
      total: maxSum
    };
  }

  function crearBarraFenologia(fenologia) {
    if (!fenologia) return '<div class="fenologia-estacion">üìä Sin datos</div>';
    
    let html = '<div class="fenologia-container">';
    
    html += '<div class="fenologia-barra">';
    for (let i = 0; i < 12; i++) {
      const intensidad = fenologia.normalizado[i];
      const color = intensidad === 0 ? '#f0f0f0' : 
                   intensidad < 0.3 ? '#c8e6c9' :
                   intensidad < 0.6 ? '#81c784' : '#4caf50';
      
      html += `<div class="fenologia-mes tooltip" style="background: ${color}; flex: 1;">
                <span class="tooltiptext">${meses[i]}: ${fenologia.conteo[i]} obs</span>
              </div>`;
    }
    html += '</div>';
    
    html += `<div class="fenologia-estacion">
              <span class="estacion-icono">${fenologia.mejorEstacion.icono}</span>
              <span>${fenologia.mejorEstacion.nombre}</span>
            </div>`;
    
    html += '</div>';
    
    return html;
  }

  // ============================================
  // BUSCADOR DE PA√çSES / ZONAS
  // ============================================
  
  document.getElementById("buscadorPais").addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) {
      document.getElementById("sugerenciasPais").innerHTML = '';
      return;
    }
    
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const sugerencias = await response.json();
      
      if (sugerencias.length === 0) return;
      
      let html = '<div class="sugerencias-pais-container">';
      sugerencias.forEach(s => {
        html += `<div class="sugerencia-item" onclick="seleccionarZona('${s.display_name.replace(/'/g, "\\'")}', ${s.boundingbox[0]}, ${s.boundingbox[1]}, ${s.boundingbox[2]}, ${s.boundingbox[3]}, ${s.lat}, ${s.lon})">`;
        html += `<div style="font-size: 14px;">üìç</div>`;
        html += `<div class="taxon-info">`;
        html += `<div class="taxon-name">${s.display_name}</div>`;
        html += `<div class="taxon-rank">${s.type || 'lugar'}</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasPais").innerHTML = html;
    } catch (error) {
      console.error("Error:", error);
    }
  });

  window.seleccionarZona = function(nombre, south, north, west, east, lat, lon) {
    document.getElementById("buscadorPais").value = nombre;
    document.getElementById("sugerenciasPais").innerHTML = '';
    
    const bounds = L.latLngBounds([parseFloat(south), parseFloat(west)], [parseFloat(north), parseFloat(east)]);
    
    zoneLayer.clearLayers();
    L.rectangle(bounds, { color: "#4CAF50", weight: 3, fillOpacity: 0.1 }).addTo(zoneLayer);
    L.marker([parseFloat(lat), parseFloat(lon)]).addTo(zoneLayer).bindPopup(nombre).openPopup();
    
    map.fitBounds(bounds.pad(0.1));
    areaSeleccionada = bounds;
    
    actualizarInfoArea();
    cargarPrimeraPagina();
  };

  async function buscarZona() {
    const query = document.getElementById("buscadorPais").value.trim();
    if (!query) return alert("Escribe un lugar");

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const data = await response.json();
      
      if (!data.length) {
        document.getElementById("mensajeAyuda").innerHTML = "Lugar no encontrado";
        document.getElementById("mensajeAyuda").className = "warning";
        document.getElementById("mensajeAyuda").style.display = "block";
        return;
      }

      const lugar = data[0];
      seleccionarZona(lugar.display_name, lugar.boundingbox[0], lugar.boundingbox[1], 
                     lugar.boundingbox[2], lugar.boundingbox[3], lugar.lat, lugar.lon);

    } catch (error) {
      document.getElementById("mensajeAyuda").innerHTML = `Error: ${error.message}`;
      document.getElementById("mensajeAyuda").className = "warning";
      document.getElementById("mensajeAyuda").style.display = "block";
    }
  }

  // ============================================
  // FUNCI√ìN PARA MOSTRAR CITAS
  // ============================================
  
 // ============================================
// FUNCI√ìN PARA MOSTRAR CITAS (CORREGIDA)
// ============================================

async function mostrarCitasEspecie(taxonId, taxonNombre, elemento) {
  if (!areaSeleccionada) {
    alert("Primero dibuja un √°rea en el mapa");
    return;
  }

  markersLayer.clearLayers();
  document.querySelectorAll('.inat-card').forEach(card => {
    card.classList.remove('selected');
  });

  if (elemento) {
    elemento.classList.add('selected');
  }

  const soloResearch = document.getElementById("soloResearch").checked;
  const bounds = areaSeleccionada;

  try {
    // Mostrar mensaje de carga
    document.getElementById("mensajeAyuda").innerHTML = `Cargando citas de ${taxonNombre}...`;
    document.getElementById("mensajeAyuda").className = "warning";
    document.getElementById("mensajeAyuda").style.display = "block";

    // Primero obtener el total de observaciones
    const urlTotal = `https://api.inaturalist.org/v1/observations?` +
                     `taxon_id=${taxonId}` +
                     `&verifiable=${soloResearch}` +
                     `&per_page=1` +
                     `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                     `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;

    const responseTotal = await fetch(urlTotal);
    const dataTotal = await responseTotal.json();
    
    if (!dataTotal.total_results || dataTotal.total_results === 0) {
      document.getElementById("mensajeAyuda").innerHTML = `No hay citas de ${taxonNombre} en esta √°rea`;
      document.getElementById("mensajeAyuda").className = "warning";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    const totalCitas = dataTotal.total_results;
    
    // Calcular cu√°ntas p√°ginas necesitamos (m√°ximo 100 por p√°gina)
    const citasPorPagina = 100;
    const totalPaginas = Math.ceil(totalCitas / citasPorPagina);
    
    let todasLasCitas = [];
    
    // Cargar todas las p√°ginas
    for (let pagina = 1; pagina <= totalPaginas; pagina++) {
      document.getElementById("mensajeAyuda").innerHTML = 
        `Cargando citas de ${taxonNombre}... P√°gina ${pagina} de ${totalPaginas}`;
      
      const url = `https://api.inaturalist.org/v1/observations?` +
                  `taxon_id=${taxonId}` +
                  `&verifiable=${soloResearch}` +
                  `&per_page=${citasPorPagina}` +
                  `&page=${pagina}` +
                  `&swlat=${bounds.getSouth()}&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        todasLasCitas = [...todasLasCitas, ...data.results];
      }
    }

    if (todasLasCitas.length === 0) {
      document.getElementById("mensajeAyuda").innerHTML = `No se pudieron cargar las citas de ${taxonNombre}`;
      document.getElementById("mensajeAyuda").className = "warning";
      document.getElementById("mensajeAyuda").style.display = "block";
      return;
    }

    // Contadores por tipo de ubicaci√≥n
    let exactas = 0, ocultas = 0, privadas = 0, metodo = 0;

    // Mostrar todas las citas en el mapa
    todasLasCitas.forEach(obs => {
      if (obs.geojson && obs.geojson.coordinates) {
        const [lng, lat] = obs.geojson.coordinates;
        const locationType = getLocationType(obs);
        const color = getMarkerColor(locationType);
        
        if (locationType === 'exacta') exactas++;
        else if (locationType === 'oculta') ocultas++;
        else if (locationType === 'privada') privadas++;
        else if (locationType === 'metodo') metodo++;
        
        let precisionText = '';
        if (obs.positional_accuracy) {
          precisionText = `Precisi√≥n: ${obs.positional_accuracy}m`;
        } else if (obs.public_positional_accuracy) {
          precisionText = `Precisi√≥n: ${obs.public_positional_accuracy}m`;
        } else if (obs.geoprivacy) {
          precisionText = `Privacidad: ${obs.geoprivacy}`;
        } else {
          precisionText = 'Ubicaci√≥n exacta';
        }
        
        L.circleMarker([lat, lng], {
          radius: 6,
          color: color,
          weight: 2,
          fillColor: color,
          fillOpacity: 0.8
        }).addTo(markersLayer).bindPopup(`
          <b>${taxonNombre}</b><br>
          üìÖ ${obs.observed_on || 'Fecha desconocida'}<br>
          üë§ ${obs.user?.login || 'An√≥nimo'}<br>
          üèÖ ${obs.quality_grade}<br>
          üìç Tipo: ${locationType}<br>
          ${precisionText}<br>
          <a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank">üîó Ver en iNaturalist</a>
        `);
      }
    });

    // Ajustar el mapa para mostrar todos los puntos
    if (markersLayer.getLayers().length > 0) {
      map.fitBounds(markersLayer.getBounds().pad(0.1));
    }

    // Mostrar estad√≠sticas
    document.getElementById("mensajeAyuda").innerHTML = 
      `üìç Mostrando ${todasLasCitas.length} citas de ${taxonNombre}<br>` +
      `üü¢ Exactas: ${exactas} | üü† Ocultas: ${ocultas} | üü£ Privadas: ${privadas} | üîµ M. precisi√≥n: ${metodo}`;
    document.getElementById("mensajeAyuda").className = "success";
    document.getElementById("mensajeAyuda").style.display = "block";

  } catch (error) {
    console.error("Error:", error);
    document.getElementById("mensajeAyuda").innerHTML = `Error al cargar las citas: ${error.message}`;
    document.getElementById("mensajeAyuda").className = "warning";
    document.getElementById("mensajeAyuda").style.display = "block";
  }
}
  // ============================================
  // BUSCADOR DE TAXONES
  // ============================================
  
  document.getElementById("buscadorTaxon").addEventListener("input", async function(e) {
    const query = e.target.value.trim();
    if (query.length < 3) {
      document.getElementById("sugerenciasTaxon").innerHTML = '';
      return;
    }
    
    try {
      const response = await fetch(
        `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(query)}&per_page=8&all_names=true`,
        { headers: { 'User-Agent': 'ExploreNat/1.0' } }
      );
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) return;
      
      let html = '<div class="sugerencias-taxon-container">';
      data.results.forEach(taxon => {
        const nombreComun = taxon.preferred_common_name || '';
        const nombreCientifico = taxon.name;
        const rango = taxon.rank?.toLowerCase() || 'tax√≥n';
        
        let icono = 'üî¨';
        if (rango === 'species') icono = 'ü¶ã';
        else if (rango === 'genus') icono = 'üåø';
        else if (rango === 'family') icono = 'üå≥';
        else if (rango === 'order') icono = 'üìã';
        else if (rango === 'class') icono = 'üìä';
        
        html += `<div class="sugerencia-item" onclick="seleccionarTaxon(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', '${rango}')">`;
        html += `<div style="font-size: 18px; min-width: 30px;">${icono}</div>`;
        html += `<div class="taxon-info">`;
        html += `<div class="taxon-name">${nombreCientifico}</div>`;
        html += `<div class="taxon-rank">${rango} ${nombreComun ? '‚Ä¢ ' + nombreComun : ''}</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      html += '</div>';
      
      document.getElementById("sugerenciasTaxon").innerHTML = html;
    } catch (error) {
      console.error("Error:", error);
    }
  });

  window.seleccionarTaxon = function(taxonId, taxonNombre, rango) {
    document.getElementById("buscadorTaxon").value = taxonNombre;
    document.getElementById("sugerenciasTaxon").innerHTML = '';
    buscarTaxonPorId(taxonId, taxonNombre, rango);
  };

  async function buscarTaxon() {
    const nombre = document.getElementById("buscadorTaxon").value.trim();
    if (!nombre) return alert("Escribe el nombre de un tax√≥n");
    if (!areaSeleccionada) {
      alert("Primero selecciona un √°rea en el mapa");
      return;
    }

    try {
      const taxonRes = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(nombre)}&per_page=1`);
      const taxonData = await taxonRes.json();
      
      if (!taxonData.results || taxonData.results.length === 0) {
        document.getElementById("resultadosBusquedaTaxon").innerHTML = "Tax√≥n no encontrado";
        return;
      }

      const taxon = taxonData.results[0];
      await buscarTaxonPorId(taxon.id, taxon.name, taxon.rank);

    } catch (error) {
      document.getElementById("resultadosBusquedaTaxon").innerHTML = `Error: ${error.message}`;
    }
  }

  async function buscarTaxonPorId(taxonId, taxonNombre, rango) {
    if (!areaSeleccionada) {
      alert("Primero selecciona un √°rea en el mapa");
      return;
    }

    document.getElementById("todasEspeciesSeccion").style.display = "none";
    document.getElementById("resultadosTaxonSeccion").style.display = "block";
    document.getElementById("resultadosTaxonTitulo").innerHTML = `üîç Resultados para: ${taxonNombre} (${rango})`;
    document.getElementById("resultadosBusquedaTaxon").innerHTML = '<div class="cargando-mensaje">Buscando especies...</div>';
    document.getElementById("paginacionTaxon").innerHTML = '';

    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;

    try {
      const urlTotal = `https://api.inaturalist.org/v1/observations/species_counts?` +
                       `verifiable=${soloResearch}` +
                       `&taxon_id=${taxonId}` +
                       `&per_page=1` +
                       `&swlat=${bounds.getSouth()}` +
                       `&swlng=${bounds.getWest()}` +
                       `&nelat=${bounds.getNorth()}` +
                       `&nelng=${bounds.getEast()}`;

      const responseTotal = await fetch(urlTotal);
      const dataTotal = await responseTotal.json();

      if (!dataTotal.total_results || dataTotal.total_results === 0) {
        document.getElementById("resultadosBusquedaTaxon").innerHTML = 
          `<div class="warning">No se encontraron especies de ${taxonNombre} en esta √°rea</div>`;
        return;
      }

      totalEspeciesTaxon = dataTotal.total_results;
      taxonActual = { id: taxonId, nombre: taxonNombre, rango: rango };
      
      await cargarPaginaTaxon(1);

    } catch (error) {
      document.getElementById("resultadosBusquedaTaxon").innerHTML = `Error: ${error.message}`;
    }
  }

  async function cargarPaginaTaxon(pagina) {
    if (!areaSeleccionada || !taxonActual) return;
    
    paginaActualTaxon = pagina;
    
    document.getElementById("resultadosBusquedaTaxon").innerHTML = '<div class="cargando-mensaje">Cargando p√°gina...</div>';
    
    const soloResearch = document.getElementById("soloResearch").checked;
    const bounds = areaSeleccionada;
    
    try {
      const url = `https://api.inaturalist.org/v1/observations/species_counts?` +
                  `verifiable=${soloResearch}` +
                  `&taxon_id=${taxonActual.id}` +
                  `&per_page=${especiesPorPagina}` +
                  `&page=${pagina}` +
                  `&swlat=${bounds.getSouth()}` +
                  `&swlng=${bounds.getWest()}` +
                  `&nelat=${bounds.getNorth()}` +
                  `&nelng=${bounds.getEast()}`;

      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.results || data.results.length === 0) {
        document.getElementById("resultadosBusquedaTaxon").innerHTML = "No hay especies en esta p√°gina";
        return;
      }

      await mostrarPaginaTaxon(data.results);
      actualizarBotonesPaginacionTaxon();

    } catch (error) {
      document.getElementById("resultadosBusquedaTaxon").innerHTML = `Error: ${error.message}`;
    }
  }

  async function mostrarPaginaTaxon(especiesPagina) {
    let html = `<div class="stats">üìä Total especies: ${totalEspeciesTaxon} (p√°gina ${paginaActualTaxon})</div>`;

    for (let i = 0; i < especiesPagina.length; i++) {
      const item = especiesPagina[i];
      const taxon = item.taxon;
      
      if (!cacheFenologia[taxon.id]) {
        cacheFenologia[taxon.id] = await obtenerFenologia(taxon.id);
      }
      const fenologia = cacheFenologia[taxon.id];
      
      html += `<div class="inat-card" onclick="mostrarCitasEspecie(${taxon.id}, '${taxon.name.replace(/'/g, "\\'")}', this)">`;
      
      if (taxon.default_photo && taxon.default_photo.medium_url) {
        html += `<img class="inat-imagen" src="${taxon.default_photo.medium_url}" alt="${taxon.name}">`;
      } else {
        html += `<div class="inat-placeholder">üì∑</div>`;
      }
      
      html += `<div class="inat-info">`;
      html += `<div class="inat-titulo">${taxon.name} 
               <a href="https://www.inaturalist.org/taxa/${taxon.id}" target="_blank" class="enlace-inat" onclick="event.stopPropagation()">üîó iNat</a>
               </div>`;
      html += `<div style="font-size: 11px;">${taxon.preferred_common_name || ''}</div>`;
      html += `<span class="badge">üìä ${item.count} obs</span>`;
      if (taxon.iconic_taxon_name) {
        html += `<span class="badge">${taxon.iconic_taxon_name}</span>`;
      }
      
      html += crearBarraFenologia(fenologia);
      
      html += `</div></div>`;
    }

    document.getElementById("resultadosBusquedaTaxon").innerHTML = html;
  }

  function actualizarBotonesPaginacionTaxon() {
    const totalPaginas = Math.ceil(totalEspeciesTaxon / especiesPorPagina);
    if (totalPaginas <= 1) {
      document.getElementById("paginacionTaxon").innerHTML = '';
      return;
    }

    let html = '<div class="pagination">';
    
    html += `<button onclick="cambiarPaginaTaxon(${paginaActualTaxon - 1})" ${paginaActualTaxon === 1 ? 'disabled' : ''}>‚óÄ Anterior</button>`;
    
    for (let i = 1; i <= totalPaginas; i++) {
      if (i === 1 || i === totalPaginas || (i >= paginaActualTaxon - 2 && i <= paginaActualTaxon + 2)) {
        html += `<button onclick="cambiarPaginaTaxon(${i})" class="${i === paginaActualTaxon ? 'active' : ''}">${i}</button>`;
      } else if (i === paginaActualTaxon - 3 || i === paginaActualTaxon + 3) {
        html += `<button disabled>...</button>`;
      }
    }
    
    html += `<button onclick="cambiarPaginaTaxon(${paginaActualTaxon + 1})" ${paginaActualTaxon === totalPaginas ? 'disabled' : ''}>Siguiente ‚ñ∂</button>`;
    html += '</div>';
    
    document.getElementById("paginacionTaxon").innerHTML = html;
  }

  function cambiarPaginaTaxon(nuevaPagina) {
    const totalPaginas = Math.ceil(totalEspeciesTaxon / especiesPorPagina);
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
      cargarPaginaTaxon(nuevaPagina);
    }
  }

  // ============================================
  // EVENTOS COMUNES
  // ============================================
  
  document.getElementById("buscadorTaxon").addEventListener("keypress", e => {
    if (e.key === "Enter") buscarTaxon();
  });

  document.getElementById("buscadorPais").addEventListener("keypress", e => {
    if (e.key === "Enter") buscarZona();
  });

  document.addEventListener("click", function(e) {
    if (!e.target.closest('#buscadorTaxon') && !e.target.closest('.sugerencias-taxon-container')) {
      document.getElementById("sugerenciasTaxon").innerHTML = '';
    }
    if (!e.target.closest('#buscadorPais') && !e.target.closest('.sugerencias-pais-container')) {
      document.getElementById("sugerenciasPais").innerHTML = '';
    }
  });

</script>

</body>
</html>
