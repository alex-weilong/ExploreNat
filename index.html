<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Biodiversidad con Fotos</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #2c5e2e;
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }

    button, select {
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #2c5e2e;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1e4320;
    }

    select {
      background-color: white;
      border: 1px solid #ccc;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .especie-card {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .especie-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .especie-imagen {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 15px;
      border: 2px solid #eaeaea;
    }

    .especie-placeholder {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
      margin-right: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 12px;
      text-align: center;
      border: 2px dashed #ccc;
    }

    .especie-info {
      flex: 1;
    }

    .especie-nombre {
      font-weight: bold;
      color: #2c5e2e;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .especie-comun {
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .especie-enlace {
      color: #0066cc;
      font-size: 12px;
      text-decoration: none;
    }

    .especie-enlace:hover {
      text-decoration: underline;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2c5e2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>üåø ExploreNat - Explorador de Biodiversidad con Fotos</h1>

<div class="controls">
  <button onclick="obtenerArea()">üìç Obtener coordenadas</button>
  <button onclick="consultarGBIF()">üîç Consultar animales en esta √°rea</button>
  
  <label for="grupo">Selecciona grupo:</label>
  <select id="grupo">
    <option value="">üåç Todos</option>
    <option value="212">ü¶Ö Aves</option>
    <option value="359">üêª Mam√≠feros</option>
    <option value="358">ü¶é Reptiles</option>
    <option value="131">üê∏ Anfibios</option>
    <option value="203">üêü Peces √≥seos</option>
    <option value="216">ü¶ã Insectos</option>
  </select>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>üìê Coordenadas del √°rea:</h3>
<pre id="coords">Dibuja un rect√°ngulo en el mapa y haz clic en "Obtener coordenadas"</pre>

<h3>üì∏ Especies encontradas con fotos:</h3>
<div id="resultados">
  <p style="color: #666; text-align: center; padding: 40px;">
    üåç Selecciona un √°rea en el mapa y haz clic en "Consultar animales en esta √°rea"
  </p>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACI√ìN DEL MAPA
  // ============================================
  var map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Configuraci√≥n de √°reas dibujables
  var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
      polygon: false, 
      polyline: false, 
      circle: false, 
      marker: false, 
      circlemarker: false, 
      rectangle: true 
    }
  });
  map.addControl(drawControl);

  var areaSeleccionada = null;

  // Guardar el rect√°ngulo dibujado
  map.on(L.Draw.Event.CREATED, function(e) {
    var layer = e.layer;
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    areaSeleccionada = layer.getBounds();
    document.getElementById("mensajeAyuda").style.display = "none";
    // Mostrar coordenadas autom√°ticamente
    obtenerArea();
  });

  // ============================================
  // FUNCI√ìN: Mostrar coordenadas
  // ============================================
  function obtenerArea() {
    var bounds = areaSeleccionada ? areaSeleccionada : map.getBounds();
    document.getElementById("coords").innerHTML = 
      `üìç Norte: ${bounds.getNorth().toFixed(4)}¬∞<br>` +
      `üìç Sur: ${bounds.getSouth().toFixed(4)}¬∞<br>` +
      `üìç Este: ${bounds.getEast().toFixed(4)}¬∞<br>` +
      `üìç Oeste: ${bounds.getWest().toFixed(4)}¬∞<br>` +
      `üìè √Årea aproximada: ${calcularAreaKm2(bounds).toFixed(0)} km¬≤`;
  }

  // ============================================
  // FUNCI√ìN: Calcular √°rea aproximada
  // ============================================
  function calcularAreaKm2(bounds) {
    var R = 6371; // Radio de la Tierra en km
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    
    return ancho * alto;
  }

  // ============================================
  // FUNCI√ìN: Obtener imagen de una especie
  // ============================================
  async function obtenerImagenEspecie(nombreEspecie) {
    try {
      // Buscar ocurrencias de esta especie con im√°genes
      const url = `https://api.gbif.org/v1/occurrence/search?species=${encodeURIComponent(nombreEspecie)}&media_type=StillImage&limit=5&hasCoordinate=true`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        // Buscar la primera ocurrencia con imagen v√°lida
        for (let ocurrencia of data.results) {
          if (ocurrencia.media && ocurrencia.media.length > 0) {
            const imagen = ocurrencia.media.find(m => 
              m.type === 'StillImage' && 
              m.identifier && 
              !m.identifier.includes('map') &&
              !m.identifier.includes('thumbnail')
            );
            
            if (imagen && imagen.identifier) {
              // Intentar diferentes formatos de URL
              let urlImagen = imagen.identifier;
              
              // Si es una URL de iNaturalist, usar el tama√±o mediano
              if (urlImagen.includes('inaturalist')) {
                urlImagen = urlImagen.replace('/square', '/medium');
                urlImagen = urlImagen.replace('/original', '/medium');
              }
              
              // Si es de GBIF, intentar redimensionar
              if (urlImagen.includes('gbif.org')) {
                urlImagen = urlImagen + '?w=200&h=200';
              }
              
              return {
                url: urlImagen,
                speciesKey: ocurrencia.speciesKey, // CORREGIDO: Ahora usa speciesKey
                licencia: ocurrencia.license || 'CC BY-NC'
              };
            }
          }
        }
      }
      return null;
    } catch (error) {
      console.error(`Error obteniendo imagen para ${nombreEspecie}:`, error);
      return null;
    }
  }

  // ============================================
  // FUNCI√ìN PRINCIPAL: Consultar GBIF
  // ============================================
  async function consultarGBIF() {
    // Mostrar estado de carga
    document.getElementById("resultados").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Consultando GBIF y buscando fotos...</p>
      </div>
    `;
    document.getElementById("mensajeAyuda").style.display = "none";

    // Validar √°rea
    if (!areaSeleccionada) {
      document.getElementById("mensajeAyuda").innerHTML = 
        "‚ö†Ô∏è Por favor, dibuja un rect√°ngulo en el mapa antes de consultar.";
      document.getElementById("mensajeAyuda").style.display = "block";
      document.getElementById("resultados").innerHTML = 
        '<p style="color: #856404; text-align: center;">üìç Dibuja un √°rea en el mapa para comenzar</p>';
      return;
    }

    var bounds = areaSeleccionada;
    var claseSeleccionada = document.getElementById("grupo").value;

    // Verificar tama√±o del √°rea
    var areaKm2 = calcularAreaKm2(bounds);
    if (areaKm2 > 100000) {
      document.getElementById("mensajeAyuda").innerHTML = 
        `‚ö†Ô∏è El √°rea seleccionada es muy grande (${areaKm2.toFixed(0)} km¬≤).<br>
        Los resultados pueden tardar o ser limitados. Prueba con un √°rea m√°s peque√±a.`;
      document.getElementById("mensajeAyuda").style.display = "block";
    }

    try {
      // ========================================
      // CONSULTA 1: Obtener especies del √°rea
      // ========================================
      var url = "https://api.gbif.org/v1/occurrence/search?" +
                "hasCoordinate=true" +
                "&hasGeospatialIssue=false" +
                "&limit=300" +
                "&kingdomKey=1";

      if (claseSeleccionada) {
        url += "&classKey=" + claseSeleccionada;
      }

      url += "&decimalLatitude=" + bounds.getSouth() + "," + bounds.getNorth() +
             "&decimalLongitude=" + bounds.getWest() + "," + bounds.getEast();

      console.log("Consultando GBIF:", url);
      
      var response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`Error HTTP: ${response.status}`);
      }
      
      var data = await response.json();

      // ========================================
      // Procesar especies √∫nicas
      // ========================================
      var especiesMap = new Map();

      if (data.results && data.results.length > 0) {
        data.results.forEach(function(r) {
          if (r.species && r.species.trim() !== '') {
            if (!especiesMap.has(r.species)) {
              especiesMap.set(r.species, {
                nombre: r.species,
                nombreComun: r.vernacularName || "Nombre com√∫n no disponible",
                reino: r.kingdom || "Animalia",
                filo: r.phylum || "No disponible",
                clase: r.class || "No disponible",
                orden: r.order || "No disponible",
                familia: r.family || "No disponible",
                speciesKey: r.speciesKey || null, // CORREGIDO: Guardamos speciesKey desde el principio
                imagen: null,
                licencia: null
              });
            }
          }
        });
      }

      // ========================================
      // Verificar si hay resultados
      // ========================================
      if (especiesMap.size === 0) {
        document.getElementById("resultados").innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 48px; margin-bottom: 20px;">üîç</p>
            <h3 style="color: #856404;">No se encontraron especies</h3>
            <p style="color: #666;">
              No hay registros de ${claseSeleccionada ? 'este grupo' : 'animales'} en esta √°rea.<br><br>
              Prueba a:
            </p>
            <ul style="color: #666; text-align: left; display: inline-block;">
              <li>Seleccionar un √°rea m√°s grande</li>
              <li>Elegir otro grupo taxon√≥mico</li>
              <li>Dibujar sobre tierra firme</li>
              <li>Probar en una regi√≥n con m√°s biodiversidad</li>
            </ul>
          </div>
        `;
        return;
      }

      // ========================================
      // CONSULTA 2: Buscar fotos para las especies
      // ========================================
      var especiesArray = Array.from(especiesMap.values());
      var totalEspecies = especiesArray.length;
      var especiesConImagen = 0;
      
      // Actualizar UI con progreso
      document.getElementById("resultados").innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div class="loading"></div>
          <p style="margin-top: 20px; color: #666;">
            Buscando fotos para ${totalEspecies} especies...<br>
            <span style="font-size: 14px;">(Esto puede tomar unos segundos)</span>
          </p>
        </div>
      `;

      // Buscar im√°genes para las primeras 20 especies
      var especiesProcesar = especiesArray.slice(0, 20);
      
      for (let i = 0; i < especiesProcesar.length; i++) {
        let especie = especiesProcesar[i];
        let imagenInfo = await obtenerImagenEspecie(especie.nombre);
        
        if (imagenInfo) {
          especie.imagen = imagenInfo.url;
          especie.licencia = imagenInfo.licencia;
          // Si no ten√≠amos speciesKey, lo obtenemos de la b√∫squeda de imagen
          if (!especie.speciesKey) {
            especie.speciesKey = imagenInfo.speciesKey;
          }
          especiesConImagen++;
        }
        
        // Actualizar progreso cada 5 especies
        if ((i + 1) % 5 === 0 || i === especiesProcesar.length - 1) {
          document.getElementById("resultados").innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div class="loading"></div>
              <p style="margin-top: 20px; color: #666;">
                Buscando fotos: ${i + 1}/${especiesProcesar.length} especies<br>
                <span style="font-size: 14px;">Encontradas: ${especiesConImagen} fotos</span>
              </p>
            </div>
          `;
        }
        
        // Peque√±a pausa para no saturar la API
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // ========================================
      // MOSTRAR RESULTADOS
      // ========================================
      var html = `
        <div class="stats">
          üìä Total especies √∫nicas: ${totalEspecies}<br>
          üì∏ Especies con foto: ${especiesConImagen}/${Math.min(20, totalEspecies)} mostradas<br>
          üî¨ Grupo: ${document.getElementById("grupo").selectedOptions[0].text || 'Todos'}<br>
          üìè √Årea: ${areaKm2.toFixed(0)} km¬≤
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
      `;

      // Mostrar especies procesadas
      especiesProcesar.forEach(function(especie) {
        html += `<div class="especie-card">`;
        
        if (especie.imagen) {
          html += `<img class="especie-imagen" src="${especie.imagen}" 
                    alt="${especie.nombre}" 
                    onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML += '&lt;div class=\\'especie-placeholder\\'&gt;üì∑&lt;br&gt;Error&lt;/div&gt;';">`;
        } else {
          html += `<div class="especie-placeholder">üì∑<br>Sin foto</div>`;
        }
        
        html += `<div class="especie-info">`;
        html += `<div class="especie-nombre">${especie.nombre}</div>`;
        html += `<div class="especie-comun">${especie.nombreComun}</div>`;
        html += `<div style="font-size: 12px; color: #999; margin-top: 5px;">`;
        html += `üìå ${especie.familia} ‚Ä¢ ${especie.orden}`;
        
        // CORREGIDO: Ahora enlaza a la p√°gina de la especie, no a una ocurrencia
        if (especie.speciesKey) {
          html += `<br><a class="especie-enlace" 
                    href="https://www.gbif.org/species/${especie.speciesKey}" 
                    target="_blank">üîó Ver ficha de la especie en GBIF</a>`;
          
          if (especie.licencia) {
            html += ` ‚Ä¢ <span style="color: #666;">${especie.licencia}</span>`;
          }
        } else {
          // Fallback: b√∫squeda por nombre si no tenemos speciesKey
          html += `<br><a class="especie-enlace" 
                    href="https://www.gbif.org/search?q=${encodeURIComponent(especie.nombre)}" 
                    target="_blank">üîó Buscar en GBIF</a>`;
        }
        
        html += `</div>`;
        html += `</div>`; // Cierra especie-info
        html += `</div>`; // Cierra especie-card
      });

      // Si hay m√°s especies de las que mostramos
      if (totalEspecies > 20) {
        html += `<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px;">
          <p style="color: #666; margin: 0;">
            ‚ö†Ô∏è Mostrando 20 de ${totalEspecies} especies<br>
            <small>Acota m√°s el √°rea para ver todas las especies</small>
          </p>
        </div>`;
      }

      html += `</div>`; // Cierra el contenedor scrollable
      
      document.getElementById("resultados").innerHTML = html;

    } catch (error) {
      console.error("Error completo:", error);
      document.getElementById("resultados").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #721c24; background: #f8d7da; border-radius: 8px;">
          <p style="font-size: 48px; margin-bottom: 20px;">‚ùå</p>
          <h3>Error al consultar GBIF</h3>
          <p style="margin-top: 20px;">
            ${error.message}<br><br>
            Verifica tu conexi√≥n a internet y vuelve a intentarlo.
          </p>
        </div>
      `;
    }
  }

  // ============================================
  // INICIALIZACI√ìN
  // ============================================
  window.onload = function() {
    console.log("ExploreNat iniciado con soporte de fotos y enlaces a especies");
    console.log("C√≥digos de clase GBIF verificados:");
    console.log("- Aves: 212");
    console.log("- Mam√≠feros: 359"); 
    console.log("- Reptiles: 358");
    console.log("- Anfibios: 131");
    console.log("- Peces √≥seos: 203");
    console.log("- Insectos: 216");
  };

</script>

</body>
</html>
