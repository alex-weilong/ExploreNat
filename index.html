<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ExploreNat - Explorador de Biodiversidad</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f0f7f0;
    }

    h1 {
      color: #2c5e2e;
      text-align: center;
      margin-bottom: 20px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    h1::before {
      content: "ğŸŒ¿ ";
    }

    h1::after {
      content: " ğŸŒ";
    }

    #map {
      height: 500px;
      margin-bottom: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 3px solid #4CAF50;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      border-left: 5px solid #4CAF50;
    }

    button, select, input {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    button {
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
    }

    button:hover {
      background-color: #388E3C;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .button-blue {
      background-color: #2196F3;
      box-shadow: 0 2px 5px rgba(33, 150, 243, 0.3);
    }
    .button-blue:hover {
      background-color: #1976D2;
    }

    select, input {
      background-color: white;
      border: 2px solid #e0e0e0;
    }

    select:focus, input:focus {
      border-color: #4CAF50;
      outline: none;
    }

    input {
      cursor: text;
      min-width: 300px;
    }

    pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    #resultados, #resultadosBusqueda, #resultadosPais {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #ffc107;
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #28a745;
    }

    .inat-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border: 1px solid #eaeaea;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .inat-card:hover {
      transform: translateX(5px);
      border-left: 4px solid #4CAF50;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .inat-imagen {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      margin-right: 15px;
      border: 2px solid #4CAF50;
    }

    .inat-placeholder {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      margin-right: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4CAF50;
      font-size: 30px;
      border: 2px dashed #4CAF50;
    }

    .inat-info {
      flex: 1;
    }

    .inat-titulo {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .inat-comun {
      color: #666;
      font-size: 14px;
      font-style: italic;
      margin-bottom: 8px;
    }

    .inat-detalle {
      color: #666;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .badge {
      background: #e8f5e9;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #2e7d32;
      display: inline-block;
      font-weight: 500;
    }

    .badge-quality-research {
      background: #c8e6c9;
      color: #1b5e20;
      font-weight: bold;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
    }

    .badge-quality-casual {
      background: #ffccbc;
      color: #bf360c;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
    }

    .loading {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #1b5e20;
      border-left: 4px solid #2e7d32;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background: #4CAF50;
      color: white;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .pais-sugerencia {
      position: absolute;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      width: 350px;
      z-index: 1000;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .pais-sugerencia-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .pais-sugerencia-item:hover {
      background-color: #e8f5e9;
    }

    .place-option {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #dee2e6;
      transition: all 0.3s ease;
    }

    .place-option:hover {
      background: #e8f5e9;
      border-color: #4CAF50;
      transform: translateX(5px);
    }

    .footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>

<h1>ExploreNat</h1>

<div class="controls">
  <button onclick="obtenerArea()">ğŸ“ Obtener coordenadas</button>
  <button onclick="limpiarMapa()">ğŸ—‘ï¸ Limpiar Ã¡rea</button>
  
  <label for="grupo">Filtrar por grupo:</label>
  <select id="grupo">
    <option value="">ğŸŒ Todos</option>
    <option value="Aves">ğŸ¦… Aves</option>
    <option value="Mammalia">ğŸ» MamÃ­feros</option>
    <option value="Reptilia">ğŸ¦ Reptiles</option>
    <option value="Amphibia">ğŸ¸ Anfibios</option>
    <option value="Actinopterygii">ğŸŸ Peces</option>
    <option value="Insecta">ğŸ¦‹ Insectos</option>
    <option value="Arachnida">ğŸ•·ï¸ ArÃ¡cnidos</option>
    <option value="Mollusca">ğŸŒ Moluscos</option>
    <option value="Plantae">ğŸŒ± Plantas</option>
    <option value="Fungi">ğŸ„ Hongos</option>
  </select>

  <label style="margin-left: 10px; display: flex; align-items: center;">
    <input type="checkbox" id="soloResearch" checked style="margin-right: 5px; width: auto;"> Solo grado investigaciÃ³n
  </label>
</div>

<div id="map"></div>

<div id="mensajeAyuda" class="warning" style="display: none;"></div>

<h3>ğŸ“ Coordenadas del Ã¡rea:</h3>
<pre id="coords">Dibuja un rectÃ¡ngulo en el mapa o busca un paÃ­s/ciudad</pre>

<!-- PestaÃ±as -->
<div class="tab-buttons">
  <button id="tab1Btn" class="tab-button active" onclick="cambiarTab(1)">ğŸŒ Todas las especies</button>
  <button id="tab2Btn" class="tab-button" onclick="cambiarTab(2)">ğŸ” Buscar especie</button>
  <button id="tab3Btn" class="tab-button" onclick="cambiarTab(3)">ğŸ—ºï¸ Buscar zona</button>
</div>

<!-- PestaÃ±a 1: Todas las especies -->
<div id="tab1" class="tab-content active">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="color: #2e7d32;">ğŸ“Š Especies en el Ã¡rea:</h3>
    <button onclick="consultarINaturalist()">ğŸ” Consultar especies</button>
  </div>
  <div id="resultados">
    <div style="text-align: center; padding: 40px; color: #666;">
      ğŸŒ Dibuja un Ã¡rea en el mapa o busca un paÃ­s en la PestaÃ±a 3
    </div>
  </div>
</div>

<!-- PestaÃ±a 2: Buscador de especie -->
<div id="tab2" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="buscadorEspecie" placeholder="Ej: Lynx pardinus, Aquila adalberti, Vipera latastei" style="flex: 1;">
      <button onclick="buscarEspecieINat()" class="button-blue">ğŸ” Buscar citas</button>
    </div>
    <div id="resultadosBusqueda">
      <div style="text-align: center; padding: 30px; color: #666;">
        ğŸ” Busca una especie para ver sus observaciones
      </div>
    </div>
  </div>
</div>

<!-- PestaÃ±a 3: Buscador de zona -->
<div id="tab3" class="tab-content">
  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; gap: 10px; align-items: center; position: relative;">
      <input type="text" id="buscadorPais" 
             placeholder="Ej: EspaÃ±a, DoÃ±ana, Amazonas, Madrid, Costa Rica" 
             style="flex: 1;"
             autocomplete="off">
      <button onclick="buscarZonaINat()" style="background-color: #8B4513;">ğŸ—ºï¸ Buscar zona</button>
    </div>
    <div id="sugerenciasPais" style="position: relative;"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <select id="paisPreseleccionado" style="flex: 1;">
        <option value="">ğŸŒ Selecciona un lugar...</option>
        <option value="EspaÃ±a">ğŸ‡ªğŸ‡¸ EspaÃ±a</option>
        <option value="Portugal">ğŸ‡µğŸ‡¹ Portugal</option>
        <option value="Francia">ğŸ‡«ğŸ‡· Francia</option>
        <option value="Italia">ğŸ‡®ğŸ‡¹ Italia</option>
        <option value="Costa Rica">ğŸ‡¨ğŸ‡· Costa Rica</option>
        <option value="Ecuador">ğŸ‡ªğŸ‡¨ Ecuador</option>
        <option value="Colombia">ğŸ‡¨ğŸ‡´ Colombia</option>
        <option value="PerÃº">ğŸ‡µğŸ‡ª PerÃº</option>
        <option value="Brasil">ğŸ‡§ğŸ‡· Brasil</option>
        <option value="MÃ©xico">ğŸ‡²ğŸ‡½ MÃ©xico</option>
        <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
        <option value="JapÃ³n">ğŸ‡¯ğŸ‡µ JapÃ³n</option>
        <option value="Parque Nacional DoÃ±ana">ğŸŒ¾ DoÃ±ana</option>
        <option value="Parque Nacional YasunÃ­">ğŸŒ³ YasunÃ­</option>
      </select>
      <button onclick="cargarPaisPreseleccionado()" style="background-color: #6B8E23;">ğŸ“Œ Cargar</button>
    </div>
    
    <div id="resultadosPais" style="margin-top: 20px;">
      <div style="text-align: center; padding: 30px; color: #666;">
        ğŸ—ºï¸ Busca un paÃ­s o zona para ver su biodiversidad
      </div>
    </div>
  </div>
</div>

<div class="footer">
  ğŸŒ¿ ExploreNat - Datos de iNaturalist â€¢ Observaciones de ciencia ciudadana
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // ============================================
  // CONFIGURACIÃ“N DEL MAPA
  // ============================================
  
  // Inicializar mapa asegurando que el DOM estÃ¡ cargado
  document.addEventListener('DOMContentLoaded', function() {
    iniciarMapa();
  });

  function iniciarMapa() {
    // Crear mapa centrado en EspaÃ±a
    window.map = L.map('map').setView([40.4168, -3.7038], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Capa para el Ã¡rea dibujada
    window.drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Capa para los marcadores
    window.markersLayer = new L.FeatureGroup();
    map.addLayer(markersLayer);

    // Capa para la zona buscada
    window.zoneLayer = new L.FeatureGroup();
    map.addLayer(zoneLayer);

    // Control de dibujo
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { 
        polygon: false, 
        polyline: false, 
        circle: false, 
        marker: false, 
        circlemarker: false, 
        rectangle: true 
      }
    });
    map.addControl(drawControl);

    window.areaSeleccionada = null;

    // Evento al dibujar rectÃ¡ngulo
    map.on(L.Draw.Event.CREATED, function(e) {
      var layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      areaSeleccionada = layer.getBounds();
      document.getElementById("mensajeAyuda").style.display = "none";
      obtenerArea();
    });

    console.log("âœ… Mapa de ExploreNat iniciado correctamente");
  }

  // ============================================
  // FUNCIONES AUXILIARES
  // ============================================
  
  function obtenerArea() {
    if (!window.areaSeleccionada) {
      document.getElementById("coords").innerHTML = "Primero dibuja un Ã¡rea en el mapa";
      return;
    }
    var bounds = areaSeleccionada;
    document.getElementById("coords").innerHTML = 
      `ğŸ“ Norte: ${bounds.getNorth().toFixed(4)}Â°<br>` +
      `ğŸ“ Sur: ${bounds.getSouth().toFixed(4)}Â°<br>` +
      `ğŸ“ Este: ${bounds.getEast().toFixed(4)}Â°<br>` +
      `ğŸ“ Oeste: ${bounds.getWest().toFixed(4)}Â°<br>` +
      `ğŸ“ Ãrea: ${calcularAreaKm2(bounds).toFixed(0)} kmÂ²`;
  }

  function limpiarMapa() {
    if (window.drawnItems) drawnItems.clearLayers();
    if (window.markersLayer) markersLayer.clearLayers();
    if (window.zoneLayer) zoneLayer.clearLayers();
    window.areaSeleccionada = null;
    document.getElementById("coords").innerHTML = "Dibuja un rectÃ¡ngulo en el mapa o busca un paÃ­s/ciudad";
    document.getElementById("mensajeAyuda").style.display = "none";
  }

  function calcularAreaKm2(bounds) {
    var R = 6371;
    var lat1 = bounds.getSouth() * Math.PI / 180;
    var lat2 = bounds.getNorth() * Math.PI / 180;
    var lon1 = bounds.getWest() * Math.PI / 180;
    var lon2 = bounds.getEast() * Math.PI / 180;
    var ancho = R * Math.abs(lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
    var alto = R * Math.abs(lat2 - lat1);
    return ancho * alto;
  }

  function cambiarTab(tabId) {
    document.getElementById('tab1Btn').classList.remove('active');
    document.getElementById('tab2Btn').classList.remove('active');
    document.getElementById('tab3Btn').classList.remove('active');
    document.getElementById(`tab${tabId}Btn`).classList.add('active');
    
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById('tab3').classList.remove('active');
    document.getElementById(`tab${tabId}`).classList.add('active');
  }

  // ============================================
  // PROXY PARA EVITAR CORS
  // ============================================
  
  const PROXY_URL = 'https://api.allorigins.win/raw?url=';

  async function fetchWithProxy(url) {
    try {
      // Intentar sin proxy primero
      const response = await fetch(url);
      if (response.ok) return response;
    } catch (e) {
      console.log("Usando proxy por CORS...");
    }
    
    // Usar proxy
    const proxyResponse = await fetch(PROXY_URL + encodeURIComponent(url));
    return proxyResponse;
  }

  // ============================================
  // FUNCIONES DE iNaturalist
  // ============================================
  
  async function buscarPlaceIdINaturalist(query) {
    try {
      const url = `https://api.inaturalist.org/v1/places?q=${encodeURIComponent(query)}&per_page=10`;
      const response = await fetchWithProxy(url);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        return data.results.map(place => ({
          id: place.id,
          name: place.display_name,
          type: place.place_type_name,
          bbox: place.bounding_box_geojson ? 
                [place.bounding_box_geojson.coordinates[0][1], 
                 place.bounding_box_geojson.coordinates[0][0],
                 place.bounding_box_geojson.coordinates[2][1],
                 place.bounding_box_geojson.coordinates[2][0]] :
                [place.swlat, place.swlng, place.nelat, place.nelng],
          location: [place.latitude, place.longitude],
          admin_level: place.admin_level
        }));
      }
      return [];
    } catch (error) {
      console.error("Error buscando places:", error);
      return [];
    }
  }

  async function geocodificarLugar(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
    try {
      const response = await fetch(url, { headers: { 'User-Agent': 'ExploreNat/1.0' } });
      const data = await response.json();
      if (data && data.length > 0) {
        const lugar = data[0];
        let bounds = null;
        if (lugar.boundingbox) {
          bounds = L.latLngBounds(
            [parseFloat(lugar.boundingbox[0]), parseFloat(lugar.boundingbox[2])],
            [parseFloat(lugar.boundingbox[1]), parseFloat(lugar.boundingbox[3])]
          );
        }
        return {
          nombre: lugar.display_name,
          bounds: bounds,
          lat: parseFloat(lugar.lat),
          lon: parseFloat(lugar.lon),
          tipo: lugar.type
        };
      }
      return null;
    } catch (error) {
      console.error('Error geocodificando:', error);
      return null;
    }
  }

  // ============================================
  // FUNCIÃ“N PRINCIPAL: Buscar zona
  // ============================================
  
  async function buscarZonaINat() {
    var query = document.getElementById("buscadorPais").value.trim();
    
    if (!query) {
      alert("Escribe el nombre de un paÃ­s o zona");
      return;
    }

    document.getElementById("resultadosPais").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #666;">Buscando "${query}" en iNaturalist...</p>
      </div>
    `;

    if (window.zoneLayer) zoneLayer.clearLayers();
    if (window.drawnItems) drawnItems.clearLayers();
    if (window.markersLayer) markersLayer.clearLayers();

    try {
      const places = await buscarPlaceIdINaturalist(query);
      
      let lugar;
      let bounds;
      
      if (places.length > 0) {
        if (places.length > 1) {
          mostrarSelectorPlaces(places);
          return;
        }
        
        const place = places[0];
        lugar = {
          nombre: place.name,
          place_id: place.id,
          lat: place.location[0],
          lon: place.location[1],
          tipo: place.type,
          admin_level: place.admin_level
        };
        
        bounds = L.latLngBounds(
          [place.bbox[0], place.bbox[1]],
          [place.bbox[2], place.bbox[3]]
        );
        
        mostrarMensaje(`âœ… Usando lÃ­mites de iNaturalist: ${place.name}`, "success");
      } else {
        mostrarMensaje("âš ï¸ Usando lÃ­mites aproximados de OpenStreetMap", "warning");
        
        const os